# AIレビューフロー

人間に承認を求める前に、AIレビュー（Skills優先、MCPフォールバック）を実行する。

## 設定確認

`docs/aidlc.toml` の `[rules.mcp_review]` セクションを読み、`mode` の値を確認:

- `mode = "required"`: AIレビュー必須（AIレビューツールが両方利用不可の場合、ユーザー承認により例外的に人間レビューへ移行可能。承認は履歴に記録する）
- `mode = "recommend"`: AIレビュー推奨（スキップ可能、デフォルト）
- `mode = "disabled"`: AIレビューを行わない（AIレビューをスキップし、直接人間レビューへ進む）

## ai_tools設定

`docs/aidlc.toml` の `[rules.mcp_review]` セクションから `ai_tools` を読み取る。

**設定形式**:

```toml
[rules.mcp_review]
mode = "required"
ai_tools = ["codex", "claude", "gemini"]  # 優先順位順
```

- `ai_tools`: AIレビューに使用するツールの優先順位リスト（配列）
- デフォルト: `["codex"]`（未設定時）

**有効なツール名**:

| ツール名 | Skills呼び出し | MCPフォールバック |
|----------|----------------|-------------------|
| codex | `skill="codex"` | `mcp__codex__codex` |
| claude | `skill="claude"` | なし |
| gemini | `skill="gemini"` | なし |

**エラー処理**:

- `ai_tools` 未設定: デフォルト `["codex"]` を使用
- 空配列: 警告を出し、デフォルトを使用
- 未知のツール名: 警告を出し、そのツールをスキップ
- 配列以外の型: 警告を出し、デフォルトを使用

## AIレビューツール利用可否の確認

**ai_tools設定に基づく優先順位判定**:

1. `ai_tools` リストを先頭から順に確認
2. 各ツールについて:
   - **Skills確認**: `skill="[ツール名]"` で呼び出し可能か確認
   - **MCPフォールバック**: Skills利用不可 かつ MCPフォールバックが存在する場合（codexのみ）、`mcp__codex__codex` を確認
3. 利用可能なツールが見つかったら、そのツールを選択
4. すべて利用不可: AIレビュー不可として処理

**環境別の確認方法**:

- Claude Code: Skillツールが存在し、`skill="[ツール名]"` で呼び出し可能かを確認
- KiroCLI等の他環境: Skill一覧取得APIがあればそれを利用、なければMCPフォールバックへ

## 処理フロー

1. **mode確認**: `docs/aidlc.toml` を読んでmodeを確認
   - 空または取得失敗時は「recommend」として扱う
   - `disabled` の場合: ステップ6（人間レビューフロー）へ
   - `required` または `recommend` の場合: 次のステップへ

2. **AIレビューツール利用可否チェック（ai_tools設定に基づく）**:
   - `ai_tools` リストを先頭から順に確認（デフォルト: `["codex"]`）
   - 各ツールについてSkillsで利用可能か確認
   - Skills利用不可 かつ MCPフォールバックあり（codexのみ）→ MCP確認
   - 利用可能なツールが見つかった → ステップ3へ
   - すべて利用不可 → ステップ5（AIレビュー不可時）へ

3. **AIレビューツール利用可能時の選択**:
   - `mode = "required"` の場合: ステップ4（AIレビューフロー）へ
   - `mode = "recommend"` の場合: 推奨メッセージを表示しユーザーに選択を求める

     ```text
     【レビュー推奨】AIレビューツール（Skills/MCP）が利用可能です。
     品質向上のため、この成果物のレビューを実施することを推奨します。
     レビューを実施しますか？
     ```

     - 「はい」の場合: ステップ4（AIレビューフロー）へ
     - 「いいえ」の場合: ステップ6（人間レビューフロー）へ

4. **AIレビューフロー**:
   - **レビュー前コミット**（変更がある場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```

   - **反復レビュー**（指摘がなくなるまで繰り返す、1セット最大3回）:
     1. AIレビューを実行（ステップ2で選択されたツールを使用）
     2. レビュー結果を確認
     3. 指摘があれば修正を反映
     4. 指摘がゼロになるまで1-3を繰り返す（1セット最大3回）
     5. 3回後も指摘が残る場合は、ユーザーに継続確認を求める:

        ```text
        【確認】AIレビューを3回実施しましたが、まだ指摘が残っています。

        残りの指摘:
        - [指摘1]
        - [指摘2]

        どのように進めますか？
        1. レビューを継続する（さらに3回まで）
        2. 人間が残りの指摘を確認する
        ```

     6. 「継続」選択時: さらに最大3回のレビューを実施（合計最大6回）
     7. 合計6回後もなお指摘が残る場合: 人間に提示して判断を仰ぐ
   - **レビュー後コミット**（反復完了後、修正があった場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```

   - 修正後の成果物を人間に提示
   - 人間の承認を求める

5. **AIレビュー不可時**（Skills/MCP両方利用不可の場合）:
   - `mode = "required"` の場合:

     ```text
     【警告】AIレビューが必須設定ですが、AIレビューツール（Skills/MCP）が利用できません。

     AIレビューをスキップして人間の承認に進みますか？
     1. はい - 人間承認へ進む（レビュースキップを履歴に記録）
     2. いいえ - 処理を中断
     ```

     ユーザーの応答を待ち、「はい」の場合は以下を履歴に記録してステップ6へ:

     ```markdown
     ### AIレビュースキップ
     - **理由**: AIレビューツール利用不可（ユーザー承認済み）
     - **日時**: YYYY-MM-DD HH:MM:SS
     - **対象成果物**: {成果物名}
     ```

     「いいえ」の場合: 処理を中断し、ユーザー再指示待ち状態へ
   - `mode = "recommend"` の場合: 自動的にステップ6へ

6. **人間レビューフロー**（mode=disabled または AIレビュー不可時）:
   - **レビュー前コミット**（変更がある場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```

   - 成果物を人間に提示
   - 人間の承認を求める
   - 修正依頼があれば修正を反映
   - **レビュー後コミット**（修正があった場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```

   - 再度人間に提示・承認を求める

## 外部入力検証ルール【重要】

外部からの入力（AIレビュー応答、ユーザー入力）を批判的に評価し、自己判断を明示する。

### AIレビュー応答の検証

- AIレビュー（Skills/MCP）からの応答をそのまま信頼せず、批判的に評価する
- 応答に誤りや不整合がないか確認する
- 自己判断を併記し、相違がある場合はユーザーに確認を求める
- 形式：

  ```text
  【AIレビュー応答の検証】
  - AIレビュー応答: [応答内容の要約]
  - AI判断: [自己判断]
  - 相違点: [ある場合は記載、なければ「なし」]
  - 結論: [採用する判断とその理由]
  ```

### ユーザー入力の検証

- ユーザー入力に曖昧さがある場合は、解釈を明示して確認する
- 複数の解釈が可能な場合は、すべての解釈を提示する
- 形式：

  ```text
  【入力の解釈確認】
  ご入力: "[ユーザーの入力]"

  以下のように解釈しました：
  [解釈内容]

  この解釈で正しいでしょうか？
  ```
