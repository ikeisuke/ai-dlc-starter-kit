# Construction Phase 実行計画: Unit1 - setup-prompt.mdのリファクタリング

## Unit概要
setup-prompt.md を新しいディレクトリ構造に対応させ、共通プロンプト・テンプレートと バージョン固有成果物を適切に分離できるようにする

## 実装範囲
- `AIDLC_ROOT`、`VERSIONS_ROOT` 変数の追加
- プロンプトファイル生成先を `{{AIDLC_ROOT}}/prompts/` に変更
- テンプレートファイル生成先を `{{AIDLC_ROOT}}/templates/` に変更
- 各フェーズプロンプトに common.md の内容を含める処理の実装
- `docs/aidlc/version.txt` の自動生成
- additional-rules.md を共通とバージョン固有の両方に配置

## 実行ステップ

### Phase 1: 設計（コードは書かない、対話形式）

#### ステップ1: ドメインモデル設計
- **目的**: setup-prompt.mdの責務と構造をDDDに基づいて定義
- **成果物**: `docs/versions/v1.0.0/design-artifacts/domain-models/unit1_domain_model.md`
- **アプローチ**:
  - セットアッププロセス全体を分析し、エンティティ・値オブジェクト・ドメインサービスを特定
  - 新旧ディレクトリ構造の違いを明確化
  - バージョン管理に関するドメイン知識を整理
- **対話**: 不明点は一問一答形式で確認

#### ステップ2: 論理設計
- **目的**: 具体的なディレクトリ構造、ファイル生成フロー、変数処理を設計
- **成果物**: `docs/versions/v1.0.0/design-artifacts/logical-designs/unit1_logical_design.md`
- **アプローチ**:
  - 変数システムの設計（AIDLC_ROOT、VERSIONS_ROOT等）
  - ファイル生成処理の順序と依存関係
  - 後方互換性の保証方法
  - エラーハンドリング戦略
- **対話**: 不明点は一問一答形式で確認

#### ステップ3: 設計レビュー
- **目的**: ユーザーに設計内容を提示し、承認を得る
- **重要**: 承認なしで実装フェーズに進まない

### Phase 2: 実装（設計を参照してコード生成）

#### ステップ4: コード生成
- **目的**: 設計に基づいてsetup-prompt.mdを更新
- **作業内容**:
  - 変数定義セクションに `AIDLC_ROOT`、`VERSIONS_ROOT` を追加
  - プロンプトファイル生成処理を更新（`{{AIDLC_ROOT}}/prompts/` に生成）
  - テンプレートファイル生成処理を更新（`{{AIDLC_ROOT}}/templates/` に生成）
  - common.md 生成ロジックの追加
  - additional-rules.md の配置ロジック追加
  - `docs/aidlc/version.txt` 生成処理の追加
- **セキュリティ考慮**:
  - パスインジェクション対策
  - ファイル操作の安全性確保

#### ステップ5: テスト生成
- **目的**: 変更内容の妥当性を検証するテスト作成
- **テスト項目**:
  - 新しい変数が正しく設定されているか
  - ファイルが正しいパスに生成されるか
  - 後方互換性が保たれているか
  - エラーケースが適切にハンドリングされるか

#### ステップ6: 統合とレビュー
- **目的**: 動作確認とレビュー
- **作業内容**:
  - MODE=setup での動作確認
  - MODE=template での動作確認
  - 生成されたファイルの検証
  - コードレビュー（セキュリティ、エラーハンドリング等）
- **成果物**: `docs/versions/v1.0.0/construction/units/unit1_implementation_record.md`

#### ステップ7: progress.md更新とコミット
- **目的**: 進捗状況を記録し、Gitコミットを作成
- **作業内容**:
  - progress.md の Unit1 状態を「完了」に変更
  - 完了日を記録
  - 次回実行可能なUnit候補を更新（Unit2とUnit3が実行可能になる）
  - すべての変更をGitコミット

## 依存関係
- なし（最初に実行するUnit）

## 非機能要件
- **パフォーマンス**: セットアップ完了時間は v0.1.0 と同等
- **セキュリティ**: ファイル操作の安全性確保
- **後方互換性**: 既存の `DOCS_ROOT`、`VERSION` 変数も使用可能
- **エラーハンドリング**: 適切なエラーメッセージとガイダンス

## 見積もり
半日〜1日

## 備考
- このUnitは他のすべてのUnitの基盤となるため、慎重に設計・実装する
- 後方互換性を維持しつつ、新しい構造に対応する
