# 論理設計: 共通セクション外部化

## 概要

ドメインモデル設計に基づき、具体的な実装方法を定義する。

## ファイル構成

### 作成するファイル

```
prompts/package/prompts/common/
├── intro.md      # AI-DLC手法の要約
└── rules.md      # 共通開発ルール
```

### rsyncデプロイ後のパス

```
docs/aidlc/prompts/common/
├── intro.md
└── rules.md
```

## 参照指示形式

Unit 001 PoC結果に基づき、**推奨形式**を採用:

```markdown
**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/intro.md` を読み込んで、内容を確認してください。
**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/rules.md` を読み込んで、内容を確認してください。
```

**理由**: Claude Code と KiroCLI の両方で動作確認済み

## 外部ファイル詳細設計

### intro.md の内容

```markdown
# AI-DLC手法の要約

AI-DLCは、AIを開発の中心に据えた新しい開発手法です。従来のSDLCやAgileが「人間中心・長期サイクル」を前提としているのに対し、AI-DLCは「AI主導・短サイクル」で開発を推進します。

**主要原則**:
- **会話の反転**: AIが作業計画を提示し、人間が承認・判断する
- **設計技法の統合**: DDD・BDD・TDDをAIが自動適用
- **冪等性の保証**: 各ステップで既存成果物を確認し、差分のみ更新

**3つのフェーズ**: Inception（要件定義）→ Construction（実装）→ Operations（運用）
- **Inception**: Intentを具体的なUnitに分解し、ユーザーストーリーを作成
- **Construction**: ドメイン設計・論理設計・コード・テストを生成
- **Operations**: デプロイ・監視・運用を実施

**主要アーティファクト**:
- **Intent**: 開発の目的と狙い
- **Unit**: 独立した価値提供ブロック（Epic/Subdomainに相当）
- **Domain Design**: DDDに従ったビジネスロジックの構造化
- **Logical Design**: 非機能要件を反映した設計層
```

### rules.md の内容

```markdown
# 共通開発ルール

以下のルールは全フェーズで共通して適用されます。

## 人間の承認プロセス【重要】

計画作成後、必ず以下を実行する:

1. 計画ファイルのパスをユーザーに提示
2. 「この計画で進めてよろしいですか？」と明示的に質問
3. ユーザーが「承認」「OK」「進めてください」などの肯定的な返答をするまで待機
4. **承認なしで次のステップを開始してはいけない**

## 質問と回答の記録【重要】

独自の判断をせず、不明点はドキュメントに `[Question]` タグで記録し `[Answer]` タグを配置、ユーザーに回答を求める。

## 予想禁止・一問一答質問ルール【重要】

不明点や判断に迷う点がある場合、予想や仮定で進めてはいけない。必ずユーザーに質問する。

**質問フロー（ハイブリッド方式）**:

1. まず質問の数と概要を提示する
   \`\`\`text
   質問が{N}点あります：
   1. {質問1の概要}
   2. {質問2の概要}
   ...

   まず1点目から確認させてください。
   \`\`\`
2. 1問ずつ詳細を質問し、回答を待つ
3. 回答を得てから次の質問に進む
4. 回答に基づく追加質問が発生した場合は「追加で確認させてください」と明示して質問する

**質問すべき場面**:

- 要件が曖昧な場合
- 複数の解釈が可能な場合
- 技術的な選択肢がある場合
- 前提条件が不明確な場合

## Gitコミットのタイミング【必須】

以下のタイミングで**必ず**Gitコミットを作成する:

1. セットアップ完了時
2. Inception Phase完了時
3. 各Unit完了時
4. Operations Phase完了時

コミットメッセージは変更内容を明確に記述

## jjサポート設定

`docs/aidlc.toml`の`[rules.jj]`セクションを確認:

- `enabled = true`: jjを使用。gitコマンドを`docs/aidlc/guides/jj-support.md`の対照表で読み替えて実行
- `enabled = false`、未設定、または不正値: 以下のgitコマンドをそのまま使用

## コード品質基準

コード品質基準、Git運用の原則は `docs/cycles/rules.md` を参照
```

## 各プロンプトの修正方針

### 削除対象セクション

各プロンプトから以下を削除:

1. `## AI-DLC手法の要約` セクション全体（約20行）
2. `### 開発ルール` 内の共通ルール部分（約40行）
   - 人間の承認プロセス
   - 質問と回答の記録
   - 予想禁止・一問一答質問ルール
   - Gitコミットのタイミング
   - jjサポート設定
   - コード品質基準参照

### 参照指示の挿入位置

各プロンプトのタイトル直後、既存の `---` の前に挿入（3行追加）:

```markdown
# {Phase名} Phase プロンプト

**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/intro.md` を読み込んで、内容を確認してください。  ← 追加
**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/rules.md` を読み込んで、内容を確認してください。  ← 追加
                                                                                                          ← 追加（空行）
---  ← 既存
```

### フェーズ固有セクション（残す）

| プロンプト | 残すセクション |
|------------|----------------|
| inception.md | プロンプト履歴管理（inception固有パス） |
| construction.md | プロンプト履歴管理、気づき記録フロー、Workaround対応、割り込み対応フロー |
| operations.md | プロンプト履歴管理（operations固有パス）、タグ操作注意 |

## rsyncデプロイ設定確認

既存の `prompts/setup-prompt.md` 内のrsync設定を確認:

```bash
rsync -av --delete prompts/package/ docs/aidlc/
```

`common/` ディレクトリは自動的にコピーされるため、追加設定不要。

## 削減行数の詳細

### 計算前提（ドメインモデルと統一）

- intro.md: 約20行
- rules.md: 約45行
- 参照指示追加: 3行/ファイル

### 削減計算

| 項目 | inception.md | construction.md | operations.md |
|------|--------------|-----------------|---------------|
| intro削除 | -20行 | -20行 | -20行 |
| rules削除 | -45行 | -45行 | -45行 |
| 参照指示追加 | +3行 | +3行 | +3行 |
| **純削減** | **-62行** | **-62行** | **-62行** |
| **3ファイル計** | | | **-186行** |

外部ファイル追加: intro.md（20行）+ rules.md（45行）= +65行

**最終削減**: 186行 - 65行 = **約121行の純削減**（重複排除効果）

### 250行以上の削減達成について

- 本Unitのみでは250行には届かない
- **AIレビューフロー（約70行×3ファイル = 210行）はUnit 003で対応**
- Unit 002（186行） + Unit 003（210行） = 合計で約396行削減となり、目標を大きく上回る

## テスト計画

1. **参照読み込み確認**: 各プロンプト修正後、参照が正しく読み込まれるか確認
2. **整合性確認**: 削除漏れ・重複がないか確認
3. **行数確認**: 修正前後の行数を比較
