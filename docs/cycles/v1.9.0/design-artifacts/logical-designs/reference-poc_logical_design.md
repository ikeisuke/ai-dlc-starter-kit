# 論理設計: 参照方式PoC

## 1. アーキテクチャ概要

本 Unit は PoC（概念実証）であり、検証用ファイルと検証手順を定義する。

### コンポーネント構成

```
prompts/package/prompts/common/
├── poc-test-level1.md    # レベル1（エントリーポイント）
├── poc-test-level2.md    # レベル2（レベル1から参照）
└── poc-test-level3.md    # レベル3（レベル2から参照）
```

**rsync 後のパス**:
```
docs/aidlc/prompts/common/
├── poc-test-level1.md
├── poc-test-level2.md
└── poc-test-level3.md
```

## 2. 検証用ファイル設計

### 2.1 poc-test-level1.md

**役割**: エントリーポイント。レベル2への参照指示を含む。

```markdown
# PoC検証 - レベル1

このファイルは参照方式のPoC検証用です。

## 確認項目

- このメッセージが表示されていれば、レベル1の読み込みは成功です
- 次に、レベル2を読み込んでください

`docs/aidlc/prompts/common/poc-test-level2.md` を読み込んでください。
```

### 2.2 poc-test-level2.md

**役割**: 中間層。レベル3への参照指示を含む。

```markdown
# PoC検証 - レベル2

レベル1からの参照で、このファイルが読み込まれました。

## 確認項目

- このメッセージが表示されていれば、レベル2の読み込みは成功です
- 次に、レベル3を読み込んでください

`docs/aidlc/prompts/common/poc-test-level3.md` を読み込んでください。
```

### 2.3 poc-test-level3.md

**役割**: 終端。参照チェーンの最終段階。

```markdown
# PoC検証 - レベル3

レベル2からの参照で、このファイルが読み込まれました。

## 確認項目

- このメッセージが表示されていれば、3段階のネスト参照が成功しています

**検証完了**: 参照方式のPoCは成功です。
```

## 3. 検証手順

### 3.1 Claude Code での検証【必須】

| ステップ | 手順 | 期待結果 | 成功の証跡 |
|----------|------|----------|------------|
| 1 | 新しいセッションを開始 | セッション開始 | - |
| 2 | 「`docs/aidlc/prompts/common/poc-test-level1.md` を読み込んでください」と入力 | AI が Read ツールでファイルを読み込む | Read ツール呼び出しログ |
| 3 | AI がレベル2への参照指示を認識するか確認 | AI が**追加指示なしで**レベル2を読み込む | Read ツール呼び出しログ + 「レベル2」の文言確認 |
| 4 | **【合格ライン】** レベル1→2 の成功を確認 | 2段階参照成功 | 「レベル2の読み込みは成功」の文言 |
| 5 | （任意）AI がレベル3への参照指示を認識するか確認 | AI が**追加指示なしで**レベル3を読み込む | Read ツール呼び出しログ + 「検証完了」の文言 |

**PoC 合格条件（必須）**:
- レベル1, 2 が読み込まれる（**2段階成功で合格**）
- AI が Read ツールを呼び出した証跡がログに残る
- レベル2のファイル内容（「レベル2」「成功」の文言）が AI の応答に含まれる

**「追加指示なしで」の定義**:
- ユーザーがレベル2/3の読み込みを明示的に指示していない状態で、AI がファイル内の参照指示を認識し、自律的に Read ツールを呼び出すこと
- 成功判定: Read ツール呼び出しがユーザー指示なしで発生

**追加成功条件（任意）**:
- レベル3 も読み込まれる（3段階成功）
- 「検証完了」の文言が AI の応答に含まれる

### 3.2 KiroCLI での検証【任意 - ユーザー確認】

**注意**: この検証は**任意**です。KiroCLI 環境をお持ちのユーザーが確認し、結果を報告してください。

**前提条件**:
- KiroCLI がインストールされている
- エージェント設定ファイルが作成されている

| ステップ | 手順 | 期待結果 |
|----------|------|----------|
| 1 | `.kiro/agents/aidlc-poc.json` を作成（下記参照） | 設定完了 |
| 2 | KiroCLI でエージェントを起動 | エージェント起動 |
| 3 | 「`docs/aidlc/prompts/common/poc-test-level1.md` を読み込んでください」と入力 | AI が Read ツールでファイルを読み込む |
| 4 | AI がレベル2を読み込むか確認 | 2段階参照成功 |

**エージェント設定例**:
```json
{
  "name": "aidlc-poc",
  "resources": [],
  "tools": ["read", "write", "shell"]
}
```

**注意**: resources を空にして、指示形式のみで参照できるか検証する。

**KiroCLI 検証結果の報告**: ユーザーは検証結果を実装記録に追記するか、Issue で報告してください。

## 4. 判定基準

### 4.1 PoC 合格判定

| 判定 | 条件 | 証跡 |
|------|------|------|
| **合格** | Claude Code で 2段階参照（レベル1→2）成功 | Read ツール呼び出しログ2回 + レベル2の文言確認 |
| 追加成功 | 3段階参照（レベル1→2→3）成功 | Read ツール呼び出しログ3回 + 「検証完了」文言 |
| 追加成功 | KiroCLI で 2段階参照成功 | ユーザーからの報告 |

### 4.2 成功の証跡（観測可能な確認項目）

| 証跡 | 確認方法 | 判定ルール |
|------|----------|------------|
| Read ツール呼び出し | Claude Code のツール呼び出しログに `Read` が表示される | 完全一致 |
| レベル1成功 | AI の応答に「レベル1」「成功」の両方が含まれる | **部分一致**（ファイル本文: 「〜成功です」） |
| レベル2成功 | AI の応答に「レベル2」「成功」の両方が含まれる | **部分一致**（ファイル本文: 「〜成功です」） |
| レベル3成功 | AI の応答に「検証完了」が含まれる | 部分一致 |

**注意**: ファイル本文は「〜は成功です」形式のため、判定は部分一致で行う。

### 4.3 失敗時の対応

| 失敗パターン | 対応 | 再検証の比較軸 |
|--------------|------|---------------|
| AI が指示を無視 | 指示形式を調整 | 文言変更（「読み込んでください」→「読み込んで、内容を確認してください」） |
| レベル1のみ成功 | 参照指示の位置・強調を変更 | 指示位置（末尾→冒頭）、強調（バックティック→太字） |
| 環境依存の問題 | 環境ごとの注意事項として文書化 | - |

### 4.4 検証環境

| 項目 | 値 |
|------|-----|
| Claude Code バージョン | 検証実行時に記録 |
| モデル | 検証実行時に記録 |
| OS | 検証実行時に記録 |

## 5. 成果物一覧

| 成果物 | パス | 用途 |
|--------|------|------|
| 検証用ファイル（3つ） | `prompts/package/prompts/common/poc-test-level*.md` | 検証実行 |
| 実装記録 | `docs/cycles/v1.9.0/construction/units/reference-poc_implementation.md` | 検証結果記録 |
| 参照ガイド | `prompts/package/guides/reference-guide.md` | ユーザー向けドキュメント |

## 6. 検証結果からの発見

### 6.1 指示形式の環境依存性

検証の結果、指示形式によって環境間で動作が異なることが判明。

| 指示形式 | Claude Code | KiroCLI |
|----------|-------------|---------|
| `〜を読み込んでください。` | 成功 | 認識のみ（実行せず） |
| `**【次のアクション】** 今すぐ〜を読み込んで、内容を確認してください。` | 成功 | 成功 |

### 6.2 推奨指示形式

Unit 002, 003 でのモジュール化では、KiroCLI互換性のため以下の形式を使用する:

```markdown
**【次のアクション】** 今すぐ `{ファイルパス}` を読み込んで、内容を確認してください。
```

## 7. 次のステップ

- Unit 002: 共通セクション外部化（推奨指示形式を使用）
- Unit 003: AIレビューフロー外部化（推奨指示形式を使用）
