# 論理設計: AIレビューフロー外部化

## 概要

ドメインモデル設計に基づき、AIレビューフローの外部化と各プロンプトへの参照挿入を定義する。

## ファイル構成

### 作成するファイル

```
prompts/package/prompts/common/
├── intro.md        # 既存（Unit 002で作成済み）
├── rules.md        # 既存（Unit 002で作成済み）
└── review-flow.md  # 新規作成（本Unit）
```

### rsyncデプロイ後のパス

```
docs/aidlc/prompts/common/
├── intro.md
├── rules.md
└── review-flow.md
```

## 参照指示形式

Unit 001 PoC結果に基づき、**推奨形式**を採用:

```markdown
**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/review-flow.md` を読み込んで、内容を確認してください。
```

**理由**: Claude Code と KiroCLI の両方で動作確認済み（Unit 001 PoC）

## 外部ファイル詳細設計

### review-flow.md の完全文面

以下は実装時に `prompts/package/prompts/common/review-flow.md` に記載する内容:

```markdown
# AIレビューフロー

人間に承認を求める前に、AIレビュー（Skills優先、MCPフォールバック）を実行する。

## 設定確認

`docs/aidlc.toml` の `[rules.mcp_review]` セクションを読み、`mode` の値を確認:

- `mode = "required"`: AIレビュー必須（AIレビューツールが両方利用不可の場合、ユーザー承認により例外的に人間レビューへ移行可能。承認は履歴に記録する）
- `mode = "recommend"`: AIレビュー推奨（スキップ可能、デフォルト）
- `mode = "disabled"`: AIレビューを行わない（AIレビューをスキップし、直接人間レビューへ進む）

## AIレビューツール利用可否の確認（Skills優先）

- **Skills確認**: Skillツール一覧から `codex` スキルが利用可能か確認（スキル名は `codex` 固定）
  - Claude Code: Skillツールが存在し、`skill="codex"`で呼び出し可能かを確認
  - KiroCLI等の他環境: Skill一覧取得APIがあればそれを利用、なければMCPフォールバックへ
- **MCPフォールバック**: Skills利用不可の場合、Codex MCPツール（`mcp__codex__codex`）の存在を確認
- **両方利用不可**: AIレビュー不可として処理

## 処理フロー

1. **mode確認**: `docs/aidlc.toml` を読んでmodeを確認
   - 空または取得失敗時は「recommend」として扱う
   - `disabled` の場合: ステップ6（人間レビューフロー）へ
   - `required` または `recommend` の場合: 次のステップへ

2. **AIレビューツール利用可否チェック（Skills優先）**:
   - Skills（`skill="codex"`）が利用可能 → ステップ3へ
   - Skills利用不可 → MCPフォールバック（`mcp__codex__codex`）を確認
   - MCP利用可能 → ステップ3へ
   - 両方利用不可 → ステップ5（AIレビュー不可時）へ

3. **AIレビューツール利用可能時の選択**:
   - `mode = "required"` の場合: ステップ4（AIレビューフロー）へ
   - `mode = "recommend"` の場合: 推奨メッセージを表示しユーザーに選択を求める
     \`\`\`text
     【レビュー推奨】AIレビューツール（Skills/MCP）が利用可能です。
     品質向上のため、この成果物のレビューを実施することを推奨します。
     レビューを実施しますか？
     \`\`\`
     - 「はい」の場合: ステップ4（AIレビューフロー）へ
     - 「いいえ」の場合: ステップ6（人間レビューフロー）へ

4. **AIレビューフロー**:
   - **レビュー前コミット**（変更がある場合のみ）:
     \`\`\`bash
     [ -n "$(git status --porcelain)" ] && git add -A && git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     \`\`\`
   - **反復レビュー**（指摘がなくなるまで繰り返す、1セット最大3回）:
     1. AIレビューを実行（Skills優先、利用不可ならMCP使用）
     2. レビュー結果を確認
     3. 指摘があれば修正を反映
     4. 指摘がゼロになるまで1-3を繰り返す（1セット最大3回）
     5. 3回後も指摘が残る場合は、ユーザーに継続確認を求める:
        \`\`\`text
        【確認】AIレビューを3回実施しましたが、まだ指摘が残っています。

        残りの指摘:
        - [指摘1]
        - [指摘2]

        どのように進めますか？
        1. レビューを継続する（さらに3回まで）
        2. 人間が残りの指摘を確認する
        \`\`\`
     6. 「継続」選択時: さらに最大3回のレビューを実施（合計最大6回）
     7. 合計6回後もなお指摘が残る場合: 人間に提示して判断を仰ぐ
   - **レビュー後コミット**（反復完了後、修正があった場合のみ）:
     \`\`\`bash
     [ -n "$(git status --porcelain)" ] && git add -A && git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     \`\`\`
   - 修正後の成果物を人間に提示
   - 人間の承認を求める

5. **AIレビュー不可時**（Skills/MCP両方利用不可の場合）:
   - `mode = "required"` の場合:
     \`\`\`text
     【警告】AIレビューが必須設定ですが、AIレビューツール（Skills/MCP）が利用できません。

     AIレビューをスキップして人間の承認に進みますか？
     1. はい - 人間承認へ進む（レビュースキップを履歴に記録）
     2. いいえ - 処理を中断
     \`\`\`
     ユーザーの応答を待ち、「はい」の場合は以下を履歴に記録してステップ6へ:
     \`\`\`markdown
     ### AIレビュースキップ
     - **理由**: AIレビューツール利用不可（ユーザー承認済み）
     - **日時**: YYYY-MM-DD HH:MM:SS
     - **対象成果物**: {成果物名}
     \`\`\`
     「いいえ」の場合: 処理を中断し、ユーザー再指示待ち状態へ
   - `mode = "recommend"` の場合: 自動的にステップ6へ

6. **人間レビューフロー**（mode=disabled または AIレビュー不可時）:
   - **レビュー前コミット**（変更がある場合のみ）:
     \`\`\`bash
     [ -n "$(git status --porcelain)" ] && git add -A && git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     \`\`\`
   - 成果物を人間に提示
   - 人間の承認を求める
   - 修正依頼があれば修正を反映
   - **レビュー後コミット**（修正があった場合のみ）:
     \`\`\`bash
     [ -n "$(git status --porcelain)" ] && git add -A && git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     \`\`\`
   - 再度人間に提示・承認を求める

## 外部入力検証ルール【重要】

外部からの入力（AIレビュー応答、ユーザー入力）を批判的に評価し、自己判断を明示する。

### AIレビュー応答の検証

- AIレビュー（Skills/MCP）からの応答をそのまま信頼せず、批判的に評価する
- 応答に誤りや不整合がないか確認する
- 自己判断を併記し、相違がある場合はユーザーに確認を求める
- 形式：
  \`\`\`text
  【AIレビュー応答の検証】
  - AIレビュー応答: [応答内容の要約]
  - AI判断: [自己判断]
  - 相違点: [ある場合は記載、なければ「なし」]
  - 結論: [採用する判断とその理由]
  \`\`\`

### ユーザー入力の検証

- ユーザー入力に曖昧さがある場合は、解釈を明示して確認する
- 複数の解釈が可能な場合は、すべての解釈を提示する
- 形式：
  \`\`\`text
  【入力の解釈確認】
  ご入力: "[ユーザーの入力]"

  以下のように解釈しました：
  [解釈内容]

  この解釈で正しいでしょうか？
  \`\`\`
```

**行数**: 約115行（完全版）

## 各プロンプトの修正方針

### 削除対象セクション

各プロンプトから以下を削除:

1. `- **AIレビュー優先ルール【重要】**` から始まるブロック全体
   - 設定確認
   - AIレビューツール利用可否の確認
   - 処理フロー（ステップ1-6）
2. `- **外部入力検証ルール【重要】**` から始まるブロック全体
   - AIレビュー応答の検証
   - ユーザー入力の検証

### 削除対象の行数

| プロンプト | AIレビューフロー | 外部入力検証 | 合計削除行数 |
|------------|------------------|--------------|--------------|
| inception.md | 約70行 | 約25行 | 約95行 |
| construction.md | 約90行（反復含む） | 約25行 | 約115行 |
| operations.md | 約70行 | 約25行 | 約95行 |

**注**: construction.md は反復レビュー部分があるため行数が多い

### 残すセクション（フェーズ固有）

各プロンプトに「対象タイミング」のみを残す:

| プロンプト | 対象タイミング |
|------------|----------------|
| inception.md | Intent承認前、ユーザーストーリー承認前、Unit定義承認前 |
| construction.md | 計画ファイル承認前、設計レビュー前、コード生成後の確認前、テスト完了後の確認前 |
| operations.md | デプロイ計画承認前、運用ドキュメント承認前 |

### 参照指示の挿入位置

既存の開発ルールセクション内、共通ルール参照の後に挿入:

```markdown
### 開発ルール

**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/rules.md` を読み込んで、内容を確認してください。
**【次のアクション】** 今すぐ `docs/aidlc/prompts/common/review-flow.md` を読み込んで、内容を確認してください。  ← 追加

**AIレビュー対象タイミング**: {フェーズ固有のタイミング}  ← 残す

- **プロンプト履歴管理【重要】**: ...
```

## 完全共通化の詳細

### 反復レビュー機能の全フェーズ適用

construction.md にのみ存在した反復レビュー機能を全フェーズに適用:

```markdown
- **反復レビュー**（指摘がなくなるまで繰り返す、1セット最大3回）:
  1. AIレビューを実行（Skills優先、利用不可ならMCP使用）
  2. レビュー結果を確認
  3. 指摘があれば修正を反映
  4. 指摘がゼロになるまで1-3を繰り返す（1セット最大3回）
  5. 3回後も指摘が残る場合は、ユーザーに継続確認を求める
  6. 「継続」選択時: さらに最大3回のレビューを実施（合計最大6回）
  7. 合計6回後もなお指摘が残る場合: 人間に提示して判断を仰ぐ
```

**影響**: inception.md, operations.md でも反復レビューが有効になり、品質向上が期待できる

## 削減行数の詳細

### 計算

| 項目 | inception.md | construction.md | operations.md |
|------|--------------|-----------------|---------------|
| AIレビューフロー削除 | -70行 | -90行 | -70行 |
| 外部入力検証削除 | -25行 | -25行 | -25行 |
| 参照指示追加 | +1行 | +1行 | +1行 |
| 対象タイミング残す | +1行 | +1行 | +1行 |
| **純削減** | **-93行** | **-113行** | **-93行** |
| **3ファイル計** | | | **-299行** |

外部ファイル追加: review-flow.md（約110行）= +110行

**最終削減**: 299行 - 110行 = **約189行の純削減**

### Unit 002との合計

- Unit 002: 約121行削減
- Unit 003: 約189行削減
- **合計**: **約310行削減**（目標250行以上を達成）

## テスト計画

1. **参照読み込み確認**: 各プロンプト修正後、review-flow.md が正しく読み込まれるか確認
2. **整合性確認**: 削除漏れ・重複がないか確認
3. **行数確認**: 修正前後の行数を比較
4. **機能確認**: AIレビューフローが全フェーズで正しく動作するか確認

## 不明点と質問

なし（ドメインモデル設計時にユーザー回答により「完全共通化」を採用済み）
