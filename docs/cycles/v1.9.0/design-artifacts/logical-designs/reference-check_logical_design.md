# 論理設計: 参照漏れチェック

## 概要

プロンプトファイル内の外部ファイル参照を検出し、存在しないファイルへの参照を報告するシェルスクリプトの論理設計。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコードは Implementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン

シングルスクリプトアーキテクチャ。シェルスクリプト1ファイルで完結する設計。
関数を用いて責務を分離し、テスト容易性を確保する。

## コンポーネント構成

### スクリプト構成

```text
prompts/package/bin/
└── check-references.sh   # 参照漏れチェックスクリプト
```

### 関数構成

```text
check-references.sh
├── main()                    # エントリーポイント
├── extract_references()      # 参照パターン抽出
├── validate_reference()      # 参照先存在検証
├── resolve_path()            # パス解決（相対→絶対）
├── format_error()            # エラーメッセージ整形
└── show_usage()              # ヘルプ表示
```

### コンポーネント詳細

#### main()

- **責務**: スクリプトのエントリーポイント、引数解析、全体フロー制御、リポジトリルート取得
- **依存**: extract_references, validate_reference, format_error
- **公開インターフェース**: コマンドライン引数を受け取り、終了コードを返す
- **初期化**: `git rev-parse --show-toplevel` でリポジトリルートを取得し、各関数に渡す。失敗時は終了コード2でエラー終了

#### extract_references()

- **責務**: 指定ファイルから参照パターンを抽出
- **依存**: なし
- **公開インターフェース**: ファイルパスを受け取り、参照情報を標準出力
- **出力形式**: タブ区切りで以下を出力
  - フィールド1: 参照元ファイルパス（リポジトリルート相対）
  - フィールド2: 行番号
  - フィールド3: 参照先パス（バックティック内、リポジトリルート相対）
  - フィールド4: コンテキスト（該当行の内容、80文字まで、タブは空白に置換）
- **注意**: コンテキスト内のタブ文字は空白に置換してフィールド境界を保護する

#### validate_reference()

- **責務**: 参照先ファイルの存在確認
- **依存**: resolve_path
- **公開インターフェース**: 参照パスを受け取り、存在確認結果を返す

#### resolve_path()

- **責務**: 相対パスを絶対パスに解決
- **依存**: なし
- **公開インターフェース**: リポジトリルート（main()から渡される）と参照パスを受け取り、解決パスを返す
- **パス解決基準**: 常にリポジトリルートを基準として解決（参照元ファイルの位置は考慮しない）
  - 例: `docs/aidlc/prompts/common/intro.md` → `${REPO_ROOT}/docs/aidlc/prompts/common/intro.md`
- **注**: リポジトリルートはmain()で取得し、この関数に引数として渡される

#### format_error()

- **責務**: エラーメッセージの整形
- **依存**: なし
- **公開インターフェース**: エラー情報を受け取り、整形済みメッセージを返す

## インターフェース設計

### コマンドラインインターフェース

#### check-references.sh

- **パラメータ**:
  - [target_dir]: String (オプション) - チェック対象ディレクトリ。デフォルト: `prompts/package/`
  - --help, -h: ヘルプ表示
  - --verbose, -v: 詳細出力モード
- **戻り値**: 終了コード
  - 0: 参照漏れなし
  - 1: 参照漏れあり
  - 2: スクリプトエラー（引数不正など）
- **標準出力**: 参照漏れのリスト（エラーがある場合）
- **標準エラー出力**: エラーメッセージ、詳細ログ（verbose時）

### 出力フォーマット

#### 正常終了時（参照漏れなし）

```text
Checking references in prompts/package/...
All references are valid. (42 references checked)
```

#### エラー終了時（参照漏れあり）

```text
Checking references in prompts/package/...

ERROR: Broken reference found:
  File: prompts/package/prompts/inception.md:15
  Reference: `docs/aidlc/prompts/nonexistent.md`
  Context: "**【次のアクション】** 今すぐ `docs/aidlc/prompts/nonexistent.md` を読み込んで..."

ERROR: Broken reference found:
  File: prompts/package/prompts/operations.md:42
  Reference: `docs/aidlc/guides/missing.md`
  Context: "`docs/aidlc/guides/missing.md` を参照してください"

2 broken references found. (40 valid, 2 broken)
```

## データモデル概要

### ファイル形式（該当する場合）

このUnitではファイル出力は行わない。結果は標準出力に出力する。

## 処理フロー概要

### 参照チェックの処理フロー

**ステップ**:

1. コマンドライン引数を解析し、対象ディレクトリを決定
2. 対象ディレクトリ内の `.md` ファイルを列挙
3. 各ファイルについて:
   1. ファイル内容を読み込む
   2. 参照パターン（`を読み込んで` / `を参照して`形式）を抽出
   3. 各参照について参照先ファイルの存在を確認
   4. 存在しない場合はエラーとして記録
4. 集計結果を出力
5. エラーがあれば終了コード1、なければ0で終了

**関与するコンポーネント**: main, extract_references, validate_reference, resolve_path, format_error

### パターンマッチング詳細

**検出対象パターン**:

1. バックティック内のパス + 「を読み込んで」で始まる形式
   - 例: `` `docs/aidlc/prompts/common/intro.md` を読み込んでください ``
   - 例: `` `docs/aidlc/prompts/common/intro.md` を読み込んで、内容を確認 ``
2. バックティック内のパス + 「を参照して」で始まる形式
   - 例: `` `docs/aidlc/guides/xxx.md` を参照してください ``
   - 語尾の揺れ（「ください」「下さい」等）は問わず、「を読み込んで」「を参照して」で始まるものを検出

**対象拡張子**:

バックティック内のパスとして検出する対象は以下の拡張子を持つファイルのみ:
- `.md` - Markdownファイル
- `.toml` - TOML設定ファイル
- `.sh` - シェルスクリプト
- `.json` - JSONファイル
- `.yaml`, `.yml` - YAMLファイル

**除外対象**:

- コードブロック（``` または ~~~）内の参照
- コメント内の参照（HTMLコメント `<!-- -->`）
- 外部URL（http:// https://）

**除外処理の実装方針**:

- awkを使用して状態遷移による除外を実装
- コードブロック: ``` または ~~~ で開始・終了をトラックし、ブロック内の行をスキップ（インデントコードブロックは対象外）
- HTMLコメント: `<!--` から `-->` までをスキップ（複数行対応）
- 誤検知リスク軽減のため、シンプルな状態管理を採用

## 非機能要件（NFR）への対応

### パフォーマンス

- **要件**: スクリプト実行が数秒以内に完了すること
- **対応策**: シェルビルトインとgrepを活用し、外部プロセス呼び出しを最小化

### セキュリティ

- **要件**: 該当なし
- **対応策**: 特になし（読み取り専用の検証ツール）

### スケーラビリティ

- **要件**: 該当なし
- **対応策**: 特になし

### 可用性

- **要件**: 該当なし
- **対応策**: 特になし

## 技術選定

- **言語**: Bash（3.2以降必須）
- **依存ツール**: grep, find, git（gitはリポジトリルート取得に使用）

## CI/手動実行サポート

### 手動実行

```bash
# リポジトリルートから実行
./prompts/package/bin/check-references.sh

# 対象ディレクトリを指定
./prompts/package/bin/check-references.sh docs/aidlc/
```

### CI実行

以下のような形式でCI（GitHub Actions等）に組み込むことを想定:

```yaml
- name: Check references
  run: ./prompts/package/bin/check-references.sh
```

スクリプトは終了コードで結果を返すため、CIの成功/失敗判定に直接利用可能:
- 終了コード0: 参照漏れなし（CI成功）
- 終了コード1: 参照漏れあり（CI失敗）
- 終了コード2: スクリプトエラー（CI失敗）

**想定実行パス**: スクリプトはリポジトリルートから実行されることを前提とする。

## 実装上の注意事項

- **bash限定**: このスクリプトはbash 3.2以降を前提とする（`[[ ]]`、`=~`、プロセス置換などbash固有機能を使用）
- ファイルパスに空白が含まれる場合を考慮
- macOSとLinuxの両方で動作することを確認
- エラーメッセージは行番号付きで出力し、ユーザーが修正箇所を特定しやすくする

## 不明点と質問（設計中に記録）

（現時点で不明点なし）
