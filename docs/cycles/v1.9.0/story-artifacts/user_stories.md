# ユーザーストーリー

## Epic 1: プロンプトモジュール化

### ストーリー 1: 外部参照方式のPoC確立 (#74)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to 「ファイルを読み込んでください」指示形式で外部ファイルを参照できることを確認したい
So that プロンプトのモジュール化が技術的に可能であることを検証できる

**受け入れ基準**:
- [ ] Claude Codeで「`path/to/file.md`を読み込んでください」指示が動作する
- [ ] KiroCLIで同様の指示形式が動作する
- [ ] 参照形式のドキュメントが作成されている

**技術的考慮事項**:
- AGENTS.mdの`@`記法との違いを明確にする
- KiroCLIではresourcesフィールドも併用が必要な場合がある

---

### ストーリー 2: 共通セクションの外部ファイル化 (#76)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to 各プロンプトで重複している共通セクションを外部ファイルに切り出したい
So that ルール変更時に1箇所の修正で済むようになる

**受け入れ基準**:
- [ ] `prompts/package/prompts/common/intro.md`（AI-DLC手法の要約）が作成されている
- [ ] `prompts/package/prompts/common/rules.md`（共通開発ルール）が作成されている
- [ ] inception.md, construction.md, operations.mdが外部ファイルを参照する形式に変更されている
- [ ] 合計250行以上の削減が達成されている（基準: v1.8.1リリース時点の4プロンプト合計行数）

**技術的考慮事項**:
- rsyncデプロイ設定で新規ディレクトリが正しくコピーされることを確認

---

### ストーリー 3: AIレビューフローの外部化 (#77)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to AIレビューフローを外部ファイルに切り出したい
So that レビュー手順の変更が全フェーズに自動的に反映される

**受け入れ基準**:
- [ ] `prompts/package/prompts/common/review-flow.md`が作成されている
- [ ] inception.md, construction.md, operations.mdからレビューフロー記述が削除されている
- [ ] 外部ファイル参照形式に置き換えられている

**技術的考慮事項**:
- Skillツール（codex）とMCPツールのフォールバック処理を含める

---

## Epic 2: 品質管理

### ストーリー 4: 参照漏れチェック機構の導入 (#75)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to プロンプト内の外部ファイル参照が正しいかをチェックしたい
So that 参照先ファイルの削除・移動時に気づける

**受け入れ基準**:
- [ ] 参照漏れを検出するスクリプトが作成されている
- [ ] 存在しないファイルへの参照を検出できる
- [ ] CI/手動で実行可能

**技術的考慮事項**:
- 「〜を読み込んでください」形式のパターンマッチング
- 相対パス・絶対パスの両方に対応

---

### ストーリー 5: Operations Phaseサイズチェック追加 (#79)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to プロンプトファイルのサイズが閾値を超えた場合に警告を受けたい
So that プロンプトの肥大化を早期に検知できる

**受け入れ基準**:
- [ ] サイズチェックスクリプトが作成されている
- [ ] 閾値（行数またはバイト数）が設定可能
- [ ] 閾値超過時に警告メッセージが表示される
- [ ] Operations Phase完了時のチェックリストに組み込まれている

**技術的考慮事項**:
- 閾値はaidlc.tomlで設定可能にする

---

## Epic 3: メンテナンス性向上

### ストーリー 6: 後方互換性コードのdeprecation準備 (#80)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to 将来削除予定の後方互換性コードを明確に管理したい
So that 計画的にコードの整理ができる

**受け入れ基準**:
- [ ] deprecation対象の一覧ドキュメントが作成されている
- [ ] 各対象に削除予定バージョンが記載されている
- [ ] 対象コードに警告メッセージまたはコメントが追加されている

**技術的考慮事項**:
- CHANGELOG.mdにdeprecation情報を記載

---

### ストーリー 7: AIDLCアップグレード指示の改善 (#87)
**優先順位**: Must-have

As a AI-DLCメンテナー（メタ開発）
I want to アップグレード指示にメタ開発用のパス参照を追加したい
So that メタ開発時に正しいパスを参照できる

**受け入れ基準**:
- [ ] アップグレード指示に`prompts/package/`パスの参照が追加されている
- [ ] メタ開発環境と通常環境の違いが明確になっている

**技術的考慮事項**:
- rules.mdの「メタ開発の意識」セクションとの整合性

---

### ストーリー 8: 設定確認スクリプトの整備 (#78)
**優先順位**: Must-have

As a AI-DLCメンテナー
I want to プロンプト内の重複bashコードをスクリプト化したい
So that プロンプトの簡潔化と保守性向上を実現できる

**受け入れ基準**:
- [ ] `prompts/package/bin/check-backlog-mode.sh`（バックログモード確認）が作成されている
- [ ] `prompts/package/bin/check-gh-status.sh`（GitHub CLI確認）が作成されている
- [ ] inception.md, construction.md, operations.mdがスクリプト呼び出しに変更されている
- [ ] 約100行の削減が達成されている（基準: v1.8.1リリース時点の4プロンプト合計行数）

**技術的考慮事項**:
- 既存のbin/配下スクリプトとの整合性

---

### ストーリー 9: 複合コマンド廃止・許可リスト整備 (#34)
**優先順位**: Must-have

As a AI-DLC利用者
I want to プロンプト内の複合コマンドを単純化したい
So that 許可リスト運用が改善され、承認プロンプトが減少する

**受け入れ基準**:
- [ ] `&&`, `||`, `|`を含む複合コマンドが単純コマンドに置き換えられている
- [ ] 変数代入パターン（`VAR=$(cmd)`）が削除されている
- [ ] AIがReadツールで直接読み取る方式に変更されている
- [ ] gh label関連コマンドが許可リストに追加されている

**技術的考慮事項**:
- 条件分岐・ループはAIが判断/繰り返し実行する方式に変更
- dasel構文の`-r toml`オプション削除（v2対応）

---

## 後回し（Should/バックログ戻し）

以下のストーリーは今回のサイクルでは対応せず、バックログに残す。

| Issue | 内容 | 理由 |
|-------|------|------|
| #81 | env-info.shにセットアップ情報を追加 | cycle:v1.9.0ラベルなし |
| #85 | 各プロンプトの依存コマンド条件分岐を削除 | cycle:v1.8.1ラベル（前サイクル残り） |
| #93 | setup.md: env確認の重複解消 | cycle:v1.9.0ラベルなし |
| #94 | setup.md: サイクル一覧取得時の不要項目除外 | cycle:v1.9.0ラベルなし |
| #88 | init-cycle-dir.sh でプレリリースバージョンをサポート | cycle:v1.9.0ラベルなし |
