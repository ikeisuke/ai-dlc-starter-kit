# Unit 006 計画: AIレビュー機能の強化

**作成日**: 2025-12-31
**対象Unit**: 006-ai-review-enhancement

## 目的

mode=required時にAIレビューが確実に実行されるようにし、人間に承認を求める前にAIレビューが自動実行される仕組みを導入する。

## 現状分析

### 現在の実装（3ファイル共通）

```markdown
- **MCPレビュー【設定に応じて】**: ユーザーの承認を求める前に、MCPレビューを実施する。

  **設定確認**: `docs/aidlc.toml` の `[rules.mcp_review]` セクションを確認
  - `mode = "required"`: MCP利用可能時はレビュー必須。利用不可時は警告表示
  - `mode = "recommend"`: MCP利用可能時は以下の推奨を表示（デフォルト）
  - `mode = "disabled"`: 何も表示しない

  **推奨メッセージ**（mode = "recommend" かつ MCP利用可能時）:
  ...
```

### 問題点

1. **強制力が弱い**: 「設定に応じて」という柔らかい表現
2. **具体的な処理フローがない**: mode=required時の処理手順が明確でない
3. **MCP利用不可時の対応が不明確**: 警告表示後の処理フローが記載されていない
4. **自動実行の仕組みがない**: AIレビューを「先に」実行する明示的なルールがない

## 改善方針

### 1. MCPレビューセクションの強化

現在の「MCPレビュー【設定に応じて】」を「AIレビュー優先ルール【重要】」に変更し、以下を明確化:

- mode=required時の強制実行フロー
- MCP利用不可時の警告・確認フロー
- AIレビュー結果の修正反映フロー
- 人間承認前のAIレビュー自動実行

### 2. 変更対象ファイル

| ファイル | 変更箇所 |
|---------|---------|
| `prompts/package/prompts/inception.md` | MCPレビューセクション（119行目付近） |
| `prompts/package/prompts/construction.md` | MCPレビューセクション（181行目付近） |
| `prompts/package/prompts/operations.md` | MCPレビューセクション（121行目付近） |

### 3. 新しいルール内容（各フェーズ共通）

```markdown
- **AIレビュー優先ルール【重要】**: 人間に承認を求める前に、必ずAIレビューを実行する。

  **設定確認**: `docs/aidlc.toml` の `[rules.mcp_review]` セクションを確認
  - `mode = "required"`: AIレビュー必須（スキップ不可）
  - `mode = "recommend"`: AIレビュー推奨（スキップ可能）
  - `mode = "disabled"`: AIレビューを行わない

  **処理フロー（mode = "required" または "recommend" の場合）**:

  1. **MCP利用可否チェック**: AI MCP（Codex MCP等）が利用可能か確認

  2. **MCP利用可能時**:
     - AIレビューを実行
     - レビュー結果を確認し、指摘があれば修正を反映
     - 修正後の成果物を人間に提示
     - 人間の承認を求める

  3. **MCP利用不可時**:
     - mode = "required" の場合:
       ```
       【警告】AIレビューが必須設定ですが、MCPが利用できません。

       AIレビューをスキップして人間の承認に進みますか？
       1. はい - 人間承認へ（レビュースキップを履歴に記録）
       2. いいえ - 処理を中断
       ```
     - mode = "recommend" の場合: 直接人間に承認を求める

  **対象タイミング**: [フェーズ固有のタイミングをここに記載]
```

## 実行計画

### Phase 1: 設計

1. **ドメインモデル設計**: このUnitはプロンプト修正のため、ドメインモデルは軽量版
2. **論理設計**: 各プロンプトファイルの変更仕様を定義
3. **設計レビュー**: ユーザー承認

### Phase 2: 実装

1. **コード生成**: 3つのプロンプトファイルを修正
2. **検証**: 修正後のプロンプトでAIレビューが正しく動作することを確認

## リスク・考慮事項

- **後方互換性**: aidlc.tomlのmode設定は変更なし
- **MCP依存**: MCPが利用できない環境でも処理が継続できるようフォールバックを用意

## 関連バックログ

- `bug-ai-review-not-triggered-when-required.md`: このUnitで解決
- `feature-ai-review-before-human-approval.md`: このUnitで解決
