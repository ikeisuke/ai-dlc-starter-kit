# ドメインモデル: worktree機能の改善

## 概要

git worktreeを並列ディレクトリに正しく作成し、AIによる自動作成機能を提供するためのフロー設計。

**重要**: このドメインモデル設計では**コードは書かず**、構造と責務の定義のみを行います。実装はImplementation Phase（コード生成ステップ）で行います。

## 概念モデル

このUnitはプロンプト（マークダウン）の修正であるため、従来のエンティティ設計ではなく、worktree作成に関する概念とフローを定義する。

### Worktree（概念）

- **定義**: 同一リポジトリの別ブランチを別ディレクトリで同時に開くgit機能
- **目的**: 複数サイクルの並行作業を可能にする
- **属性**:
  - パス: worktreeが配置されるディレクトリパス
  - ブランチ: worktreeに紐付くブランチ名
  - 状態: 作成済み / 未作成

### WorktreePath（値オブジェクト）

- **正しいパス形式**: `../[プロジェクト名]-[サイクル名]`
  - 例: `../ai-dlc-starter-kit-v1.5.3`
- **誤ったパス形式**: `[プロジェクト名]-[サイクル名]`（メインディレクトリ内に作成される）
- **不変性**: パスは作成時に決定され、変更不可
- **等価性**: ファイルシステム上の絶対パスで判定

### WorktreeCreationCommand（値オブジェクト）

- **正しいコマンド**:
  ```bash
  # メインディレクトリから実行
  git worktree add ../[プロジェクト名]-{{CYCLE}} cycle/{{CYCLE}}
  ```
- **誤ったコマンド**（非推奨）:
  ```bash
  # git -C を使用すると相対パスがリポジトリ基準になる
  git -C [プロジェクト名] worktree add [プロジェクト名]-{{CYCLE}} cycle/{{CYCLE}}
  ```

## フロー設計

### WorktreeCreationFlow

AIがworktreeを自動作成するフロー:

1. **事前確認**
   - 現在のディレクトリ名を取得
   - 親ディレクトリの書き込み権限を確認
   - 既存worktreeの有無を確認

2. **作成実行**
   - `git worktree add ../[プロジェクト名]-{{CYCLE}} cycle/{{CYCLE}}` を実行
   - 成功時: 作成完了メッセージを表示
   - 失敗時: フォールバックへ

3. **フォールバック**
   - 権限エラー: 手動実行コマンドを表示
   - ディスク容量不足: 警告を表示し中断
   - 既存worktree検出: 既存を使用するか確認

### 状態遷移

```
[worktree未選択] → (ユーザーがworktreeを選択)
    ↓
[事前確認中] → (権限・既存worktree確認)
    ↓
[作成実行] → (成功) → [作成完了] → [新ディレクトリへの移動案内]
    ↓ (失敗)
[フォールバック] → [手動実行コマンド表示]
```

## ドメインサービス

### WorktreeCreationService

- **責務**: worktree作成の実行と結果処理
- **操作**:
  - `checkPrerequisites()` - 事前確認（権限、既存worktree）
  - `createWorktree(projectName, cycle)` - worktree作成実行
  - `handleFailure(errorType)` - 失敗時のフォールバック処理

## ユビキタス言語

- **worktree**: git worktree。同一リポジトリの別ブランチを別ディレクトリで開く機能
- **並列ディレクトリ**: メインディレクトリと同階層にある兄弟ディレクトリ
- **メインディレクトリ**: mainブランチをチェックアウトしている元のディレクトリ
- **サイクルブランチ**: `cycle/vX.Y.Z` 形式のブランチ名

## 不明点と質問（設計中に記録）

（なし - バックログの気づきで十分な情報が得られている）
