# 論理設計: AIレビュー機能の強化

## 概要

3つのフェーズプロンプトファイル（inception.md、construction.md、operations.md）の「MCPレビュー」セクションを強化し、AIレビューの自動実行メカニズムを明確化する。

**注**: このUnitはプロンプトファイル（Markdown）の修正であり、実行可能なコードを生成するものではない。

## 変更対象ファイル

| ファイル | 変更箇所 |
|---------|---------|
| `prompts/package/prompts/inception.md` | 119行目付近「MCPレビュー【設定に応じて】」セクション |
| `prompts/package/prompts/construction.md` | 181行目付近「MCPレビュー【設定に応じて】」セクション |
| `prompts/package/prompts/operations.md` | 121行目付近「MCPレビュー【設定に応じて】」セクション |

## 変更仕様

### 共通変更内容

#### 変更前

```markdown
- **MCPレビュー【設定に応じて】**: ユーザーの承認を求める前に、MCPレビューを実施する。

  **設定確認**: `docs/aidlc.toml` の `[rules.mcp_review]` セクションを確認
  - `mode = "required"`: MCP利用可能時はレビュー必須。利用不可時は警告表示
  - `mode = "recommend"`: MCP利用可能時は以下の推奨を表示（デフォルト）
  - `mode = "disabled"`: 何も表示しない

  **推奨メッセージ**（mode = "recommend" かつ MCP利用可能時）:
  ```
  【レビュー推奨】別のAIエージェント（Codex MCP等）が利用可能です。
  品質向上のため、この成果物のレビューを実施することを推奨します。
  レビューを実施しますか？
  ```

  **対象タイミング**: [フェーズ固有のタイミング]
```

#### 変更後

```markdown
- **AIレビュー優先ルール【重要】**: 人間に承認を求める前に、AIレビューを実行する。

  **設定確認**: `docs/aidlc.toml` の `[rules.mcp_review]` セクションを確認
  - `mode = "required"`: AIレビュー必須（スキップには明示的な確認が必要）
  - `mode = "recommend"`: AIレビュー推奨（スキップ可能）
  - `mode = "disabled"`: AIレビューを行わない

  **処理フロー**:

  1. **mode確認**: 設定ファイルからmodeを読み取る
     - `disabled` の場合: 直接人間承認へ
     - `required` または `recommend` の場合: 次のステップへ

  2. **MCP利用可否チェック**: AI MCP（Codex MCP等）が利用可能か確認

  3. **MCP利用可能時**:
     - AIレビューを実行
     - レビュー結果を確認
     - 指摘があれば修正を反映
     - 修正後の成果物を人間に提示
     - 人間の承認を求める

  4. **MCP利用不可時**:
     - `mode = "required"` の場合:
       ```
       【警告】AIレビューが必須設定ですが、AI MCPが利用できません。

       AIレビューをスキップして人間の承認に進みますか？
       1. はい - 人間承認へ進む（レビュースキップを履歴に記録）
       2. いいえ - 処理を中断
       ```
       ユーザーの応答を待ち、「はい」の場合はスキップを履歴に記録して人間承認へ
     - `mode = "recommend"` の場合: 直接人間に承認を求める

  **推奨メッセージ**（mode = "recommend" かつ MCP利用可能時）:
  ```
  【レビュー推奨】AI MCP（Codex MCP等）が利用可能です。
  品質向上のため、この成果物のレビューを実施することを推奨します。
  レビューを実施しますか？
  ```

  **対象タイミング**: [フェーズ固有のタイミング]
```

### フェーズ固有の対象タイミング

| フェーズ | 対象タイミング |
|---------|---------------|
| Inception | Intent承認前、ユーザーストーリー承認前、Unit定義承認前 |
| Construction | 計画ファイル承認前、ドメインモデル設計完了時、論理設計完了時、コード生成後の確認前、テスト完了後の確認前 |
| Operations | デプロイ計画承認前、運用ドキュメント承認前 |

## 非機能要件への対応

### 可用性
- **要件**: MCP利用不可時のフォールバック
- **対応策**: mode=required時でも、ユーザー確認後にスキップ可能とする

### パフォーマンス
- **要件**: MCPの応答速度に依存
- **対応策**: プロンプト側での対応は不要（MCP側の責務）

## 実装上の注意事項

1. **後方互換性**: aidlc.tomlの設定形式は変更しない
2. **履歴記録**: スキップ時は履歴に記録する指示を含める
3. **メタ開発の意識**: `docs/aidlc/` ではなく `prompts/package/` を編集すること

## 不明点と質問

（なし - 仕様は計画とドメインモデルで明確化済み）
