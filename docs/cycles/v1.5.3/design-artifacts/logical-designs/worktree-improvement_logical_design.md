# 論理設計: worktree機能の改善

## 概要

setup.md プロンプトを修正し、正しいworktree作成コマンドとAIによる自動作成フローを実装する。

**重要**: この論理設計では**コードは書かず**、修正箇所と構成の定義のみを行います。具体的なプロンプト文言はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン

プロンプトベースのフロー制御パターンを採用。AIが条件分岐とコマンド実行を担当し、ユーザー確認を挟みながら処理を進める。

## コンポーネント構成

### ファイル構成

```
prompts/
├── setup-prompt.md          # エントリーポイント（修正なし）
└── package/
    └── prompts/
        └── setup.md         # メインの修正対象
```

### 修正対象セクション

#### setup.md

1. **「ステップ3: ブランチ確認」セクション**
   - worktree選択時の処理を追加
   - AI自動作成フローを実装

2. **「補足: git worktree の使用」セクション**
   - 誤ったコマンドを正しいコマンドに置換

## インターフェース設計

### コマンド

#### worktree作成コマンド（正）

```bash
# メインディレクトリから実行
git worktree add ../[プロジェクト名]-{{CYCLE}} cycle/{{CYCLE}}
```

- **パラメータ**:
  - `[プロジェクト名]`: 現在のディレクトリ名（basename で取得）
  - `{{CYCLE}}`: サイクルバージョン（vX.Y.Z形式）
- **戻り値**: 成功時は0、失敗時は非0
- **副作用**: 親ディレクトリに新しいworktreeディレクトリを作成

#### worktree作成コマンド（誤・削除対象）

```bash
# 以下は誤り（削除する）
cd ..
git -C [元のディレクトリ名] worktree add -b cycle/{{CYCLE}} [元のディレクトリ名]-{{CYCLE}}
```

## 処理フロー概要

### worktree選択時の処理フロー（新規追加）

**ステップ**:

1. **現在のディレクトリ情報取得**
   ```bash
   PROJECT_NAME=$(basename "$(pwd)")
   echo "プロジェクト名: ${PROJECT_NAME}"
   ```

2. **既存worktree確認**
   ```bash
   git worktree list | grep "cycle/{{CYCLE}}" && echo "WORKTREE_EXISTS" || echo "WORKTREE_NOT_EXISTS"
   ```

3. **ユーザー確認**
   ```
   以下のworktreeを作成します:
   - パス: ../[PROJECT_NAME]-{{CYCLE}}
   - ブランチ: cycle/{{CYCLE}}

   作成しますか？（Y/n）
   ```

4. **worktree作成実行**
   ```bash
   git worktree add "../${PROJECT_NAME}-{{CYCLE}}" "cycle/{{CYCLE}}"
   ```

5. **結果処理**
   - 成功時: 新ディレクトリへの移動案内を表示
   - 失敗時: フォールバック（手動実行コマンド表示）

**関与するコンポーネント**: setup.md の「ステップ3: ブランチ確認」セクション

### フォールバック処理フロー

**トリガー**: worktree作成コマンドが失敗した場合

**ステップ**:

1. エラーメッセージを表示
2. 手動実行コマンドを表示
   ```
   worktreeの自動作成に失敗しました。
   以下のコマンドを手動で実行してください:

   git worktree add ../[PROJECT_NAME]-{{CYCLE}} cycle/{{CYCLE}}
   ```
3. 新ディレクトリへの移動案内を表示

## 非機能要件（NFR）への対応

### パフォーマンス
- **要件**: git worktree コマンドの実行速度に依存
- **対応策**: 特別な対策不要（git worktree は高速）

### セキュリティ
- **要件**: ファイルシステムへの書き込み権限が必要
- **対応策**: 権限エラー時はフォールバックで手動実行を案内

### 可用性
- **要件**: 権限エラー時のフォールバック処理
- **対応策**: 自動作成失敗時に手動コマンドを提示

## 技術選定
- **言語**: Bash（シェルコマンド）
- **フレームワーク**: なし
- **ライブラリ**: git（標準コマンド）

## 実装上の注意事項

1. **パス指定の注意**:
   - `../` を使用して親ディレクトリを明示的に指定
   - `git -C` は使用しない（相対パスがリポジトリ基準になるため）

2. **ブランチ作成の注意**:
   - ブランチが既に存在する場合は `-b` オプションを使わない
   - `git worktree add` は既存ブランチにも対応

3. **既存worktreeの検出**:
   - `git worktree list` で既存worktreeを確認
   - 既に存在する場合は既存を使用するか確認

## 修正箇所の詳細

### 1. 「ステップ3: ブランチ確認」の worktree 選択時処理

**現状**: worktree選択時は「補足」セクションへの誘導のみ

**変更後**: AI自動作成フローを追加

```markdown
- **worktree を選択**:
  1. 現在のディレクトリ名を取得
  2. worktree作成コマンドを提示
  3. ユーザー確認後、自動作成を実行
  4. 成功時: 新ディレクトリへの移動案内
  5. 失敗時: 手動実行コマンドを表示
```

### 2. 「補足: git worktree の使用」セクション

**現状**:
```bash
cd ..
git -C [元のディレクトリ名] worktree add -b cycle/{{CYCLE}} [元のディレクトリ名]-{{CYCLE}}
```

**変更後**:
```bash
# メインディレクトリから実行（親ディレクトリへのcdは不要）
git worktree add ../[プロジェクト名]-{{CYCLE}} cycle/{{CYCLE}}
```

## 不明点と質問（設計中に記録）

（なし - バックログの気づきで十分な情報が得られている）
