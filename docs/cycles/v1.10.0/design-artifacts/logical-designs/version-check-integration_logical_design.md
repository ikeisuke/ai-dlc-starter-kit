# 論理設計: バージョンチェック機能統合

## 概要

`prompts/package/bin/env-info.sh` にバージョン情報出力機能を追加する。スターターキットのバージョンを `version.txt` から取得し、環境情報の一部として出力する。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。

## アーキテクチャパターン

シェルスクリプトのシンプルな関数ベース設計。既存の `env-info.sh` の設計パターン（関数による処理の分離）を踏襲。

## コンポーネント構成

### ファイル構成

```text
prompts/package/bin/
└── env-info.sh          # 修正対象
    ├── check_tool()     # 既存: 汎用ツール確認
    ├── check_gh()       # 既存: gh認証状態確認
    ├── get_project_name()    # 既存: project.name取得
    ├── get_backlog_mode()    # 既存: backlog.mode取得
    ├── get_current_branch()  # 既存: Gitブランチ取得
    ├── get_latest_cycle()    # 既存: 最新サイクル取得
    ├── get_starter_kit_version()  # 【新規追加】
    └── main()           # 修正: 新関数の呼び出し追加
```

### コンポーネント詳細

#### get_starter_kit_version()【新規追加】

- **責務**: `version.txt` からスターターキットのバージョンを取得
- **依存**: なし（標準コマンドのみ使用）
- **公開インターフェース**: 標準出力にバージョン文字列を出力（空値も許容）

#### main()【修正】

- **責務**: 環境情報を順番に出力する
- **変更内容**: `get_starter_kit_version()` の呼び出しを追加

## インターフェース設計

### コマンド

#### env-info.sh

- **パラメータ**: `--setup` (オプション) - 追加情報を出力
- **戻り値**: 終了コード 0
- **出力形式**:

```text
gh:{status}
dasel:{status}
jj:{status}
git:{status}
starter_kit_version:{version}    # 【新規追加】

# --setup オプション時のみ追加
project.name:{name}
backlog.mode:{mode}
current_branch:{branch}
latest_cycle:{cycle}
```

### 新規関数: get_starter_kit_version()

- **パラメータ**: なし
- **戻り値**: 標準出力にバージョン文字列を出力
- **エラーケース**:
  - `version.txt` が存在しない → 空文字列を出力
  - ファイルが空 → 空文字列を出力
  - ファイル読み取りエラー → 空文字列を出力【AIレビュー指摘対応】

## データモデル概要

### ファイル形式

#### version.txt

- **形式**: プレーンテキスト
- **内容**: セマンティックバージョン（例: `1.9.2`）
- **配置場所**: プロジェクトルート直下

## 処理フロー概要

### バージョン情報取得の処理フロー

**ステップ**:

1. `version.txt` ファイルの存在確認（カレントディレクトリ基準）
2. ファイルが存在すれば内容を読み取り
3. 末尾の改行/CRのみを除去して出力【AIレビュー指摘対応: 正規化の定義を明確化】
4. ファイルが存在しない、空、または読み取りエラーの場合は空文字列を出力

**関与するコンポーネント**: `get_starter_kit_version()`

## 非機能要件（NFR）への対応

### パフォーマンス

- **要件**: スクリプト実行時間への影響を最小限に
- **対応策**: 単純なファイル読み取りのみ。外部コマンド呼び出しを最小化【AIレビュー指摘対応: 具体的なコマンド例を削除し、正規化定義との矛盾を解消】

### セキュリティ

- **要件**: 該当なし
- **対応策**: 入力ファイルはリポジトリ管理下の `version.txt` のみ

### スケーラビリティ

- **要件**: 該当なし
- **対応策**: N/A

### 可用性

- **要件**: 該当なし
- **対応策**: ファイル不存在時も空値を返すことでスクリプト全体の実行を継続

## 技術選定

- **言語**: Bash
- **フレームワーク**: なし
- **ライブラリ**: なし（標準コマンドのみ）
- **データベース**: 該当なし

## 実装上の注意事項

- **パス解決【AIレビュー指摘対応】**: カレントディレクトリ（リポジトリルート）基準で `version.txt` を参照。既存の `get_project_name()` などと同様の方針で一貫性を維持
- **エラーハンドリング【AIレビュー指摘対応】**: `set -euo pipefail` 環境でもスクリプトが終了しないよう、ファイル存在確認 `[[ -f ... ]]` でガードし、読み取り失敗時は `|| echo ""` で空値を返す
- **出力順序**: 既存のツール状態出力の後、`--setup` オプション出力の前に配置
- **ヘルプ更新【AIレビュー指摘対応】**: `show_help()` 関数内の出力例に `starter_kit_version` 行を追加する

## 不明点と質問（設計中に記録）

（なし - 設計方針は明確）
