# 論理設計: Unit 4 Phase 2 - 次サイクルへのタスクリスト管理

## 概要
サイクル横断のバックログを `docs/cycles/backlog.md` と `docs/cycles/backlog_completed.md` で管理する仕組みを構築する。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコード（実装コード等）はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン
二元管理パターン：未対応タスクと完了済みタスクを別ファイルで管理し、サイクル間でタスクを引き継ぐ。

## ファイル構成

### `docs/cycles/backlog.md`
- **役割**: 未対応のタスクを管理
- **操作**: 参照、追記
- **更新タイミング**:
  - Operations Phase完了時に新規タスクを追記
  - タスク対応完了時に該当タスクを削除

### `docs/cycles/backlog_completed.md`
- **役割**: 完了済みタスクの履歴を管理
- **操作**: 追記のみ
- **更新タイミング**: タスク対応完了時に完了したタスクを追記

## コンポーネント構成

### 修正対象ファイル

#### 1. `prompts/setup-prompt.md`
以下の3箇所を修正：

##### 修正1: ディレクトリ構成の作成（line 148-200付近）
バックログファイル用の `.gitkeep` は不要（ファイル自体を作成するため）

##### 修正2: inception.md生成部分（line 260-320付近）
「最初に必ず実行すること」に「バックログ確認ステップ」を追加（ステップ1の前に0.5として挿入）

##### 修正3: operations.md生成部分（line 416-455付近）
「AI-DLCサイクル完了」セクションに「バックログ記録ステップ」を追加

#### 2. `docs/aidlc/templates/` ディレクトリ
新しいテンプレートを追加

## インターフェース設計

### バックログ確認フロー（Inception Phase開始時）

#### 実行タイミング
- サイクル確認完了後
- 追加ルール確認の前（ステップ0.5として挿入）

#### 処理フロー

**ステップ0.5: バックログ確認【重要】**:

1. **バックログファイルの存在確認**
   - コマンド: `ls docs/cycles/backlog.md`
   - 存在しない場合: スキップ（初回セットアップ時）
   - 存在する場合: ステップ2へ

2. **バックログ内容の確認**
   - バックログファイルを読み込む
   - タスクが0件の場合: 「前サイクルからの引き継ぎタスクはありません」と表示してスキップ
   - タスクが存在する場合: ステップ3へ

3. **ユーザーへの提示**
   - メッセージ: 「前サイクルから引き継がれたバックログがあります。内容を確認しますか？」
   - ユーザーが「Yes」の場合: バックログの内容を表示
   - ユーザーが「No」の場合: スキップ

4. **Intent作成への反映**
   - バックログは参考情報として提供
   - ユーザーが新しいIntentやユーザーストーリーを作成する際に、必要に応じてバックログのタスクを組み込む
   - **重要**: バックログの内容を自動的にIntentに含める必要はない

### バックログ記録フロー（Operations Phase完了時）

#### 実行タイミング
- Operations Phaseの全ステップ完了後
- 「AI-DLCサイクル完了」セクション内（ステップ1「フィードバック収集」とステップ2「分析と改善点洗い出し」の後）

#### 処理フロー

**ステップ2.5: バックログ記録【重要】**:

1. **タスクの集約**
   - Operations Phaseで発見した課題、改善点、バグ、機能リクエストを整理
   - ユーザーフィードバックを確認
   - 次サイクル以降で対応を検討すべき項目をリストアップ

2. **バックログへの追記判断**
   - ユーザーに質問: 「次サイクル以降で対応すべきタスクはありますか？」
   - 「Yes」の場合: ステップ3へ
   - 「No」の場合: スキップ

3. **バックログファイルの存在確認**
   - コマンド: `ls docs/cycles/backlog.md`
   - 存在しない場合: テンプレートから新規作成
   - 存在する場合: 既存ファイルに追記

4. **タスクの追記**
   - 各タスクについて以下を記録:
     - タイトル
     - 詳細説明
     - カテゴリ（bug/feature/improvement/refactoring/documentation/technical_debt/other）
     - 優先度（high/medium/low）
     - 記録元サイクル
     - 記録日
   - heredocを使用してbacklog.mdに追記

5. **記録完了**
   - 「バックログに {N} 件のタスクを追加しました」と表示

### タスク完了管理フロー（任意のタイミング）

#### 実行タイミング
- バックログのタスクに対応したユーザーストーリー/Unitが完了した時
- Operations Phase完了前に実施（任意）

#### 処理フロー

**タスク完了時の更新**:

1. **対応したタスクの特定**
   - ユーザーに質問: 「今回のサイクルでバックログのタスクを完了しましたか？」
   - 「Yes」の場合: ステップ2へ
   - 「No」の場合: スキップ

2. **backlog.mdから削除**
   - 完了したタスクをbacklog.mdから削除

3. **backlog_completed.mdに追記**
   - 完了したタスクを以下の情報とともに追記:
     - 元のタスク情報（タイトル、説明、カテゴリ、優先度）
     - 記録元サイクル
     - 完了サイクル
     - 完了日

## データモデル概要

### backlog.md のフォーマット

```markdown
# バックログ

このファイルは、次サイクル以降で対応を検討すべきタスクを管理します。

**重要**: このバックログは参考情報であり、次のサイクルで必ず対応する必要はありません。ビジネス状況や優先度に応じて柔軟に判断してください。

## タスク一覧

### [カテゴリ] タスクタイトル

- **優先度**: high/medium/low
- **カテゴリ**: bug/feature/improvement/refactoring/documentation/technical_debt/other
- **記録元**: v1.0.1
- **記録日**: 2025-11-28

**詳細**:
タスクの詳細説明

---

（以降、同様の形式でタスクを追記）
```

### backlog_completed.md のフォーマット

```markdown
# 完了済みバックログ

このファイルは、バックログから完了したタスクの履歴を管理します。

## 完了タスク一覧

### [カテゴリ] タスクタイトル

- **優先度**: high/medium/low
- **カテゴリ**: bug/feature/improvement/refactoring/documentation/technical_debt/other
- **記録元**: v1.0.1
- **記録日**: 2025-11-28
- **完了サイクル**: v1.0.2
- **完了日**: 2025-12-15

**詳細**:
タスクの詳細説明

---

（以降、同様の形式でタスクを追記）
```

## 処理フロー詳細

### サイクル全体でのバックログ運用

```
[サイクル v1.0.1 開始]
  ↓
[Inception Phase]
  ↓ ステップ0.5: バックログ確認
  ↓ - backlog.md を読み込み
  ↓ - タスクを参考にIntentを作成（任意）
  ↓
[Construction Phase]
  ↓ - バックログのタスクを含むUnitを実装（任意）
  ↓
[Operations Phase]
  ↓ ステップ2.5: バックログ記録
  ↓ - 新しいタスクをbacklog.mdに追記
  ↓
  ↓ 任意: 完了したタスクの移動
  ↓ - backlog.md から削除
  ↓ - backlog_completed.md に追記
  ↓
[サイクル v1.0.1 完了]

[サイクル v1.0.2 開始]
  ↓
[Inception Phase]
  ↓ ステップ0.5: バックログ確認
  ↓ - v1.0.1 で追加されたタスクを確認
  ↓ ...（繰り返し）
```

## 実装上の注意事項

### setup-prompt.md の修正箇所

#### 修正1: inception.md生成部分（line 260付近）

「最初に必ず実行すること」のステップ0（サイクル確認）とステップ1（追加ルール確認）の間に、**ステップ0.5（バックログ確認）**を挿入：

```markdown
  0.5. **バックログ確認【重要】**:
     - このサイクルで参考にすべき前サイクルからの引き継ぎタスクを確認してください
     - **バックログファイルの存在確認**:
       - コマンド: `ls docs/cycles/backlog.md`
       - 存在しない場合: スキップ（初回セットアップ時）
       - 存在する場合: 次のステップへ
     - **バックログ内容の確認**:
       - バックログファイルを読み込む: `cat docs/cycles/backlog.md`
       - タスクが0件の場合: 「前サイクルからの引き継ぎタスクはありません」と表示してスキップ
       - タスクが存在する場合: ユーザーに質問「前サイクルから引き継がれたバックログがあります。内容を確認しますか？」
     - **Intent作成への反映**:
       - バックログは参考情報として提供
       - ユーザーが新しいIntentやユーザーストーリーを作成する際に、必要に応じてバックログのタスクを組み込む
       - **重要**: バックログの内容を自動的にIntentに含める必要はない
```

#### 修正2: operations.md生成部分（line 436付近）

「AI-DLCサイクル完了」セクションのステップ2（分析と改善点洗い出し）とステップ3（次期サイクルの計画）の間に、**ステップ2.5（バックログ記録）**を挿入：

```markdown
  2.5. **バックログ記録【重要】**: 次サイクル以降で対応すべきタスクをバックログに記録
     - **タスクの集約**:
       - Operations Phaseで発見した課題、改善点、バグ、機能リクエストを整理
       - ユーザーフィードバックを確認
       - 次サイクル以降で対応を検討すべき項目をリストアップ
     - **バックログへの追記判断**:
       - ユーザーに質問: 「次サイクル以降で対応すべきタスクはありますか？」
       - 「Yes」の場合: 次のステップへ
       - 「No」の場合: スキップ
     - **バックログファイルの存在確認**:
       - コマンド: `ls docs/cycles/backlog.md`
       - 存在しない場合: テンプレート（`docs/aidlc/templates/backlog_template.md`）から新規作成
       - 存在する場合: 既存ファイルに追記
     - **タスクの追記**:
       - 各タスクについて以下を記録（heredocを使用）:
         - タイトル
         - 詳細説明
         - カテゴリ（bug/feature/improvement/refactoring/documentation/technical_debt/other）
         - 優先度（high/medium/low）
         - 記録元サイクル
         - 記録日（`date '+%Y-%m-%d'` で取得）
     - **任意: 完了タスクの移動**:
       - ユーザーに質問: 「今回のサイクルでバックログのタスクを完了しましたか？」
       - 「Yes」の場合:
         - 完了したタスクを `docs/cycles/backlog.md` から削除
         - 削除したタスクを `docs/cycles/backlog_completed.md` に追記（完了サイクルと完了日を追加）
       - 「No」の場合: スキップ
```

### テンプレートファイル

#### templates/backlog_template.md

初回作成時に使用するテンプレート：

```markdown
# バックログ

このファイルは、次サイクル以降で対応を検討すべきタスクを管理します。

**重要**: このバックログは参考情報であり、次のサイクルで必ず対応する必要はありません。ビジネス状況や優先度に応じて柔軟に判断してください。

## 使い方

### Operations Phase完了時
新しいタスクをこのファイルに追記してください。

### Inception Phase開始時
このファイルを参照し、必要に応じてタスクを新しいIntentやユーザーストーリーに組み込んでください。

### タスク完了時
完了したタスクはこのファイルから削除し、`backlog_completed.md` に移動してください。

## タスク一覧

（タスクがまだありません）
```

#### templates/backlog_completed_template.md

完了済みタスク管理用のテンプレート：

```markdown
# 完了済みバックログ

このファイルは、バックログから完了したタスクの履歴を管理します。

## 完了タスク一覧

（完了したタスクがまだありません）
```

## 非機能要件（NFR）への対応

### 保守性
- **要件**: ファイル構造がシンプルで理解しやすい
- **対応策**:
  - 2つのファイルのみで管理（backlog.md, backlog_completed.md）
  - プレーンなMarkdownで記述

### 可視性
- **要件**: タスクの状態が一目で分かる
- **対応策**:
  - 未対応と完了済みを別ファイルで管理
  - カテゴリと優先度を明記

### 柔軟性
- **要件**: 強制ではなく推奨として運用
- **対応策**:
  - ファイル冒頭に「参考情報」である旨を明記
  - ユーザーが自由に採用・無視できる

### 連続性
- **要件**: サイクル間の情報を引き継ぐ
- **対応策**:
  - サイクルに依存しない場所（docs/cycles/）に配置
  - 記録元サイクルと完了サイクルを明記

## テスト観点

### 初回作成テスト
1. backlog.mdが存在しない状態でOperations Phase完了
   - 期待: テンプレートから新規作成され、タスクが追記される

### 追記テスト
1. backlog.mdが既に存在する状態でOperations Phase完了
   - 期待: 既存内容を維持したまま、新しいタスクが末尾に追記される

### 参照テスト
1. backlog.mdにタスクが存在する状態でInception Phase開始
   - 期待: バックログ内容が表示され、ユーザーが参照できる

### 完了タスク移動テスト
1. backlog.mdのタスクを完了してOperations Phase完了
   - 期待: backlog.mdから削除され、backlog_completed.mdに移動される

## 不明点と質問（設計中に記録）

なし（現時点で不明点なし）
