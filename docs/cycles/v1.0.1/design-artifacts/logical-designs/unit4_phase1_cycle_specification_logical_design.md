# 論理設計: Unit 4 Phase 1 - サイクル指定方法の改善

## 概要
`prompts/setup-prompt.md` を修正し、将来のセットアップ時に生成される各フェーズプロンプト（inception.md, construction.md, operations.md）に「サイクル確認ステップ」を自動的に含めるようにする。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコード（実装コード等）はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン
テンプレート生成パターン：setup-prompt.md が各フェーズプロンプトのテンプレートとして機能し、セットアップ時にプロンプトファイルを生成する。

## 修正対象ファイル

### `prompts/setup-prompt.md`
- **場所**: プロジェクトルート/prompts/setup-prompt.md
- **役割**: AI-DLC環境のセットアップ時に、各フェーズプロンプトファイルを生成する
- **修正内容**: inception.md, construction.md, operations.md の生成指示部分に、「サイクル確認ステップ」を追加する記述を含める

## コンポーネント構成

### 修正箇所の特定

`prompts/setup-prompt.md` 内の以下のセクションを修正：

```
#### 2. プロンプトファイルの作成

`{{AIDLC_ROOT}}/prompts/` 配下に以下を作成：

##### inception.md（Inception Phase専用）
##### construction.md（Construction Phase専用）
##### operations.md（Operations Phase専用）
```

### 追加するコンポーネント：サイクル確認ステップ

各フェーズプロンプトの「最初に必ず実行すること」セクションの**先頭**に、以下の「ステップ0: サイクル確認」を追加する指示を含める。

## インターフェース設計

### サイクル確認ステップの仕様

#### ステップ0: サイクル確認【最重要】

**目的**: ユーザーが作業対象のサイクルを明示的に指定し、誤ったサイクルで作業することを防ぐ

**入力**:
- ユーザーからのCYCLE変数指定（任意）
- CYCLES_ROOTの値（セットアップ時にハードコード済み、例: `docs/cycles`）

**出力**:
- 確定したサイクル名（CYCLE変数）
- サイクルの完全パス（例: `docs/cycles/v1.0.1`）

**処理フロー**:

1. **CYCLE変数の確認**
   - ユーザーが「CYCLE = v1.0.1」のような形で指定しているか確認
   - 指定されている → ステップ3へ
   - 指定されていない → ステップ2へ

2. **既存サイクルの一覧表示と選択**
   - コマンド: `ls -t docs/cycles/ | head -5`
     - `-t`: タイムスタンプ順（新しい順）
     - `head -5`: 最新5件を表示
   - ユーザーに質問: 「どのサイクルで作業しますか？上記から選択するか、新しいサイクル名を指定してください。」
   - ユーザーの回答を待つ
   - 回答を受け取ったらCYCLE変数に設定

3. **サイクルディレクトリの存在確認**
   - コマンド: `ls docs/cycles/{CYCLE}/`
   - 成功（ディレクトリ存在）→ ステップ4へ
   - 失敗（ディレクトリ不存在）→ エラーメッセージ表示:
     - 「サイクル {CYCLE} が存在しません。既存サイクル一覧を表示します。」
     - ステップ2に戻る

4. **確認完了**
   - メッセージ表示: 「サイクル {CYCLE} で作業を開始します。」
   - 以降、すべてのパス参照で `docs/cycles/{CYCLE}/` を使用

**エラーハンドリング**:
- ディレクトリが存在しない場合: 一覧表示に戻る
- ユーザーが無効な入力をした場合: 再度質問

## 処理フロー詳細

### セットアップ時の生成フロー

1. ユーザーが `prompts/setup-prompt.md` を実行
2. setup-prompt.md が `docs/aidlc/prompts/inception.md` を生成
3. inception.md の「最初に必ず実行すること」セクションに「ステップ0: サイクル確認」が含まれる
4. 同様に construction.md, operations.md も生成

### 実行時のサイクル確認フロー

```
[Inception Phase開始]
  ↓
[inception.mdを読み込み]
  ↓
[ステップ0: サイクル確認]
  ↓
CYCLE変数は設定済み？
  ├─ YES → サイクルディレクトリ存在確認
  │           ├─ 存在する → 確認完了、次ステップへ
  │           └─ 存在しない → エラー表示、一覧表示へ
  │
  └─ NO → 既存サイクル一覧表示
            ↓
          ユーザーに選択を促す
            ↓
          サイクル名取得
            ↓
          サイクルディレクトリ存在確認
            ├─ 存在する → 確認完了、次ステップへ
            └─ 存在しない → エラー表示、一覧表示へ
```

## データモデル概要

### CYCLE変数

- **型**: String
- **例**: `v1.0.1`, `v2.0.0`, `2024-12`
- **制約**: ディレクトリ名として有効な文字列
- **スコープ**: 各フェーズプロンプト実行時にユーザーから取得

### CYCLES_ROOT変数

- **型**: String
- **例**: `docs/cycles`
- **制約**: セットアップ時に設定され、プロンプトファイルにハードコード
- **スコープ**: すべてのフェーズプロンプトで共通

## 実装上の注意事項

### setup-prompt.md の修正箇所

以下のセクションを修正：

1. **inception.md 生成部分**（line 254-320付近）
   - 「最初に必ず実行すること」セクションの記述を修正
   - 既存のステップ1-6の前に「ステップ0: サイクル確認」を追加

2. **construction.md 生成部分**（line 322-381付近）
   - 「最初に必ず実行すること（4ステップ）」を「最初に必ず実行すること（5ステップ）」に変更
   - 既存のステップ1-4の前に「ステップ0: サイクル確認」を追加

3. **operations.md 生成部分**（line 383-455付近）
   - 「最初に必ず実行すること（3ステップ）」を「最初に必ず実行すること（4ステップ）」に変更
   - 既存のステップ1-3の前に「ステップ0: サイクル確認」を追加

### サイクル確認ステップのテンプレート

以下の内容を各フェーズプロンプトの「最初に必ず実行すること」セクションの先頭に追加：

```markdown
  0. **サイクル確認【最重要】**:
     - このプロンプトを実行する前に、作業対象のサイクルを確認してください
     - **CYCLE変数が設定されているか確認**:
       - ユーザーから「CYCLE = v1.0.1」のような形で指定されているか確認
     - **CYCLE変数が未設定の場合**:
       1. 既存サイクル一覧を表示: `ls -t {{CYCLES_ROOT}}/ | head -5`
       2. ユーザーに質問: 「どのサイクルで作業しますか？上記から選択するか、新しいサイクル名を指定してください。」
       3. ユーザーの回答を待つ
     - **CYCLE変数が設定されている場合**:
       1. サイクルディレクトリの存在確認: `ls {{CYCLES_ROOT}}/{CYCLE}/`
       2. 存在しない場合: 「サイクル {CYCLE} が存在しません。既存サイクル一覧を表示します。」とエラー表示し、上記の一覧表示に戻る
       3. 存在する場合: 「サイクル {CYCLE} で作業を開始します。」と表示し、そのサイクルで処理を継続
     - **確認完了後**: 以降、すべてのパスで `{{CYCLES_ROOT}}/{CYCLE}/` を使用してください
```

### 既存ステップの番号変更

- inception.md: ステップ1-6 → ステップ1-6（変更なし、ステップ0が追加されるだけ）
- construction.md: ステップ1-4 → ステップ1-4（変更なし、ステップ0が追加されるだけ）
- operations.md: ステップ1-3 → ステップ1-3（変更なし、ステップ0が追加されるだけ）

### 変数置換のルール

setup-prompt.md内では `{{CYCLES_ROOT}}` と `{{CYCLE}}` を使用：
- `{{CYCLES_ROOT}}`: セットアップ時に実際の値（例: `docs/cycles`）に置換される
- `{{CYCLE}}`: そのまま `{CYCLE}` としてプロンプトファイルに記述され、実行時にユーザーが指定

## 非機能要件（NFR）への対応

### ユーザビリティ
- **要件**: ユーザーがサイクルを明確に認識できる
- **対応策**:
  - サイクル一覧を自動表示
  - 明示的な確認ステップを追加
  - エラー時は分かりやすいメッセージを表示

### 保守性
- **要件**: 将来のサイクル追加が容易
- **対応策**:
  - ハードコードを排除
  - 動的にサイクル一覧を取得

### 一貫性
- **要件**: すべてのフェーズで同じサイクル確認フローを適用
- **対応策**:
  - 3つのフェーズプロンプトすべてに同じステップ0を追加
  - setup-prompt.mdで一元管理

## テスト観点

### セットアップテスト
1. setup-prompt.md を実行して inception.md を生成
2. 生成された inception.md に「ステップ0: サイクル確認」が含まれているか確認
3. 同様に construction.md, operations.md も確認

### 実行時テスト
1. CYCLE変数を指定せずにプロンプトを実行
   - 期待: サイクル一覧が表示され、選択を促される
2. CYCLE変数に存在するサイクル名を指定して実行
   - 期待: サイクル確認が成功し、処理が継続
3. CYCLE変数に存在しないサイクル名を指定して実行
   - 期待: エラーメッセージが表示され、一覧表示に戻る

## 不明点と質問（設計中に記録）

なし（現時点で不明点なし）
