# 既存コード分析（v1.0.0 → v1.0.1）

## 分析日時
2025-11-27

## 分析対象
AI-DLC Starter Kit v1.0.0 の構造とバグ

---

## バグ1: 日付コマンド展開問題

### 問題の詳細
実行記録を残す時に日付コマンドが展開されず、コマンド文字列がそのまま残ってしまう。

### 原因箇所の分析
各フェーズプロンプトファイル（inception.md、construction.md、operations.md）において、履歴記録の指示が以下のように記載されている：

- **inception.md:309**: 「日時は `date '+%Y-%m-%d %H:%M:%S'` で取得」
- **construction.md:65**: 「日時は `date '+%Y-%m-%d %H:%M:%S'` で取得」

### 現状確認
`docs/cycles/v1.0.1/history.md` を確認したところ、日時が正しく記録されている（`2025-11-26 23:31:45`）。

### 結論
**このバグは既に修正済みと思われる**。ただし、念のため以下を確認する必要がある：
1. セットアップ時の履歴記録が正しく行われているか
2. 各フェーズでの履歴追記時に正しく日時が展開されるか

### 残存リスク
heredoc内で `date` コマンドを使用する場合、シングルクォート(`'EOF'`)とダブルクォート(`"EOF"`)の使い分けが重要。シングルクォートを使うと変数展開が行われないため、事前に日時を取得する必要がある。

**推奨される修正方法**:
```bash
# 事前に日時を取得
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# heredocで使用
cat <<EOF | tee -a docs/cycles/v1.0.1/history.md
---
## $TIMESTAMP

### フェーズ
[フェーズ名]
...
EOF
```

---

## バグ2: セットアップ時のディレクトリ作成漏れ

### 問題の詳細
セットアップ時点で必要なディレクトリ（inception/、construction/など）が作成されていない。

### 原因箇所の分析
`prompts/setup-prompt.md` 行148-199に以下のディレクトリ構成が記載されている：

```
{{CYCLES_ROOT}}/{{CYCLE}}/
├── plans/
├── requirements/
├── story-artifacts/
│   └── units/
├── design-artifacts/
│   ├── domain-models/
│   ├── logical-designs/
│   └── architecture/
├── construction/
│   └── units/
├── operations/
├── history.md
└── additional-rules.md (オプション)
```

しかし、セットアップ時のディレクトリ作成指示（行179-199）では、以下のディレクトリのみが対象となっている：
- plans/
- requirements/
- story-artifacts/
- story-artifacts/units/
- design-artifacts/
- design-artifacts/domain-models/
- design-artifacts/logical-designs/
- design-artifacts/architecture/
- construction/
- construction/units/
- operations/

**不足しているディレクトリ**:
- **inception/** ← これが作成されていない
- construction/units/ の進捗管理ファイル用ディレクトリ（必要に応じて）

### 現状確認
今回のセッションで、`docs/cycles/v1.0.1/inception/` ディレクトリが存在せず、手動で作成した。

### 結論
**バグ確認：セットアップ時に inception/ ディレクトリが作成されていない**。

### 修正方法
`prompts/setup-prompt.md` 行179-199のディレクトリ作成リストに以下を追加：
- `{{CYCLES_ROOT}}/{{CYCLE}}/inception/`

---

## バージョンアップ手法に関する現在の仕組み

### アップデート検知の仕組み
現在、バージョン管理は以下のファイルで行われている：
- `docs/aidlc/version.txt`: スターターキットのバージョン（1.0.0）

しかし、以下が不足している：
1. **アップデート検知の自動化**: 新しいバージョンがリリースされたことを検知する仕組みがない
2. **差分適用の手順**: 既存プロジェクトに新バージョンの変更を適用する手順が文書化されていない
3. **マイグレーションガイド**: バージョン間の移行手順がない

### 差分更新の仕組み
現在の差分更新の仕組み：
- 各フェーズプロンプトで「既存成果物を確認し、差分のみ更新」と記載されている
- 進捗管理ファイル（progress.md）を使用して、完了済みステップをスキップする仕組みがある

問題点：
1. **テンプレートやプロンプトの動的生成による表記揺れ**: 同じ内容を生成しても、微妙な表現の違いが発生し、差分として認識されてしまう
2. **バージョン管理の粒度**: プロンプトファイルやテンプレートのバージョン管理が不明確

---

## 改善が必要な箇所

### 1. バグ修正
- [x] バグ1（日付展開）: **既に修正済み**（念のため確認推奨）
- [ ] バグ2（inception/ディレクトリ）: `prompts/setup-prompt.md` の修正が必要

### 2. バージョンアップ手法の確立

#### 2.1 アップデート検知
以下の仕組みが必要：
- リモートリポジトリでの最新バージョン確認
- 現在使用中のバージョンとの比較
- アップデート通知

#### 2.2 差分適用手順
以下の文書化が必要：
- バージョンアップ手順書
- ファイル単位の差分適用方法
- ロールバック手順

#### 2.3 表記揺れ問題の解決
以下のアプローチを検討：
- **静的テンプレート化**: 動的生成をやめ、静的なテンプレートファイルを配布
- **ハッシュ値管理**: ファイルのハッシュ値を記録し、内容が実質的に同じかを判定
- **差分表示の改善**: 表記揺れを無視した差分表示ツールの導入

---

## 次のステップ

### Inception Phaseで実施すること
1. ユーザーストーリー作成: バグ修正とバージョンアップ手法確立のストーリー
2. Unit定義: 以下のUnitに分解
   - Unit 1: セットアップ時のディレクトリ作成バグ修正
   - Unit 2: 日付展開バグの検証と修正（必要に応じて）
   - Unit 3: バージョンアップ検知の仕組み構築
   - Unit 4: 差分適用手順の文書化
   - Unit 5: 表記揺れ問題の解決策実装

### Construction Phaseで実施すること
各Unitの設計と実装

---

## 備考
- 既存のv1.0.0構造は存在しない（docs/cycles/v1.0.0/が存在しない）
- v1.0.1が初回のサイクルと思われる
- セットアップは既に完了しており、履歴記録も正常に動作している
