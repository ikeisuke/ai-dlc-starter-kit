# 論理設計: フェーズ間連携

## 概要

セットアップで決めた内容をインセプションに引き継ぐ仕組みの詳細設計。

## アーキテクチャ概要

```text
[setup.md]                              [inception.md]
    │                                        │
    │ 1. サイクル作成完了                      │
    │                                        │
    ▼                                        │
┌─────────────────────────┐                  │
│ setup-context.md 生成   │                  │
│ (requirements/ に保存)  │                  │
└─────────────────────────┘                  │
    │                                        │
    │ 2. インセプション開始                    │
    │                                        │
    ▼                                        ▼
┌─────────────────────────────────────────────────┐
│ setup-context.md の読み込み                       │
│ - 存在確認                                       │
│ - 決定事項を「確認済み」として扱う                  │
│ - 重複質問を回避                                  │
└─────────────────────────────────────────────────┘
```

## ファイル構造

### setup-context.md

**保存先**: `docs/cycles/{{CYCLE}}/requirements/setup-context.md`

**構造**:

```markdown
# セットアップコンテキスト

## 決定事項

- **サイクル名**: {{CYCLE}}
- **対象Issue**: #XX, #YY, ...（または「なし」）
- **スコープ概要**: [スコープの要約]

## 確認済み質問

[セットアップ中にユーザーに確認した質問と回答]

- **Q**: [質問1]
- **A**: [回答1]

## インセプションへの引継ぎ事項

[追加で確認が必要な事項があればここに記載、なければ「なし」]
```

## 変更箇所詳細

### 1. setup.md の変更

**場所**: 「完了時の作業」セクション、「1. Gitコミット（任意）」の前に新規ステップ追加

**追加内容**:

```markdown
### 0. セットアップコンテキスト生成【自動】

サイクル作成完了後、セットアップコンテキストを自動生成します。

**生成処理**:

1. **ファイル存在確認**:
   ```bash
   [ -f "docs/cycles/{{CYCLE}}/requirements/setup-context.md" ] && echo "EXISTS" || echo "NOT_EXISTS"
   ```

2. **NOT_EXISTS の場合のみ生成**:

   以下の情報を収集してファイルを作成:

   - **サイクル名**: 現在のサイクル（{{CYCLE}}）
   - **対象Issue**: ステップ5で選択したIssue（存在する場合）
   - **スコープ概要**: バージョン選択時の説明（メジャー/マイナー/パッチ等）
   - **確認済み質問**: セットアップ中にユーザーに確認した質問と回答

   テンプレート: `prompts/package/templates/setup_context_template.md`
   （rsync後は `docs/aidlc/templates/setup_context_template.md` として参照可能）

3. **EXISTS の場合**: スキップ（既存ファイルを保持）
```

### 2. inception.md の変更

**場所**: 「最初に必ず実行すること（9ステップ）」セクション、「### 3. 追加ルール確認」の後に新規ステップ追加

**追加内容**:

```markdown
### 3.5 セットアップコンテキスト確認

セットアップで決定した内容を確認し、重複質問を回避します。

**ファイル確認**:
```bash
[ -f "docs/cycles/{{CYCLE}}/requirements/setup-context.md" ] && echo "CONTEXT_EXISTS" || echo "CONTEXT_NOT_EXISTS"
```

**判定**:

- **CONTEXT_NOT_EXISTS**: 次のステップへ進行（従来通りのフローを実行）

- **CONTEXT_EXISTS**: 以下を実行

  1. **ファイル読み込み**: setup-context.md を読み込む

  2. **内容表示**:
     ```text
     【セットアップコンテキスト確認】

     セットアップで以下の内容が決定されています：

     [setup-context.md の内容を表示]

     この内容を前提として進めます。変更が必要な場合はお知らせください。
     ```

  3. **変数設定（内部）**:

     **判定ルール（「記載されている」の定義）**:
     - 「なし」「-」「未定」「N/A」という値は「未設定」として扱う
     - 空文字・空白のみも「未設定」として扱う
     - 上記以外の値がある場合は「設定済み」として扱う

     **変数設定**:
     - `SETUP_ISSUES_CONFIRMED = true`（対象Issueに `#` で始まるIssue番号が含まれる場合）
     - `SETUP_SCOPE_CONFIRMED = true`（スコープ概要が設定済みの場合）

  4. **後続ステップへの影響**:
     - ステップ5（GitHub Issue確認）: `SETUP_ISSUES_CONFIRMED = true` の場合、「セットアップで選択済みのIssueがあります」と表示し、追加選択のみ提案
     - ステップ1（Intent明確化）: 確認済み質問の内容を考慮して重複質問を回避

  5. **重複質問回避のロジック**:

     **対象範囲**: セットアップ中のすべてのQ&Aを対象とする

     **質問カテゴリの定義**:

     | カテゴリ | 説明 | setup-context.md での対応項目 | 判定キーワード例 |
     |---------|------|------------------------------|-----------------|
     | cycle | サイクル名・バージョン | サイクル名 | バージョン, vX.X.X, サイクル |
     | issues | 対象Issue番号 | 対象Issue | Issue, #番号, チケット |
     | scope | 機能範囲・優先度・変更規模 | スコープ概要 | スコープ, 範囲, メジャー/マイナー/パッチ |
     | constraints | 制約・前提条件 | 確認済み質問 | 制約, 前提, 条件, 制限 |
     | stakeholders | 関係者・承認者 | 確認済み質問 | 担当, レビュアー, 承認者 |

     **カテゴリ判定の手順**:
     1. Q/Aのテキストに判定キーワードが含まれるか確認
     2. キーワードが見つかった場合、該当カテゴリに分類
     3. 複数カテゴリに該当する場合、最初にマッチしたカテゴリを採用
     4. キーワードが見つからない場合、`constraints`（汎用）として扱う

     **重複判定の定義**:
     - **同一カテゴリ**内で**同一の決定事項**が得られている場合は再質問しない
     - **一致条件**: 要約レベルの一致（完全一致は不要、同じ意味・意図であれば一致とみなす）
     - 未設定扱い（「なし」「-」「未定」「N/A」「空白」）の場合は再質問する

     **例外条件**（再質問が許可されるケース）:
     - ユーザーが明示的に変更を要求した場合
     - 確認済み情報に矛盾がある場合
     - 追加情報が必要な場合（確認済み情報の深掘り）

     **優先度ルール**:
     - setup-context.md が存在する場合、それを**最優先の情報源**として扱う
     - 同一内容については後続の質問を抑制する

     **ログ/説明文**:
     - 質問を省略した場合、以下の形式でユーザーに通知:
       ```text
       【確認済み情報の活用】
       セットアップで「{カテゴリ}」について確認済みのため、質問を省略しました。
       変更が必要な場合はお知らせください。
       ```

     **確認済み質問のフォーマット**:
     - 推奨形式: `- **Q**: [質問] - **A**: [回答]`
     - フォーマットが不正な場合（Q/Aペアが不明確）: その項目はスキップし、再質問を許可
     - 部分的に読み取れる場合: 読み取れた情報のみを活用

     **実装方法**:
     - AIは setup-context.md の内容を内部コンテキストとして保持
     - Intent明確化の質問前に、確認済み情報と照らし合わせる
     - 既に回答がある情報は質問せず、その情報を前提として進める
```

### 3. テンプレートファイル新規作成

**パス**: `prompts/package/templates/setup_context_template.md`

**内容**:

```markdown
# セットアップコンテキスト

## 決定事項

- **サイクル名**: {{CYCLE}}
- **対象Issue**: {{TARGET_ISSUES}}
- **スコープ概要**: {{SCOPE_SUMMARY}}

## 確認済み質問

{{CONFIRMED_QUESTIONS}}

## インセプションへの引継ぎ事項

{{ADDITIONAL_NOTES}}
```

## 生成元データの扱い

### データ出所と未設定時の扱い

| 項目 | データ出所 | 未設定時の扱い |
|------|-----------|--------------|
| サイクル名 | 現在のサイクル（必ず存在） | N/A（必須） |
| 対象Issue | ステップ5で選択したIssue | 「なし」と記載 |
| スコープ概要 | バージョン選択時の説明 | 「なし」と記載 |
| 確認済み質問 | セットアップ中のQ&A | セクション省略可 |
| 引継ぎ事項 | AIが必要と判断した事項 | 「なし」と記載 |

**注意**: 「バージョン選択時の説明」は、ステップ7でユーザーがパッチ/マイナー/メジャーを選択した際の文脈から取得する。選択がなかった場合（ブランチから自動検出等）は「なし」とする。

## 後方互換性

| シナリオ | 動作 |
|---------|------|
| setup-context.md が存在しない | 従来通りのフローを実行（影響なし） |
| setup-context.md の一部項目が空 | 空の項目については従来通り質問 |
| 古いバージョンのセットアップを使用 | setup-context.md が生成されないため、インセプションは従来通り動作 |

## エラーハンドリング

| エラー | 対処 |
|--------|------|
| setup-context.md の読み込み失敗 | 警告を表示し、従来フローにフォールバック |
| setup-context.md のフォーマット不正 | 警告を表示し、従来フローにフォールバック |

## テスト観点

1. **正常系**:
   - セットアップ完了時にsetup-context.mdが生成される
   - インセプション開始時にsetup-context.mdが読み込まれる
   - 確認済み質問が重複して質問されない

2. **異常系**:
   - setup-context.mdが存在しない場合、従来フローで動作
   - setup-context.mdの内容が不完全な場合、不足部分のみ質問

3. **後方互換性**:
   - 旧バージョンのセットアップを使用した場合、インセプションが正常動作
