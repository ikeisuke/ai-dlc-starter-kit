# Unit完了条件明確化 - 論理設計

## 概要

Unit開始時に完了条件を明示的に提示し、Unit終了時にその達成状況を確認するフローを `construction.md` に追加する。

## 変更対象

- `prompts/package/prompts/construction.md`

## 設計詳細

### 1. Unit開始時フロー（セクション 5 に統合）

**挿入位置**: 「5. 実行前確認」セクションを「5. 実行前確認と完了条件の提示」に拡張

**処理フロー**:

```text
[Unit定義ファイル読み込み]
       ↓
[「責務」セクションの箇条書き項目を抽出]
       ↓
[「関連Issue」があればIssueから受け入れ基準を抽出（オプション）]
       ↓
[チェックリスト形式で整理]
       ↓
[計画ファイルに「完了条件チェックリスト」セクションとして記録]
       ↓
[ユーザーに提示]
       ↓
[ユーザーの確認を得る（「この条件でよろしいですか？」）]
       ↓
[確認後、実装を開始]
```

**完了条件の抽出ルール**:

| 抽出元 | 抽出対象 | 必須/オプション |
|--------|---------|---------------|
| Unit定義「責務」セクション | 箇条書き項目をそのまま使用 | 必須 |
| Unit定義「関連Issue」 | Issueの受け入れ基準（あれば） | オプション |

- 「責務」セクションがない場合: Unit定義の「概要」から主要な成果物を1〜3項目抽出
- 重複する条件は統合してひとつにまとめる

**計画ファイルの命名規則**:

`unit-{NNN}-plan.md`（NNN = Unit番号、例: `unit-012-plan.md`）

- Unit定義ファイル（`{NNN}-{unit-name}.md`）と番号で1対1対応
- 計画ファイルは `docs/cycles/{{CYCLE}}/plans/` に配置

**出力フォーマット**（テンプレート例）:

```markdown
**完了条件チェックリスト**:
- [ ] [責務の項目1]
- [ ] [責務の項目2]
- [ ] [Issueの受け入れ基準]（該当Issueがある場合）

この条件を満たした時点でUnitを完了とします。
```

### 2. Unit終了時フロー（「事前確認」ステップとして追加）

**挿入位置**: 「Unit完了時の必須作業」セクションの先頭（既存の「1. Unit定義ファイルの〜」の前に「0. 完了条件の確認」として追加）

**処理フロー**:

```text
[計画ファイル（unit-{NNN}-plan.md）を読み込み]
       ↓
[「完了条件チェックリスト」セクションを取得]
       ↓
[チェックリストがない場合 → 警告を表示してスキップ]
       ↓
[各条件の達成状況をAIが確認]
       ↓
[確認結果をユーザーに提示]
       ↓
[すべて達成?]
   ├─ Yes → 次のステップへ
   └─ No → 未達成の理由を説明
              ↓
        [ユーザーに確認: 「未達成のまま完了としますか？」]
           ├─ 承認 → 履歴に「未達成で完了」を記録し、次のステップへ
           └─ 拒否 → 作業継続を促す（Unit完了処理を中断）
```

**出力フォーマット**:

```markdown
**完了条件の確認結果**:
- [x] [条件1] - 達成
- [x] [条件2] - 達成
- [ ] [条件3] - 未達成（理由: [具体的な理由]）

**判定**: すべて達成 / 未達成項目あり
```

**未達成で完了する場合の履歴記録**:

```markdown
### 完了条件の例外承認
- **未達成項目**: [項目名]
- **理由**: [ユーザーが承認した理由]
- **日時**: YYYY-MM-DD HH:MM:SS
```

### 3. 計画ファイルテンプレートへの反映

計画ファイルに以下のセクションを標準で含めるようにする:

```markdown
## 完了条件チェックリスト

Unit定義から抽出した完了条件：

- [ ] [責務の項目1]
- [ ] [責務の項目2]
- [ ] ...
```

**注意**: チェックリストは計画作成時に記録し、Unit終了時は読み取り専用として参照する（チェック状態の更新は行わず、確認結果を別途表示する）。

## インターフェース

### 入力

- Unit定義ファイル（`docs/cycles/{{CYCLE}}/story-artifacts/units/{NNN}-{unit-name}.md`）
  - 「責務」セクション（箇条書き項目）
  - 「関連Issue」セクション（オプション）
- 計画ファイル（`docs/cycles/{{CYCLE}}/plans/unit-{NNN}-plan.md`）
  - 「完了条件チェックリスト」セクション

### 出力

- ユーザーへの完了条件提示（Unit開始時）
- 完了条件の達成状況確認結果（Unit終了時）

## 後方互換性

- 既存の「5. 実行前確認」を拡張し、完了条件の提示を統合
- 完了条件チェックリストがない既存の計画ファイル: 警告を表示して確認ステップをスキップ
- Unit定義に「責務」セクションがない場合: 「概要」から主要な成果物を抽出
- 「関連Issue」セクションがない場合: Issueからの抽出をスキップ

## テスト観点

1. Unit開始時に完了条件が正しく抽出・提示されること
2. 計画ファイルに完了条件チェックリストが記録されること
3. 計画と完了条件が一括で承認されること
4. Unit終了時に完了条件の達成状況が確認されること
5. 未達成項目がある場合にユーザー確認が求められること
6. 未達成で承認された場合に履歴に記録されること
7. 既存の計画ファイル（チェックリストなし）で警告が表示されスキップされること
8. Unit定義に「責務」がない場合に「概要」から抽出されること
