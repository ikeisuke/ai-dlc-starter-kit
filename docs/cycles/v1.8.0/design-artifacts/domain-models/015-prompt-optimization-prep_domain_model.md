# ドメインモデル設計: プロンプト最適化準備

## 対象Unit

- **Unit番号**: 015
- **Unit名**: プロンプト最適化準備
- **関連Issue**: #45

## 分析対象

| ファイル | 行数 | 文字数 |
|----------|------|--------|
| setup.md | 802 | 27,610 |
| inception.md | 1,032 | 41,359 |
| construction.md | 907 | 36,427 |
| operations.md | 1,097 | 42,036 |
| AGENTS.md | 226 | 8,061 |
| CLAUDE.md | 35 | 1,499 |
| **合計** | **4,099** | **156,992** |

## 問題箇所の分類

### 1. 完全重複

同一内容が複数ファイルに繰り返されている箇所。

| セクション | 影響ファイル | 推定重複行数 |
|------------|--------------|--------------|
| AI-DLC手法の要約 | setup, inception, construction, operations | 18行 × 4 = 72行 |
| 人間の承認プロセス【重要】 | inception, construction, operations | 5行 × 3 = 15行 |
| 質問と回答の記録【重要】 | inception, construction, operations | 2行 × 3 = 6行 |
| 予想禁止・一問一答質問ルール | inception, construction, operations | 20行 × 3 = 60行 |
| Gitコミットのタイミング【必須】 | inception, construction, operations | 7行 × 3 = 21行 |
| jjサポート設定 | setup, inception, construction, operations | 3行 × 4 = 12行 |
| AIレビュー優先ルール【重要】 | inception, construction, operations | 80行 × 3 = 240行 |
| 外部入力検証ルール【重要】 | inception, construction, operations | 30行 × 3 = 90行 |
| コンテキストリセット対応【重要】 | inception, construction, operations | 25行 × 3 = 75行 |
| フェーズの責務分離 | inception, construction, operations | 4行 × 3 = 12行 |
| 進捗管理と冪等性 | inception, construction, operations | 4行 × 3 = 12行 |

**推定総重複行数**: 約615行

### 2. 類似（微差あり）

基本構造は同じだが、フェーズ固有の値が異なる箇所。

| セクション | 差分内容 |
|------------|----------|
| プロンプト履歴管理 | 履歴ファイルのパスが異なる |
| テンプレート参照 | 参照先は同じだが記述位置が異なる |
| dasel/gh確認bashコード | 同一パターンだが変数名が異なる場合あり |

### 3. 冗長

簡潔に書き直せる指示。

| 箇所 | 現状 | 問題点 |
|------|------|--------|
| dasel未インストール時の説明 | 毎回「dasel未インストールの場合: AIは...を読み込み...」 | パターン化して1箇所で定義可能 |
| GitHub CLI確認コード | if command -v gh... パターンが繰り返し | スクリプト化済みだが参照されていない箇所あり |
| バックログモード確認 | 同じbashコードブロックが5箇所以上 | bin/check-backlog-mode.sh等にスクリプト化可能 |

### 4. 削除候補

不要または古い指示。

| 箇所 | 理由 |
|------|------|
| progress.md関連の後方互換性説明 | Unit定義ファイルに移行済み、旧形式はv1.6.0以前 |
| 旧形式バックログ移行（setup.md） | 十分な期間が経過、削除可能 |

### 5. 統合候補

まとめられる指示。

| 統合対象 | 統合方法 |
|----------|----------|
| 共通開発ルール | `common-rules.md`に切り出し、各プロンプトから参照 |
| AIレビューフロー | `ai-review-flow.md`に切り出し、プロンプトには概要のみ |
| 設定確認bashコード群 | `bin/`配下のスクリプトに統合、プロンプトはスクリプト呼び出しのみ |

## エンティティ定義

### PromptFile（プロンプトファイル）

- **属性**:
  - path: ファイルパス
  - lineCount: 行数
  - charCount: 文字数
  - sections: セクション一覧

### Section（セクション）

- **属性**:
  - name: セクション名
  - content: 内容
  - isDuplicate: 他ファイルと重複しているか
  - duplicateFiles: 重複しているファイル一覧

### Issue（改善項目）

- **種類**:
  - duplicate: 完全重複
  - similar: 類似（微差あり）
  - verbose: 冗長
  - obsolete: 削除候補
  - mergeable: 統合候補
- **属性**:
  - description: 説明
  - affectedFiles: 影響ファイル
  - estimatedSavings: 削減見込み（行数）
  - priority: 優先度（高/中/低）
  - recommendedAction: 推奨アクション

## 影響範囲の推定

### 最適化実施時の削減見込み

| 施策 | 削減見込み |
|------|-----------|
| AI-DLC手法の要約を1箇所に集約 | 約54行（18行 × 3ファイル） |
| 共通開発ルールの外部化 | 約200行（各ファイル約65行の重複） |
| AIレビューフローの外部化 | 約160行（80行 × 2ファイル） |
| 設定確認コードのスクリプト化 | 約100行 |
| **合計** | **約514行（約12%削減）** |

## 次サイクルへの引継ぎ事項

1. **最適化の実施判断**: 実際の最適化は次サイクルで実施（このUnitはプリアナリシスのみ）
2. **優先順位付け**: AIレビューフローの外部化を最優先（最大の重複箇所）
3. **後方互換性**: 既存ユーザーへの影響を考慮した段階的移行
4. **テスト**: 最適化後のプロンプト動作確認方法の検討
