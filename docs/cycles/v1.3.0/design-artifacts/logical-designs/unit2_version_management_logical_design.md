# Unit 2: バージョン管理改善 - 論理設計

## 概要

ドメインモデルに基づき、具体的な修正内容と手順を設計する。

---

## US-2: Operations Phase のバージョン更新修正

### 修正対象

`prompts/setup-init.md` のセクション 6.3

### 現状の問題

セクション 6.3 の `sed` コマンドは、`starter_kit_version` フィールドが存在する場合のみ更新される。
古いプロジェクトや移行プロジェクトでフィールドが存在しない場合、更新が行われない。

### 修正内容

セクション 6.3 を以下のように改善：
1. `starter_kit_version` が存在しない場合は追加する処理
2. 更新後に正しく反映されたことを確認する手順

---

## US-3: 初回セットアップ時のバージョン提案改善

### 修正対象

`prompts/setup-init.md` のセクション「8. サイクル開始処理」

### 修正内容

「8.1 サイクルバージョンの確認」の前に、プロジェクトバージョン調査ステップを追加する。

#### 追加セクション: 8.0 プロジェクトバージョンの調査【初回のみ】

以下の手順を記述：

1. **調査対象ファイルの列挙**: package.json、pyproject.toml、Cargo.toml 等、一般的なバージョン情報源を優先順位付きでリスト
2. **調査の実行**: 各ファイルの存在確認と、存在する場合はバージョン情報の抽出
3. **結果に応じた分岐**:
   - バージョンが検出された場合：検出したバージョンをサイクルバージョンの初期値として提案し、ユーザーに確認
   - バージョンが検出されなかった場合：8.1 の既存フローにフォールバック

---

## 修正ファイル一覧

| ファイル | 修正種別 | 内容 |
|----------|----------|------|
| `prompts/setup-init.md` | 修正 | セクション 6.3 を改善（存在しない場合の追加処理、確認手順） |
| `prompts/setup-init.md` | 追加 | セクション 8.0 を追加（プロジェクトバージョン調査） |

---

## 受け入れ基準との対応

### US-2

| 受け入れ基準 | 対応 |
|--------------|------|
| version.txt更新時にaidlc.tomlも同時に更新される手順が明確である | セクション 6.3 で手順を改善（存在しない場合も対応） |
| アップグレード検出ロジックが正しく動作する | starter_kit_version が確実に更新されることを保証 |
| バージョン更新手順がドキュメント化されている | セクション 6.3 に確認手順を追加 |

### US-3

| 受け入れ基準 | 対応 |
|--------------|------|
| package.json、pyproject.toml等のバージョン情報を調査する手順が追加されている | セクション 8.0 で調査ステップを追加 |
| 既存バージョンがある場合、それを考慮した提案がされる | 検出時の提案フローを追加 |
