# 既存コード分析

## サイクル
v1.2.3

---

## 分析対象ファイル

| 問題 | 関連ファイル |
|------|-------------|
| 1. Lite版パス解決 | `docs/aidlc/prompts/lite/*.md` |
| 2. フェーズ遷移ガードレール | `prompts/setup-cycle.md`, `docs/aidlc/prompts/*.md` |
| 3. starter_kit_version | `prompts/setup-init.md`, `prompts/setup-prompt.md` |
| 4. 移行時ファイル削除確認 | `prompts/setup-init.md` |
| 5. 日時記録 | `docs/aidlc/prompts/*.md` |

---

## 問題1: Lite版プロンプトのパス解決が不安定

### 現状
- Lite版プロンプト（lite/inception.md:10-14）にパス説明あり
- 「注意」として追記されているだけで、具体例が不足
- 「Full版を先に読む」構造がコンテキストを複雑化

### 根本原因
サイクルディレクトリ構造の具体的な説明がない。`{{CYCLE}}` の置換後のパス例がないため、AIが推測で探す。

### 修正方針
1. Lite版プロンプトの冒頭に「パス解決ガイド」セクションを追加
2. 具体的なパス例を明示（例: `docs/cycles/v1.2.3/construction/progress.md`）
3. 「まずprogress.mdのパスを確認」を最初のステップとして強調

---

## 問題2: フェーズ遷移のガードレールが不足

### 現状
- setup-cycle.md の完了メッセージでInception Phaseへの誘導あり
- 各プロンプトに「承認なしで次のステップを開始してはいけない」の記述あり
- しかし「このフェーズでは実装しない」等の明示的禁止事項がない

### 根本原因
フェーズごとの「許可されるアクション」と「禁止されるアクション」が明確でない。

### 修正方針
1. **setup-cycle.md**: 完了メッセージに「Inception Phase で計画を立ててから実装すること」を追加
2. **inception.md**: 「フェーズの責務【重要】」セクションを追加
   - 「このフェーズでは実装コードを書かない」
   - 「承認なしにConstruction Phaseに進まない」
3. **construction.md**: 「Phase 1（設計）ではコードを書かない」を強調
4. 各プロンプトに「禁止事項」セクションを追加

---

## 問題3: aidlc.toml に starter_kit_version フィールドがない

### 現状
- setup-prompt.md:44 で `starter_kit_version` フィールドを grep で検索
- setup-init.md:82-87 でコメントとして記載（`# スターターキットバージョン: X.X.X`）
- 正式なTOMLフィールドではないため、grep がマッチしない

### 根本原因
setup-init.md の aidlc.toml 生成テンプレート（セクション6）に正式なフィールドがない。

### 修正方針
1. **setup-init.md**: セクション6のテンプレートに `starter_kit_version = "X.X.X"` フィールドを追加
2. コメント行（`# スターターキットバージョン:`）を削除し、フィールドに統一
3. アップグレード時にもフィールドを更新する処理を追加

---

## 問題4: 旧バージョンからの移行時にファイル削除確認がない

### 現状
- setup-init.md:240-267 でrsyncのドライラン確認手順あり
- ただしセクション7.2.1の手順であり、移行モード（セクション3）とは別
- 移行モードでは旧ファイルの処理はあるが、rsyncの削除確認が漏れる可能性

### 根本原因
setup-prompt.md の「補足: 後方互換性」（:120-130）で旧形式判定後、setup-init.md に移動するが、移行モードのフローでrsync削除確認が明示されていない。

### 修正方針
1. **setup-init.md**: セクション7.2.1の前に「移行モードでの注意」を追加
2. 移行モード時も必ずrsyncドライランを実行し、削除対象をユーザーに確認
3. `.gitkeep` 以外の削除対象がある場合は明示的に承認を求める

---

## 問題5: 日時記録時に毎回現在時刻を取得していない

### 現状
- inception.md:61-69, construction.md:61-69, operations.md:63-71 に日時取得方法あり
- 「推奨方法」として記載されており、必須ではない
- AIがセッション開始時の日時をキャッシュして使い回す

### 根本原因
「推奨方法」という弱い表現のため、AIが毎回取得する必要性を認識しない。

### 修正方針
1. 「推奨方法」を「**必須ルール**」に変更
2. 「日時を記録する際は**必ずその時点で** `date` コマンドを実行すること」を強調
3. 「セッション開始時に取得した日時を使い回さない」という禁止事項を追加
4. 各プロンプトの「プロンプト履歴管理」セクションを更新

---

## 問題6: Inception PhaseにConstruction用進捗管理ファイル作成が残っている

### 現状
- inception.md:240-250 にステップ6「Construction用進捗管理ファイル作成」が存在
- v1.2.1で「Construction Phase開始時に自身でprogressファイルを作成するよう変更」したはず
- しかしinception.md側の削除が漏れている

### 根本原因
v1.2.1での対応時にconstruction.md側の修正のみ行い、inception.md側のステップ削除を忘れた。

### 修正方針
1. inception.md からステップ6を削除
2. ステップ一覧を5ステップに修正
3. 完了基準からも「construction/progress.md作成」を削除

---

## 依存関係分析

| 項目 | 依存先 | 備考 |
|------|--------|------|
| 1. Lite版パス解決 | なし | 独立して修正可能 |
| 2. フェーズ遷移ガードレール | なし | 独立して修正可能 |
| 3. starter_kit_version | なし | 独立して修正可能 |
| 4. 移行時ファイル削除確認 | なし | 独立して修正可能 |
| 5. 日時記録 | なし | 独立して修正可能 |
| 6. Inception Phaseステップ6削除 | なし | 独立して修正可能 |

全項目が独立しており、並行作業可能。

---

## 最終更新
**日時**: 2025-12-08
**作成者**: AI（Inception Phase ステップ2）
