# 実装記録: Unit 4 - フェーズプロンプト改修

## 実装日時
2025-12-04

## 作成・変更ファイル

### プロンプトファイル（改修）
- `prompts/setup/common.md` - 変数置換ルールを設定参照ルールに変更
- `prompts/setup/inception.md` - 変数を固定パス/設定参照に変更
- `prompts/setup/construction.md` - 変数を固定パス/設定参照に変更
- `prompts/setup/operations.md` - 変数を固定パス/設定参照に変更

### 設計ドキュメント
- `docs/cycles/v1.2.0/design-artifacts/domain-models/unit4_domain_model.md`
- `docs/cycles/v1.2.0/design-artifacts/logical-designs/unit4_logical_design.md`

### 計画ドキュメント
- `docs/cycles/v1.2.0/plans/unit4_phase_prompt_revision_plan.md`

## 変更内容サマリー

### 削除
- `{{VAR}}` 形式の変数置換ルールセクション
- 変数一覧テーブル（17個の変数）

### 追加
- 「設定参照ルール」セクション
- 「最初に読み込むファイル【必須】」セクション（各フェーズプロンプト）

### 変換マッピング
| 旧変数 | 変換後 |
|--------|--------|
| `{{AIDLC_ROOT}}` | `docs/aidlc`（固定パス） |
| `{{CYCLES_ROOT}}` | `docs/cycles`（固定パス） |
| `{{CYCLE}}` | `{サイクル}`（ユーザー指示） |
| `{{PROJECT_SUMMARY}}` | 「project.tomlから取得」 |
| `{{SETUP_PROMPT_PATH}}` | `prompts/setup-prompt.md` |
| `{{ROLE_INCEPTION}}` | プロダクトマネージャー兼ビジネスアナリスト |
| `{{ROLE_CONSTRUCTION}}` | ソフトウェアアーキテクト兼エンジニア |
| `{{ROLE_OPERATIONS}}` | DevOpsエンジニア兼SRE |

## ビルド結果
N/A（プロンプトファイルのため）

## テスト結果

### 手動テストシナリオ

#### 確認項目 1: 変数置換の完全削除
- [x] `prompts/setup/` 配下に `{{` パターンが存在しないこと
- 結果: 0件（正常）

#### 確認項目 2: 設定参照ルールの追加
- [x] `common.md` に「設定参照ルール【重要】」セクションが存在すること
- [x] 各フェーズプロンプトに「最初に読み込むファイル【必須】」セクションが存在すること

#### 確認項目 3: パス記述の固定化
- [x] `docs/aidlc` が固定パスとして使用されていること
- [x] `docs/cycles` が固定パスとして使用されていること
- [x] `{サイクル}` がユーザー指示を表す表記として使用されていること

## コードレビュー結果
- [x] セキュリティ: OK（ファイル操作のみ、外部入力なし）
- [x] コーディング規約: OK（Markdown形式、日本語）
- [x] エラーハンドリング: OK（互換性対応あり）
- [x] テストカバレッジ: OK（手動テスト項目作成）
- [x] ドキュメント: OK（設計ドキュメント完備）

## 技術的な決定事項

1. **変数の完全廃止**: `{{VAR}}` 形式の変数を完全に廃止し、固定パスまたは設定ファイル参照に変更
2. **プロジェクト設定の読み込み**: 各フェーズプロンプトの冒頭で `project.toml` の読み込みを指示
3. **サイクル表記**: `{サイクル}` をユーザー指示を表す一般的な表記として採用
4. **役割名の固定化**: カスタマイズ需要が低いため固定値として埋め込み

## 課題・改善点

1. **Unit 5 で対応**: プロンプト分割・短縮化
   - 今回の改修でコンテキスト効率は改善されたが、さらなる分割・短縮化が可能

## 状態
**完了**

## 備考
- 既存の `docs/aidlc/prompts/` 配下のファイルは次回セットアップ時に更新される
- 現在の `docs/aidlc/prompts/construction.md` はまだ旧形式（`{{CYCLE}}` 等が含まれる）
- 新しいプロジェクトでセットアップを実行すると、改修版のプロンプトが生成される
