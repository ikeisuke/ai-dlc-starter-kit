# 論理設計: Unit 4 - フェーズプロンプト改修

## 概要
変数置換方式から設定ファイル参照方式への移行における、各ファイルの改修設計を定義する。

**重要**: この論理設計では**コードは書かず**、改修内容とインターフェース定義のみを行います。

---

## ファイル構成

```
prompts/setup/
├── common.md       ← 改修対象（変数置換ルール廃止）
├── inception.md    ← 改修対象（変数→設定参照）
├── construction.md ← 改修対象（変数→設定参照）
└── operations.md   ← 改修対象（変数→設定参照）
```

---

## 改修詳細

### 1. common.md の改修

#### 削除するセクション
- 「変数置換ルール【重要】」セクション全体
  - 表記揺れ防止の原則
  - 置換対象の変数一覧
  - 禁止事項

#### 追加するセクション
```markdown
## 設定参照ルール【重要】

### 設定ファイル
プロジェクト設定は `docs/aidlc/project.toml` に集約されています。
フェーズプロンプトは実行時にこのファイルを読み込んで情報を取得します。

### パス規約
- 共通プロンプト・テンプレート: `docs/aidlc/`
- サイクル固有成果物: `docs/cycles/{サイクル}/`

### サイクルの特定
サイクルはユーザーからの指示で特定します。
例: 「サイクル v1.2.0 の Construction Phase を継続してください」
```

#### 変更するパス記述
- `{{AIDLC_ROOT}}` → `docs/aidlc`
- `{{CYCLES_ROOT}}` → `docs/cycles`
- `{{CYCLE}}` → `{サイクル}`（ユーザー指示を表す）

---

### 2. inception.md の改修

#### 冒頭に追加するセクション
```markdown
## 最初に読み込むファイル【必須】

### 1. プロジェクト設定
`docs/aidlc/project.toml` を読み込む

このファイルから以下の情報を取得:
- プロジェクト名・概要
- 技術スタック
- コーディング規約
- セキュリティ要件

### 2. サイクル特定
ユーザーから指示されたサイクルバージョンに基づいて、
サイクルディレクトリ `docs/cycles/{サイクル}` を特定
```

#### 変数置換マッピング
| 旧 | 新 |
|----|-----|
| `{{AIDLC_ROOT}}` | `docs/aidlc` |
| `{{CYCLES_ROOT}}` | `docs/cycles` |
| `{{CYCLE}}` | `{サイクル}`（ユーザー指示） |
| `{{PROJECT_SUMMARY}}` | 「project.tomlから取得したプロジェクト概要」 |
| `{{SETUP_PROMPT_PATH}}` | `prompts/setup-prompt.md` |
| `{{ROLE_INCEPTION}}` | `プロダクトマネージャー兼ビジネスアナリスト` |

#### 削除する記述
- 「重要: このプロンプトについて」の注意書き（セットアップ時のみ必要）
- プロンプト参照ガイドへのリンク

#### プロジェクト情報セクションの変更
Before:
```markdown
### プロジェクト概要
{{PROJECT_SUMMARY}}
```

After:
```markdown
### プロジェクト概要
project.toml の [project] セクションを参照
```

---

### 3. construction.md の改修

#### 冒頭に追加するセクション
inception.md と同様の「最初に読み込むファイル【必須】」セクション

#### 変数置換マッピング
| 旧 | 新 |
|----|-----|
| `{{AIDLC_ROOT}}` | `docs/aidlc` |
| `{{CYCLES_ROOT}}` | `docs/cycles` |
| `{{CYCLE}}` | `{サイクル}`（ユーザー指示） |
| `{{PROJECT_SUMMARY}}` | 「project.tomlから取得」 |
| `{{SETUP_PROMPT_PATH}}` | `prompts/setup-prompt.md` |
| `{{ROLE_CONSTRUCTION}}` | `ソフトウェアアーキテクト兼エンジニア` |

---

### 4. operations.md の改修

#### 冒頭に追加するセクション
inception.md と同様の「最初に読み込むファイル【必須】」セクション

#### 変数置換マッピング
| 旧 | 新 |
|----|-----|
| `{{AIDLC_ROOT}}` | `docs/aidlc` |
| `{{CYCLES_ROOT}}` | `docs/cycles` |
| `{{CYCLE}}` | `{サイクル}`（ユーザー指示） |
| `{{PROJECT_SUMMARY}}` | 「project.tomlから取得」 |
| `{{SETUP_PROMPT_PATH}}` | `prompts/setup-prompt.md` |
| `{{ROLE_OPERATIONS}}` | `DevOpsエンジニア兼SRE` |

---

## Lite版プロンプトの扱い

各ファイルには Full版 と Lite版 の両方のプロンプトが含まれています。
両方に対して同じ変換を適用します。

---

## 処理フロー概要

### セットアップ時（setup-init.md / setup-cycle.md）
1. ユーザーとの対話でプロジェクト情報を収集
2. `docs/aidlc/project.toml` を生成
3. フェーズプロンプトをそのままコピー（変数置換不要）

### フェーズ実行時（各フェーズプロンプト）
1. AIが `docs/aidlc/project.toml` を読み込み
2. ユーザー指示からサイクルを特定
3. フェーズ処理を実行

---

## 互換性対応

### project.toml が存在しない場合
- 旧バージョンからの移行ケース
- setup-prompt.md で検出し、初回セットアップに誘導（Unit 3 で実装済み）

---

## 非機能要件（NFR）への対応

### メンテナンス性
- 変数置換処理が不要になり、テンプレート管理が簡素化
- フェーズプロンプトの変更が即時反映（置換ミスのリスク解消）

### 信頼性
- AIが設定を文脈として理解するため、置換ミスがなくなる
- パスの固定化により予測可能性が向上

### コンテキスト効率
- プロンプト内のパス記述が簡素化
- 変数一覧テーブルの削除によるトークン節約

---

## テスト観点

### 機能テスト
1. セットアップ時にフェーズプロンプトが正しくコピーされる
2. 各フェーズプロンプトで project.toml の読み込み指示がある
3. パス記述が正しい固定値になっている
4. 役割名が正しい固定値になっている

### 互換性テスト
1. project.toml が存在しない場合に適切に処理される
2. 既存のサイクルディレクトリ構造との互換性

---

## 実装上の注意事項

1. **テンプレート内のコードブロック**: Markdown のコードブロック内の変数も置換対象
2. **Lite版との整合性**: Full版と Lite版で同じ変換を適用
3. **heredoc 内の変数**: history.md への追記コマンド内の変数も置換対象
4. **エスケープ処理**: バッククォート内の変数も正しく置換

---

## 設計判断の記録

| 項目 | 決定 | 理由 |
|------|------|------|
| 「重要」注意書きの削除 | 削除する | セットアップ後は不要、コンテキスト節約 |
| プロジェクト概要の表示方法 | 「project.tomlを参照」と記述 | AIが実際に読み込んで理解するため |
| サイクル表記 | `{サイクル}` | ユーザー指示を表す一般的な表記 |
