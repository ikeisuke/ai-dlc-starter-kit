# テスト記録: v1.2.0 Operations Phase

## セッション情報

| 項目 | 内容 |
|------|------|
| **対象** | v1.2.0 全体 |
| **テスト実施日** | 2025-12-05 |
| **実施者** | ユーザー |
| **環境** | macOS |
| **ステータス** | テスト完了・修正待ち |

---

## テスト項目チェックリスト

### 機能テスト

- [ ] TEST-001: setup-prompt.md の初回セットアップフロー
- [ ] TEST-002: setup-prompt.md のサイクル開始フロー
- [ ] TEST-003: setup-prompt.md のアップグレードフロー

---

## テスト結果詳細

| テストID | 結果 | 実際の結果 | 備考 | バグID |
|----------|------|------------|------|--------|
| TEST-001 | Fail | ユーザーに読み込みを促すメッセージが表示され、自動で読み込まれない | AI-DLC原則「会話の反転」に反する | BUG-001 |
| TEST-001 | Fail | デフォルト値があっても入力を要求される | UX改善が必要 | BUG-002 |

---

## バグレポート

### BUG-001: setup-prompt.md が次のファイルを自動で読み込まない

| 項目 | 内容 |
|------|------|
| **重大度** | Medium |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**再現手順**:
1. setup-prompt.md を読み込む
2. 初回セットアップのケース（project.toml が存在しない）で実行
3. 「setup-init.md を読み込んでください」というメッセージが表示される

**期待される動作**:
AIが自動で setup-init.md を読み込み、セットアップを継続する

**実際の動作**:
「以下のファイルを読み込んでください」と表示され、ユーザーが手動で読み込む必要がある

**影響箇所**:
- `prompts/setup-prompt.md` 50-63行目（ケースA）
- `prompts/setup-prompt.md` 67-80行目（ケースB）
- `prompts/setup-prompt.md` 84-104行目（ケースC）
- `prompts/setup-prompt.md` 107-119行目（ケースD）

---

### BUG-002: デフォルト値がある場合でも入力を要求される

| 項目 | 内容 |
|------|------|
| **重大度** | Low |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**再現手順**:
1. setup-init.md を読み込んでセットアップを開始
2. 「プロジェクト名を入力してください（デフォルト: のりごろ）:」と表示される
3. 入力しないと進まない

**期待される動作**:
デフォルト値がある場合は、入力なしでEnterを押すとデフォルト値が採用されて次に進む（または自動でデフォルトを採用して進む）

**実際の動作**:
デフォルト値があっても入力を要求され、入力しないと進まない

**影響箇所**:
- `prompts/setup-init.md` の変数入力セクション

---

### BUG-003: バージョンとブランチが不一致でも進行しようとする

| 項目 | 内容 |
|------|------|
| **重大度** | High |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**再現手順**:
1. セットアップを開始
2. バージョン（CYCLE変数）とブランチ名が異なる状態で進行
3. 警告やバリデーションなしにそのまま進みそうになる

**期待される動作**:
バージョン（CYCLE）とブランチ名が一致しない場合、警告を表示するか、確認を求める

**実際の動作**:
不一致を検出せずにそのまま進行しようとする

**影響箇所**:
- `prompts/setup-init.md` または `prompts/setup-cycle.md` のバリデーションセクション

---

### BUG-004: アップグレード時に既存ファイルを上書きできず削除してしまう

| 項目 | 内容 |
|------|------|
| **重大度** | Critical |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**再現手順**:
1. 既存プロジェクトでアップグレードセットアップを実行
2. docs/aidlc/prompts/ 配下のファイル更新時
3. 上書きできずにファイルが削除される

**削除されたファイル**:
- `docs/aidlc/prompts/additional-rules.md`
- `docs/aidlc/prompts/prompt-reference-guide.md`

**期待される動作**:
- 既存ファイルを安全に上書き更新する
- プロジェクト固有の設定（additional-rules.md）は保持またはマージする

**実際の動作**:
ファイルが削除されてしまう

**改善提案**:
- `additional-rules.md` のプロジェクト固有設定は `project.toml` に移行すべき
- アップグレード時は既存の project.toml を読み込んで設定を保持する

**影響箇所**:
- `prompts/setup-init.md` のファイル生成/更新ロジック

---

### BUG-005: 削除されたファイルへの参照が残っている

| 項目 | 内容 |
|------|------|
| **重大度** | Medium |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**問題**:
各フェーズプロンプト等に `docs/aidlc/prompts/additional-rules.md` を参照するルールが残っているが、BUG-004でファイルが削除される可能性がある

**期待される動作**:
- additional-rules.md の内容を project.toml に統合する
- 参照先を project.toml に変更する
- または additional-rules.md を削除対象から除外する

**実際の動作**:
削除されたファイルへの参照が残り、AIがエラーになるか無視する

**影響箇所**:
- `docs/aidlc/prompts/operations.md`
- `docs/aidlc/prompts/construction.md`
- `docs/aidlc/prompts/inception.md`
- その他フェーズプロンプト

---

### BUG-006: サイクル存在確認がない

| 項目 | 内容 |
|------|------|
| **重大度** | Medium |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**問題**:
サイクルディレクトリが存在しない場合のエラーハンドリングがない

**影響箇所**:
- `docs/aidlc/prompts/inception.md`
- `docs/aidlc/prompts/construction.md`
- `docs/aidlc/prompts/operations.md`

**追加すべき内容**:
```markdown
### サイクル存在確認
`docs/cycles/{{CYCLE}}/` の存在を確認：
- 存在しない場合: エラーを表示し、既存サイクル一覧を提示
- 存在する場合: 処理を継続
```

---

### BUG-007: バックログ機能が削除された

| 項目 | 内容 |
|------|------|
| **重大度** | Medium |
| **バグ種類** | 設計バグ |
| **対応フェーズ** | Construction（設計） |
| **ステータス** | Open |
| **報告日** | 2025-12-05 |
| **解決日** | - |

**問題**:
サイクル間でタスクを引き継ぐ仕組みが完全に失われた

**削除された機能**:
| 機能 | 対象ファイル |
|------|-------------|
| バックログ確認（ステップ0.5） | inception.md |
| バックログ記録（ステップ2.5） | operations.md |

**矛盾**: テンプレートは存在するが、プロンプトで使用手順がない
| 項目 | 状態 |
|------|------|
| `backlog_template.md` | 存在 |
| `backlog_completed_template.md` | 存在（新規追加） |
| プロンプト内の参照 | **なし** |

**バックログファイル**: `docs/cycles/backlog.md`

**影響箇所**:
- `docs/aidlc/prompts/inception.md`
- `docs/aidlc/prompts/operations.md`

**追加すべき内容（inception.md）**:
```markdown
### バックログ確認
`docs/cycles/backlog.md` の存在を確認：
- 存在しない場合: スキップ
- 存在する場合: 内容を確認し、ユーザーに「バックログがあります。確認しますか？」と質問
```

**追加すべき内容（operations.md）**:
```markdown
### バックログ記録
次サイクルに引き継ぐタスクがある場合：
- `docs/cycles/backlog.md` に追記
- タスク内容、優先度、理由を記載
```

---

## 改善提案: additional-rules.md の扱い（BUG-004/BUG-005 解決策）

### 方針: project.toml を最小限に、完全分離

| ファイル | 役割 | 内容 |
|---------|------|------|
| `project.toml` | セットアップ変数のみ | CYCLE, PROJECT_NAME, PROJECT_TYPE 等 |
| `additional-rules.md` | プロジェクト固有ルールすべて | 命名規則、禁止事項、手順、テンプレート等（自己完結、toml参照なし） |

### メリット
- **シンプル**: 相互参照なし、それぞれ自己完結
- **AIが読みやすい**: Markdown形式で自然言語、AIが解釈しやすい
- **人間も編集しやすい**: TOMLの構文を気にせず自由に書ける
- **アップグレードが安全**: additional-rules.md は「存在すればスキップ」でプロジェクト固有ルールが消えない

### 具体的な変更案

1. **スターターキットに `additional-rules.md` のテンプレートを追加**
   - `prompts/package/prompts/additional-rules.md` を作成
   - 基本的なセクション構成のみ（プロジェクト固有の内容は空）

2. **setup-init.md のコピー処理を改善**
   - `additional-rules.md` が既に存在する場合はスキップ（上書きしない）

3. **project.toml は現状維持**
   - セットアップ変数のみを保持
   - ルール系の設定は追加しない

---

## サマリー

### 結果集計

| 結果 | 件数 |
|------|------|
| Pass | 0 |
| Fail | 7 |
| Blocked | 0 |
| Skipped | 0 |
| **合計** | 1 |

### 発見バグ数
- Critical: 1
- High: 1
- Medium: 4
- Low: 1
- **合計**: 7

### 次のアクション
- [ ] BUG-001: setup-prompt.md の自動読み込み対応
- [ ] BUG-002: デフォルト値がある場合は入力をスキップ
- [ ] BUG-003: バージョンとブランチの整合性チェック追加
- [ ] BUG-004: additional-rules.md を上書きしない処理
- [ ] BUG-005: additional-rules.md テンプレートをスターターキットに追加
- [ ] BUG-006: サイクル存在確認を各フェーズプロンプトに追加
- [ ] BUG-007: バックログ機能を復活（inception.md, operations.md）
- [ ] 再テスト実施

---

## 履歴

| 日時 | 更新者 | 内容 |
|------|--------|------|
| 2025-12-05 | Claude | 初回作成、BUG-001 記録 |
