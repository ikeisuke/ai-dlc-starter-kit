# 論理設計: Unit 5 AI MCPレビュー推奨

## 概要

MCPサーバーが利用可能な場合に、ユーザー承認を求める前にレビューを推奨する機能をプロンプトに追加する。

**重要**: この論理設計では**コードは書かず**、プロンプトへの追加箇所と内容のみを定義します。

## 注記

本Unitはプロンプト編集のため、従来のソフトウェア論理設計（コンポーネント構成、API設計等）は該当しません。代わりに、各プロンプトファイルへの変更箇所を定義します。

---

## 変更対象ファイル

| ファイル | パス |
|---------|------|
| inception.md | `prompts/package/prompts/inception.md` |
| construction.md | `prompts/package/prompts/construction.md` |
| operations.md | `prompts/package/prompts/operations.md` |

> **注意**: `docs/aidlc/prompts/` は直接編集しない（rsyncで上書きされるため）

---

## 追加する共通セクション

各プロンプトの「開発ルール」セクションに以下を追加:

```markdown
- **MCPレビュー推奨【MCP利用可能時のみ】**: 別のAIエージェント（Codex MCP等）が利用可能な場合、ユーザーの承認を求める前にレビューを推奨する。
  - **条件**: MCPサーバーが利用可能（`mcp__*` ツールが存在）
  - **タイミング**: 各成果物の承認を求める前
  - **推奨文**:
    ```
    【レビュー推奨】別のAIエージェント（Codex MCP等）が利用可能です。
    品質向上のため、この成果物のレビューを実施することを推奨します。
    レビューを実施しますか？
    ```
  - **動作**: ユーザーが「はい」→ MCPでレビュー実施、「いいえ」→ スキップして承認へ
  - **MCP利用不可時**: この推奨は表示しない
```

---

## 各プロンプトへの具体的な追加箇所

### 1. inception.md

**追加位置**: 「開発ルール」セクションの末尾（「コンテキストリセット対応」の前）

**推奨タイミング**:
- Intent作成後、承認前
- ユーザーストーリー作成後、承認前
- Unit定義作成後、承認前

### 2. construction.md

**追加位置**: 「開発ルール」セクションの末尾（「割り込み対応フロー」の後、「コンテキストリセット対応」の前）

**推奨タイミング**:
- 設計レビュー前（ドメインモデル + 論理設計完了後）
- コード生成後、確認前
- テスト完了後、確認前

### 3. operations.md

**追加位置**: 「開発ルール」セクションの末尾（「コンテキストリセット対応」の前）

**推奨タイミング**:
- デプロイ計画作成後、承認前
- 運用ドキュメント作成後、承認前

---

## aidlc.toml での設定

### 設定項目

```toml
[rules.mcp_review]
mode = "recommend"  # "recommend" | "required" | "disabled"
```

### 動作マトリクス

| mode | MCP利用可否 | 動作 |
|------|-------------|------|
| "required" | 利用可能 | 必須（レビュー実施） |
| "required" | 利用不可 | 警告表示 |
| "recommend" | 利用可能 | 推奨表示 |
| "recommend" | 利用不可 | スキップ |
| "disabled" | - | スキップ |

### デフォルト値

- 設定がない場合: "recommend"

### 変更対象ファイル（追加）

| ファイル | パス | 内容 |
|---------|------|------|
| setup-init.md | `prompts/setup-init.md` | aidlc.toml テンプレート + マイグレーション機能 |

### アップグレード時のマイグレーション

既存プロジェクトのアップグレード時に、新しい設定セクションを自動追加する:

```bash
# [rules.mcp_review] セクションが存在しない場合は追加
if ! grep -q "^\[rules.mcp_review\]" docs/aidlc.toml; then
  cat >> docs/aidlc.toml << 'EOF'
[rules.mcp_review]
mode = "recommend"
EOF
fi
```

### プロンプトでの設定参照

各プロンプトに以下の記述を追加:

```markdown
**MCPレビュー設定の確認**:
1. `docs/aidlc.toml` の `[rules.mcp_review]` セクションを確認
2. mode に応じて動作を決定:
   - "required": レビュー必須
   - "recommend": レビュー推奨（デフォルト）
   - "disabled": レビューなし
```

---

## 推奨メッセージの詳細フォーマット

```markdown
---
### 【レビュー推奨】

別のAIエージェント（Codex MCP等）が利用可能です。
品質向上のため、この成果物のレビューを実施することを推奨します。

**レビュー対象**: [成果物名]

レビューを実施しますか？（はい / いいえ）
---
```

---

## 非機能要件（NFR）への対応

### パフォーマンス
- **要件**: MCP検出は即座に完了すること
- **対応策**: ツール一覧の確認のみ（外部通信なし）

### 可用性
- **要件**: MCP未設定時は提案をスキップ
- **対応策**: 条件付き記述で自動スキップ

---

## 不明点と質問（設計中に記録）

[Question] rules.md でAIレビューを強制設定している場合と、Unit 5 の推奨機能はどう連携すべきか？
[Answer] aidlc.toml で一元管理する。`[rules.mcp_review] mode` で "required" / "recommend" / "disabled" を設定。タイミングは「ユーザーの承認を求める前」。

[Question] aidlc.toml で制御できるようにするか？
[Answer] はい。`[rules.mcp_review] mode` で制御。デフォルトは "recommend"。
