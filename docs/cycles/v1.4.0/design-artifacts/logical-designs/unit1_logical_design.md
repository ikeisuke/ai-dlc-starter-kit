# 論理設計: サイクルバージョン提案改善

## 概要

バージョン提案ロジックを `setup-cycle.md` に集約し、`setup-init.md` からサイクル開始処理を分離する。

**重要**: この論理設計では**コードは書かず**、プロンプト構造の設計のみを行います。

## スコープ（拡大後）

1. **setup-init.md**: セクション8（サイクル開始処理）を削除し、setup-cycle.md への誘導に変更
2. **setup-cycle.md**: バージョン提案ロジックを追加（既存サイクル → package.json → v1.0.0）

## アーキテクチャパターン

プロンプト駆動型（Prompt-Driven）: AIへの指示としてロジックを記述

## コンポーネント構成

### 変更後のプロンプト構造

```
setup-init.md
└── ## 8. 次のステップ（変更）
    └── setup-cycle.md への誘導のみ

setup-cycle.md
└── ## 2. サイクルバージョンの確認（大幅改善）
    ├── ### 2.1 既存サイクルの検出
    ├── ### 2.2 バージョン提案（3段階フォールバック）
    │   ├── 既存サイクルから次バージョン提案
    │   ├── package.json 等からバージョン検出
    │   └── v1.0.0 をデフォルト提案
    ├── ### 2.3 ユーザーへの提案表示
    └── ### 2.4 バージョン確定
```

### コンポーネント詳細

#### 2.1 既存サイクルの検出
- **責務**: docs/cycles/ 内の既存サイクルディレクトリを列挙
- **入力**: なし
- **出力**: 既存サイクルバージョンのリスト

#### 2.2 バージョン解析と次バージョン提案
- **責務**: 最新バージョンを解析し、次バージョン候補を生成
- **入力**: 既存サイクルバージョンのリスト
- **出力**: 次バージョン候補（PATCH/MINOR/MAJOR）

#### 2.3 ユーザーへの提案表示
- **責務**: 提案をユーザーに分かりやすく表示
- **入力**: 次バージョン候補
- **出力**: 選択肢の表示

#### 2.4 バージョン確定
- **責務**: ユーザー選択を受け、重複チェック後に確定
- **入力**: ユーザーの選択
- **出力**: 確定したバージョン

## 処理フロー

### バージョン提案の処理フロー

**ステップ**:
1. `ls -d docs/cycles/*/ | sort -V` で既存サイクルを取得
2. 最新バージョン（ソート後の最後）を特定
3. バージョン文字列を解析（v1.3.2 → major=1, minor=3, patch=2）
4. 3つの候補を生成:
   - PATCH: v{major}.{minor}.{patch+1}
   - MINOR: v{major}.{minor+1}.0
   - MAJOR: v{major+1}.0.0
5. ユーザーに選択肢を提示
6. 選択を受け、重複チェック
7. バージョン確定

### フォールバック処理

- **既存サイクルがない場合**: v1.0.0 を提案
- **バージョン形式が不正な場合**: ユーザーに手動入力を求める

## プロンプト設計（具体的な変更内容）

### 変更前（現状）

```markdown
## 2. サイクルバージョンの確認

新しいサイクルのバージョンを入力してください（例: v1.1.0, v2.0.0）:

### 既存サイクルの確認
ls -d docs/cycles/*/ 2>/dev/null | sort -V

既存のサイクル一覧を表示し、重複がないか確認してください。
```

### 変更後（提案）

```markdown
## 2. サイクルバージョンの確認

### 2.1 既存サイクルの検出

既存サイクルを確認:
```bash
ls -d docs/cycles/*/ 2>/dev/null | sort -V
```

### 2.2 次バージョンの提案

**既存サイクルがある場合**:
- 最新バージョンを特定（ソート後の最後のディレクトリ）
- バージョン文字列を解析: v{major}.{minor}.{patch} 形式
- 次バージョン候補を生成

**既存サイクルがない場合**:
- v1.0.0 をデフォルト提案

### 2.3 ユーザーへの提案

以下の形式で提案:

```
既存サイクル: [一覧]
最新バージョン: [最新]

次バージョンの提案:
1. v{x}.{y}.{z+1}（パッチ - バグ修正・小さな変更）[推奨]
2. v{x}.{y+1}.0（マイナー - 新機能追加）
3. v{x+1}.0.0（メジャー - 破壊的変更）
4. その他（カスタム入力）

どれを選択しますか？
```

### 2.4 バージョン確定

- ユーザーの選択を受け付け
- 選択が 1-3 の場合: 該当バージョンを使用
- 選択が 4 の場合: カスタム入力を求める
- 重複チェック: 既存サイクルと同じ場合はエラー
```

## 非機能要件への対応

### パフォーマンス
- **要件**: 即座に提案できること
- **対応**: ディレクトリ列挙のみで完結、外部依存なし

## 技術選定

- **対象ファイル**: Markdownプロンプト
- **使用ツール**: bash（ls, sort）

## 実装上の注意事項

- バージョン形式は `vX.Y.Z` のみ対応（v なしや他の形式は非対応）
- 既存サイクルがないケースのフォールバックを忘れない
- ユーザーが「4. その他」を選んだ場合の入力バリデーション

## 不明点と質問

（なし - 要件は明確）
