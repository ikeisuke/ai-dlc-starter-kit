# 論理設計: Unit 3 - Operations Phase構造改善

## 概要
Operations Phaseプロンプト（operations.md）の構造を改善し、ステップ構成の変更とバージョン確認機能の追加を行う。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコード（SQL、JSON、実装コード等）はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン
プロンプトファイル構成パターン - 各フェーズのプロンプトが独立したファイルとして存在し、共通のテンプレートを参照する設計

## コンポーネント構成

### ファイル構成

```
prompts/package/
├── prompts/
│   └── operations.md  [変更対象: メインプロンプト]
└── templates/
    └── operations_handover_template.md  [変更対象: バージョン確認設定追加]
```

### コンポーネント詳細

#### operations.md（Operations Phaseプロンプト）
- **責務**: Operations Phase全体のワークフロー定義
- **依存**: テンプレートファイル群
- **変更内容**:
  1. ステップ1にバージョン確認を追加
  2. ステップ5を「バックログ整理と運用計画」に変更
  3. ステップ6「リリース準備」を新設
  4. 「完了時の必須作業」セクションを調整

#### operations_handover_template.md（運用引き継ぎテンプレート）
- **責務**: サイクル間で引き継ぐ運用設定を定義
- **依存**: なし
- **変更内容**: バージョン確認対象ファイルの設定セクションを追加

## インターフェース設計

### ステップ1: デプロイ準備（変更）

**追加項目: バージョン確認**

```markdown
#### バージョン確認【必須】

運用引き継ぎ（`docs/cycles/operations.md`）の「バージョン確認設定」を確認:
- 設定がある場合: 設定に従ってバージョンを確認
- 設定がない場合: 対話形式でバージョン確認対象を特定

**確認手順**:
1. バージョン確認対象ファイルを特定（package.json, pyproject.toml等）
2. 現在のバージョンを確認
3. サイクルバージョンと整合性を確認
4. バージョン未更新の場合は更新を提案し、承認後に更新

**バージョン確認例**:
- Node.js: `cat package.json | grep '"version"'`
- Python: `cat pyproject.toml | grep 'version'`
```

### ステップ5: バックログ整理と運用計画（変更）

**変更前**: リリース後の運用
**変更後**: バックログ整理と運用計画

```markdown
### ステップ5: バックログ整理と運用計画【対話形式】

- **ステップ開始時**: progress.mdでステップ5を「進行中」に更新
- **対話形式**: 同様に**一問一答形式**で対話

**5.1 バックログ整理**:
サイクル固有バックログ（`docs/cycles/{{CYCLE}}/backlog.md`）を確認し整理:
- 対応済み項目: `docs/cycles/backlog-completed.md` に移動
- 未対応項目: `docs/cycles/backlog.md`（共通）に移動
- 共通から転記した項目: 対応済みなら完了済みに、未対応なら共通に残す

**5.2 リリース後運用計画**:
- **成果物**: `docs/cycles/{{CYCLE}}/operations/post_release_operations.md`
- **ステップ完了時**: progress.mdでステップ5を「完了」に更新、完了日を記録
```

### ステップ6: リリース準備（新設）

```markdown
### ステップ6: リリース準備

- **ステップ開始時**: progress.mdでステップ6を「進行中」に更新

**6.1 README更新**:
README.mdに今回のサイクルの変更内容を追記

**6.2 履歴記録**:
`docs/cycles/{{CYCLE}}/history.md` に履歴を追記（heredoc使用、日時は `date '+%Y-%m-%d %H:%M:%S'` で取得）

**6.3 Gitコミット**:
Operations Phaseで作成したすべてのファイル（**operations/progress.md、history.mdを含む**）をコミット

コミットメッセージ例:
```
chore: Operations Phase完了 - デプロイ、CI/CD、監視を構築
```

**6.4 PR作成**:
mainブランチへのPRを作成

- **ステップ完了時**: progress.mdでステップ6を「完了」に更新、完了日を記録
```

## データモデル概要

### 運用引き継ぎファイル（operations.md）への追加セクション

**追加フィールド: バージョン確認設定**
```markdown
## バージョン確認設定

### 確認対象ファイル
| ファイル | フィールド | 確認コマンド |
|----------|-----------|--------------|
| [ファイル名] | [フィールドパス] | [コマンド] |

### バージョン命名規則
[セマンティックバージョニング等の規則を記載]
```

## 処理フロー概要

### デプロイ準備時のバージョン確認フロー

**ステップ**:
1. 運用引き継ぎファイルからバージョン確認設定を読み込む
2. 設定がない場合は対話形式で確認対象を特定
3. 各対象ファイルのバージョンを確認
4. サイクルバージョンとの整合性を確認
5. 不整合がある場合は更新を提案
6. ユーザー承認後にバージョンを更新
7. 運用引き継ぎファイルに設定を保存（初回の場合）

**関与するコンポーネント**: operations.md, operations_handover_template.md

### バックログ整理フロー

**ステップ**:
1. サイクル固有バックログを読み込む
2. 各項目の出自（このサイクルで発見 / 共通から転記）を確認
3. 各項目の対応状態（対応済み / 未対応）を確認
4. 移動先を決定:
   - このサイクルで発見 + 対応済み → backlog-completed.md
   - このサイクルで発見 + 未対応 → backlog.md（共通）
   - 共通から転記 + 対応済み → backlog-completed.md
   - 共通から転記 + 未対応 → 共通に残す
5. 各項目を適切なファイルに移動

**関与するコンポーネント**: operations.md

## 非機能要件（NFR）への対応

### パフォーマンス
- **要件**: 該当なし（プロンプトファイルの変更のため）
- **対応策**: -

### セキュリティ
- **要件**: 該当なし
- **対応策**: -

### スケーラビリティ
- **要件**: 該当なし
- **対応策**: -

### 可用性
- **要件**: 該当なし
- **対応策**: -

## 技術選定
- **言語**: Markdown
- **フレームワーク**: AI-DLCプロンプト形式
- **ライブラリ**: なし
- **データベース**: なし（ファイルベース）

## 実装上の注意事項
- `prompts/package/` を編集すること（`docs/aidlc/` は直接編集禁止）
- 既存のステップ番号への参照がないことを確認（progress.md初期化ロジック等）
- バージョン確認設定は運用引き継ぎに保存し、次サイクルで再利用可能にする

## 不明点と質問

（なし - ドメインモデル設計で解決済み）
