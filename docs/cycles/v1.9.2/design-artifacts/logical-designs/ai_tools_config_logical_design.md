# 論理設計: ai_tools設定による複数AIサービス対応

## 概要

review-flow.mdの「AIレビューツール利用可否の確認」セクションを拡張し、ai_tools設定に基づく優先順位判定ロジックを追加する。

**重要**: この論理設計では**コードは書かず**、セクション構成と処理フロー定義のみを行います。

## アーキテクチャパターン

設定駆動型（Configuration-Driven）パターンを採用。

- 設定ファイル（aidlc.toml）からツール優先順位を読み取り
- 設定値に基づいて動的にツール選択を行う
- 後方互換性のためのデフォルト値を維持

## セクション構成

### 変更対象: review-flow.md

```text
# AIレビューフロー
├── ## 設定確認              [変更なし]
├── ## ai_tools設定          [★新規追加]
├── ## AIレビューツール利用可否の確認  [★変更]
├── ## 処理フロー            [変更なし]
└── ## 外部入力検証ルール    [変更なし]
```

### セクション詳細

#### 新規追加: `## ai_tools設定`

設定確認セクションの後に追加。

- **責務**: ai_tools設定の読み取り方法とデフォルト値を説明
- **内容**:
  - 設定項目の説明
  - 有効なツール名リスト
  - デフォルト値
  - エラー処理

#### 変更: `## AIレビューツール利用可否の確認`

現在のcodex固定ロジックを、ai_tools設定に基づく優先順位判定に変更。

- **変更前**: codexスキル → MCPフォールバック
- **変更後**: ai_toolsリストを順に確認 → 利用可能なツールを選択

## 処理フロー

### ai_tools設定読み取りフロー

1. `docs/aidlc.toml` の `[rules.mcp_review]` セクションを読み取り
2. `ai_tools` キーが存在するか確認
3. 存在しない場合: デフォルト `["codex"]` を使用
4. 存在する場合: 値を検証
   - 配列でない場合: 警告を出し、デフォルトを使用
   - 空配列の場合: 警告を出し、デフォルトを使用
   - 未知のツール名を含む場合: 警告を出し、そのツールをスキップ

### AIツール選択フロー

1. ai_toolsリストを先頭から順に確認
2. 各ツールについて:
   a. Skillsで利用可能か確認
   b. Skills利用不可 かつ MCPフォールバックが存在する場合、MCPを確認
   c. 利用可能であれば、そのツールを選択して終了
3. すべて利用不可の場合: 「AIレビュー不可」として処理

## 変更箇所の詳細

### 1. 新規セクション「ai_tools設定」の内容

```markdown
## ai_tools設定

`docs/aidlc.toml` の `[rules.mcp_review]` セクションから `ai_tools` を読み取る。

**設定形式**:
- `ai_tools`: AIレビューに使用するツールの優先順位リスト（配列）
- デフォルト: `["codex"]`

**有効なツール名**:
| ツール名 | Skills呼び出し | MCPフォールバック |
|----------|----------------|-------------------|
| codex | skill="codex" | mcp__codex__codex |
| claude | skill="claude" | なし |
| gemini | skill="gemini" | なし |

**設定例**:
[TOML設定例を記載]

**エラー処理**:
- ai_tools未設定: デフォルト使用
- 空配列: 警告 + デフォルト使用
- 未知のツール名: 警告 + スキップ
- 配列以外の型: 警告 + デフォルト使用
```

### 2. 「AIレビューツール利用可否の確認」セクションの変更

**変更前（抜粋）**:
```markdown
- **Skills確認**: Skillツール一覧から `codex` スキルが利用可能か確認（スキル名は `codex` 固定）
```

**変更後（抜粋）**:
```markdown
- **ai_tools設定の読み取り**: 上記「ai_tools設定」セクションに従って優先順位リストを取得
- **優先順位に従った利用可否確認**: リストを先頭から順に確認し、最初に利用可能なツールを使用
```

### 3. 処理フローセクションの変更

ステップ2の記述を更新:
- 変更前: codex固定
- 変更後: ai_toolsリストを順に確認

## 非機能要件への対応

### スケーラビリティ

- 新規ツール追加時はai_tools設定のテーブルに行を追加するのみ
- 処理ロジックの変更は不要

### 後方互換性

- ai_tools未設定時は従来通りcodexをデフォルトで使用
- 既存のaidlc.toml設定は変更不要

## 実装上の注意事項

- 設定読み取り時のエラーは警告として処理し、デフォルト動作にフォールバック
- 未知のツール名は無視するが、ユーザーに警告を表示
- MCPフォールバックが存在するのはcodexのみ（他ツールはSkillsのみ）

## 不明点と質問

現時点で不明点はありません。
