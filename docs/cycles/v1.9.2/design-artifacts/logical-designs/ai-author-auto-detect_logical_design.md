# 論理設計: AI著者情報の自動検出

## 概要

rules.mdの「Co-Authored-By の設定」セクションを拡張し、AI著者情報の自動検出ロジックを追加する。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。

## アーキテクチャパターン

**プロンプト駆動アーキテクチャ**: AIツールがプロンプト内の指示に従って検出ロジックを実行する。コードではなく、自然言語による手順定義。

## コンポーネント構成

### ドキュメント構成

```text
prompts/package/prompts/common/rules.md
└── ## Co-Authored-By の設定
    ├── ### 自動検出の有効化/無効化
    ├── ### 検出フロー
    │   ├── ステップ1: 設定確認
    │   ├── ステップ2: 自己認識
    │   ├── ステップ3: 環境変数
    │   └── ステップ4: ユーザー確認
    ├── ### AIツールマッピングテーブル
    └── ### マイグレーション（既存設定の削除）
```

## 処理フロー概要

### AI著者情報決定フロー

**ステップ**:

1. **設定確認**: `docs/aidlc.toml`の`[rules.commit]`セクションを確認
   - `ai_author_auto_detect = false` → 既存の`ai_author`設定を使用（自動検出スキップ）
   - `ai_author`が有効値で設定済み → その値を使用
   - `ai_author`が未設定/空/空白 → 次のステップへ

2. **自己認識による検出**: AIツールが自身のアイデンティティを認識
   - Claude Code → `Claude <noreply@anthropic.com>`
   - Cursor → `Cursor <noreply@cursor.com>`
   - 検出成功 → その値を使用
   - 検出失敗 → 次のステップへ

3. **環境変数からの検出**: 環境変数をチェック
   - `CLAUDE_CODE` 存在 → Claude Code
   - `CURSOR_EDITOR` 存在 → Cursor
   - 検出成功 → その値を使用
   - 検出失敗 → 次のステップへ

4. **ユーザー確認**: 上記すべて失敗時
   - ユーザーに使用中のAIツールを質問
   - 回答に基づいてAIAuthor値を決定

### マイグレーションフロー（既存設定の削除）

**ステップ**:

1. **設定検出**: `ai_author`設定の有無を確認
2. **無効化チェック**: `ai_author_auto_detect = false` なら終了
3. **ユーザー確認**: 設定がある場合、削除するか確認
4. **設定変更**: ユーザーが同意した場合、設定をコメントアウト

## インターフェース設計

### aidlc.toml設定スキーマ

```toml
[rules.commit]
# 既存フィールド（オプション、自動検出で上書き可能）
ai_author = "Claude <noreply@anthropic.com>"

# 新規フィールド（オプション）
ai_author_auto_detect = true  # デフォルト: true
```

| フィールド | 型 | デフォルト | 説明 |
|-----------|-----|----------|------|
| ai_author | string | (未設定) | 手動設定時のAI著者情報 |
| ai_author_auto_detect | boolean | true | 自動検出の有効/無効 |

### 「未設定」の判定条件

以下はすべて「未設定」として扱う:
- キーが存在しない
- `ai_author = ""`
- `ai_author = "   "`（空白のみ）

## 非機能要件（NFR）への対応

### スケーラビリティ

- **要件**: 新規ツール追加に対応可能な設計
- **対応策**: マッピングテーブル形式で拡張可能に

## 実装上の注意事項

- 自己認識は各AIツール固有の方法で行う（Claude Codeは自身を"Claude Code"と認識）
- 環境変数チェックはBashコマンドで実行
- マイグレーション確認はユーザーの明示的な同意が必要

## 変更箇所の詳細

### rules.md 変更内容

**変更前**（現在の構造）:
```markdown
## Co-Authored-By の設定
（既存の設定確認とコミットメッセージ形式のみ）
```

**変更後**（追加内容）:
```markdown
## Co-Authored-By の設定

### 自動検出の有効化/無効化
（ai_author_auto_detect設定の説明）

### 検出フロー
（4ステップの検出ロジック）

### AIツールマッピングテーブル
（AIツール名とai_author値の対応表）

### マイグレーション（既存設定の削除）
（v1.9.1以前からの移行手順）

### 設定の確認（既存内容を移動・調整）
（aidlc.toml確認手順）

### コミットメッセージ形式（既存内容）
（変更なし）
```

## 不明点と質問（設計中に記録）

なし
