# 論理設計: レビュー・コミットワークフロー

## 概要

レビュー前後のコミット手順を全ケース（AIレビュー、人間レビュー）で明確化するための、プロンプトファイル修正設計。

**重要**: この論理設計では**コードは書かず**、変更箇所と変更内容の定義のみを行います。

## 変更対象ファイル

1. `prompts/package/prompts/inception.md`
2. `prompts/package/prompts/construction.md`
3. `prompts/package/prompts/operations.md`

## 現状分析

### 既存実装の問題点

現在、3つのプロンプトファイルには「AIレビュー優先ルール」セクション内に以下の記載がある：

```markdown
3. **MCP利用可能時**:
   - **レビュー前コミット**:
     ```bash
     git add -A && git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```
   - AIレビューを実行
   - ...
   - **レビュー後コミット**（修正があった場合）:
     ```bash
     git add -A && git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```
```

**問題点**:
1. コミット手順が「MCP利用可能時」の条件下にのみ存在
2. 以下のケースでコミットタイミングが不明確：
   - MCP利用不可時の人間レビュー
   - AIレビューモードが`disabled`の場合

## 変更設計

### 変更方針

「AIレビュー優先ルール」セクションの処理フローを再構成し、全ケースでコミット手順を明確化する。

### 変更箇所詳細

#### 共通変更（3ファイル共通）

「AIレビュー優先ルール」セクションの「処理フロー」部分を以下の構成に変更：

```markdown
**処理フロー**:

1. **mode確認**: 上記コマンドでmodeを取得
   - 空または取得失敗時は「recommend」として扱う
   - `disabled` の場合: ステップ5（人間レビューフロー）へ
   - `required` または `recommend` の場合: 次のステップへ

2. **MCP利用可否チェック**: Codex MCPツール（`mcp__codex__codex`）の存在確認

3. **MCP利用可能時（AIレビューフロー）**:
   - **レビュー前コミット**:
     ```bash
     git add -A && git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```
   - AIレビューを実行
   - レビュー結果を確認
   - 指摘があれば修正を反映
   - **レビュー後コミット**（修正があった場合）:
     ```bash
     git add -A && git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```
   - 修正後の成果物を人間に提示
   - 人間の承認を求める

4. **MCP利用不可時**:
   - `mode = "required"` の場合:
     ```text
     【警告】AIレビューが必須設定ですが、AI MCPが利用できません。

     AIレビューをスキップして人間の承認に進みますか？
     1. はい - 人間承認へ進む（レビュースキップを履歴に記録）
     2. いいえ - 処理を中断
     ```
     ユーザーの応答を待ち、「はい」の場合はスキップを履歴に記録してステップ5へ
   - `mode = "recommend"` の場合: ステップ5へ

5. **人間レビューフロー**（mode=disabled または MCP利用不可時）:
   - **レビュー前コミット**:
     ```bash
     git add -A && git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```
   - 成果物を人間に提示
   - 人間の承認を求める
   - 修正依頼があれば修正を反映
   - **レビュー後コミット**（修正があった場合）:
     ```bash
     git add -A && git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```
   - 再度人間に提示・承認を求める
```

### ファイル別変更箇所

#### inception.md

- **変更箇所**: 行134-168（「処理フロー」セクション）
- **変更内容**: 上記の共通変更を適用

#### construction.md

- **変更箇所**: 行183-230（「処理フロー」セクション）
- **変更内容**: 上記の共通変更を適用

#### operations.md

- **変更箇所**: 行136-171（「処理フロー」セクション）
- **変更内容**: 上記の共通変更を適用

## 非機能要件（NFR）への対応

### パフォーマンス
- N/A（ドキュメント変更のため）

### セキュリティ
- N/A（ドキュメント変更のため）

### スケーラビリティ
- N/A（ドキュメント変更のため）

### 可用性
- N/A（ドキュメント変更のため）

## 技術選定
- **対象**: Markdown プロンプトファイル
- **ツール**: テキストエディタ

## 実装上の注意事項

1. **3ファイルの一貫性**: 3つのプロンプトファイルで同じ構成・表現を使用すること
2. **既存内容の保持**: 「推奨メッセージ」「対象タイミング」等の既存セクションは保持すること
3. **インデント**: Markdownのインデント（スペース2個）を統一すること

## 不明点と質問（設計中に記録）

（現時点で不明点なし）

---
作成日: 2026-01-09
