# ドメインモデル: AIレビュー反復プロセス

## 概要

AIレビューの反復プロセスと設定読み込みパターンを改善し、レビュー品質を向上させる。

**重要**: このドメインモデル設計では**コードは書かず**、構造と責務の定義のみを行います。実装はImplementation Phase（コード生成ステップ）で行います。

## コンセプトモデル

本Unitはプロンプトファイル（Markdownドキュメント）の改善であり、従来のソフトウェアエンティティではなく、AIエージェントが従うべきフローと設定パターンを定義する。

### AIレビューフロー（概念）

- **責務**: AIレビューを反復的に実行し、指摘がなくなるまで修正を繰り返す
- **トリガー**: 設計完了後、コード生成後など承認を求める前
- **終了条件**: AIレビューで指摘がゼロになった時点

### 反復プロセスフロー

```text
1. AIレビュー実行
   ↓
2. 指摘あり?
   ├── はい → 3. 修正実施 → 1に戻る（反復）
   └── いいえ → 4. 人間レビューへ進む
```

**重要な追加**:

- ステップ3→1のループが現在のプロンプトでは明示されていない
- 「指摘がなくなるまで繰り返す」を明文化する必要がある

## 値オブジェクト（設定値）

### MCP Review Mode

- **属性**: mode: string（"required" | "recommend" | "disabled"）
- **デフォルト値**: "recommend"
- **バリデーション**: 上記3値以外は警告を出しデフォルトにフォールバック

### Backlog Mode

- **属性**: mode: string（"git" | "issue"）
- **デフォルト値**: "git"
- **バリデーション**: 上記2値以外は警告を出しデフォルトにフォールバック

### Worktree Enabled

- **属性**: enabled: boolean（true | false）
- **デフォルト値**: false

### Release Settings

- **changelog**: boolean（true | false）、デフォルト: false
- **version_tag**: boolean（true | false）、デフォルト: false

## ドメインサービス（設定読み込み）

### TOML設定読み込みサービス

- **責務**: docs/aidlc.tomlから各種設定値を正確に読み込む
- **現在の問題**:
  1. `grep -A1` パターンでは次の1行しか取得できない
  2. コメント行（`#`で始まる行）を誤って読み込む
  3. POSIX awkで`\s`が動作しない
  4. セクション終了時に`found`フラグがリセットされない
  5. バリデーションが不十分
- **改善後のパターン**:
  - awkを使用してセクション内の設定を正確に読み取る
  - コメント行を除外
  - バリデーションとフォールバック処理を統一

## 影響範囲

### 変更対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| construction.md | AIレビューフロー反復追加、MCP_REVIEW_MODE読み込み改善 |
| inception.md | MCP_REVIEW_MODE読み込み改善 |
| operations.md | MCP_REVIEW_MODE、CHANGELOG_ENABLED、VERSION_TAG_ENABLED読み込み改善 |
| setup.md | WORKTREE_ENABLED読み込み改善 |

### 変更なしの箇所

- construction.md:129 BACKLOG_MODE - 既にawkパターンを使用（Unit 001で改善済み）

## ユビキタス言語

- **AIレビュー反復**: AIレビューで指摘がなくなるまで修正→再レビューを繰り返すプロセス
- **設定読み込みパターン**: TOML設定ファイルから値を抽出するためのawkスクリプトパターン
- **フォールバック**: 無効な設定値が検出された場合にデフォルト値に戻す処理

## 不明点と質問（設計中に記録）

（なし - Unit定義で要件が明確に定義されている）
