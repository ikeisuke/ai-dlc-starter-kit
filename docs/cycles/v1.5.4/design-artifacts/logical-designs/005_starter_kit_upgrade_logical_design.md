# 論理設計: スターターキットアップグレードフロー改善

## 概要

AI-DLCスターターキット開発リポジトリを識別し、アップグレード案内をスキップする機能の論理設計。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコード（bash、実装コード等）はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン

プロンプトファイル内のシェルスクリプトによる条件分岐パターン。
setup.md の既存フロー（ステップ0 → ステップ1 → ...）に判定ロジックを追加。

## コンポーネント構成

### フロー構成

```
setup.md
├── 0. デプロイ済みファイル確認（既存）
├── 0.5. スターターキット開発リポジトリ判定【新規追加】
│   ├── プロジェクト名取得
│   └── 判定・スキップ処理
├── 1. スターターキットバージョン確認（既存、条件付きスキップ）
├── 2. サイクルバージョンの決定（既存）
└── ...（以降既存フロー）
```

### コンポーネント詳細

#### ステップ0.5: スターターキット開発リポジトリ判定

- **責務**: プロジェクト名を判定し、スターターキット開発リポジトリかどうかを識別
- **依存**: docs/aidlc.toml
- **公開インターフェース**:
  - プロジェクト名取得コマンド
  - 判定結果の出力
  - スキップ時のメッセージ表示

## 処理フロー概要

### スターターキット開発リポジトリ判定の処理フロー

**ステップ**:

1. **プロジェクト名取得**: `docs/aidlc.toml` から `[project] name` を読み取る
2. **判定**: プロジェクト名が `ai-dlc-starter-kit` と一致するか確認
3. **分岐**:
   - 一致する場合: スキップメッセージを表示し、ステップ2（サイクルバージョンの決定）へジャンプ
   - 一致しない場合: ステップ1（バージョン確認）へ進む

**関与するコンポーネント**: setup.md

## インターフェース設計

### コマンド

#### プロジェクト名取得

- **パラメータ**: なし
- **戻り値**: プロジェクト名（String）または空文字
- **副作用**: なし
- **実装方針**: `awk` を使用し、`[project]` セクション内の `name` のみを抽出（POSIX互換）
- **注意**: 他のセクション（例: `[rules.custom]`）に同名キーがあっても誤判定しないよう、セクションスコープを限定

#### 判定結果出力

- **パラメータ**: プロジェクト名
- **戻り値**: `STARTER_KIT_DEV` または `USER_PROJECT`
- **副作用**: 標準出力にメッセージ表示

## 修正箇所の詳細

### 修正対象ファイル

`prompts/package/prompts/setup.md`

### 修正位置

「### 0. デプロイ済みファイル確認」セクションの後、「### 1. スターターキットバージョン確認」セクションの前

### 追加するセクション構成

```markdown
### 0.5. スターターキット開発リポジトリ判定

[コマンドブロック: プロジェクト名取得と判定]

**判定**:
- **STARTER_KIT_DEV**: [スキップメッセージ]、ステップ2へ進む
- **USER_PROJECT**: ステップ1へ進む
```

### 表示メッセージ

スターターキット開発リポジトリと判定された場合:

```
スターターキット開発リポジトリを検出しました。
アップグレード案内はスキップします（開発リポジトリでは、次サイクルで変更を加えてリリースするためです）。
```

## 非機能要件（NFR）への対応

### パフォーマンス

- **要件**: N/A（ドキュメントのみ）
- **対応策**: 単純なgrep/sedコマンドで即座に判定

### セキュリティ

- **要件**: N/A
- **対応策**: ファイル読み取りのみ、外部入力なし

### スケーラビリティ

- **要件**: N/A
- **対応策**: 該当なし

### 可用性

- **要件**: N/A
- **対応策**: aidlc.tomlが存在しない場合は通常フロー（USER_PROJECT扱い）
- **前提**: スターターキット開発リポジトリでは、セットアップ完了後は常にaidlc.tomlが存在する（初期状態でも `prompts/package/` にテンプレートあり）

## 技術選定

- **言語**: Bash（POSIX互換）
- **ツール**: grep, sed（macOS/Linux両対応）
- **フレームワーク**: なし
- **データベース**: なし

## 実装上の注意事項

- **POSIX互換性**: `grep -oP` を使用せず、`grep -E` + `sed` の組み合わせを使用する（macOS対応）
- **エラーハンドリング**: aidlc.tomlが存在しない場合は空文字として扱い、USER_PROJECTと判定
- **フォールバック**: 判定に失敗した場合は安全側に倒して既存フロー（アップグレード案内表示）を継続

## 不明点と質問（設計中に記録）

現時点で不明点はありません。
