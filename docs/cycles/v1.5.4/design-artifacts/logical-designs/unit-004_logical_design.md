# 論理設計: UnitブランチPR自動作成

## 概要

`prompts/package/prompts/construction.md` の「6. Unitブランチ作成【推奨】」セクションにドラフトPR作成フローを追加する設計。

**重要**: この論理設計では**コードは書かず**、修正箇所と修正内容の概要のみを定義します。具体的なMarkdown記述は実装フェーズで作成します。

## 注記

このUnitはプロンプトファイル（Markdown）の修正のみです。従来のアーキテクチャパターンやコンポーネント構成は適用せず、ファイル修正の設計として記述します。

## 修正対象ファイル

- `prompts/package/prompts/construction.md`

## 修正箇所

### セクション: 6. Unitブランチ作成【推奨】（432-468行付近）

#### 現在の構造

```
### 6. Unitブランチ作成【推奨】
├── 前提条件チェック（GitHub CLI利用可否）
├── 利用可能な場合の確認メッセージ
├── 「はい」の場合
│   ├── Unitブランチ作成・切り替え
│   └── git push
└── 「いいえ」またはGitHub CLI利用不可の場合
    └── スキップ
```

#### 修正後の構造

```
### 6. Unitブランチ作成【推奨】
├── 前提条件チェック（GitHub CLI利用可否）
├── 利用可能な場合の確認メッセージ（修正: ドラフトPR作成について追記）
├── 「はい」の場合
│   ├── Unitブランチ作成・切り替え
│   ├── git push
│   ├── ドラフトPR作成（追加）
│   └── PR URL表示（追加）
└── 「いいえ」またはGitHub CLI利用不可の場合
    └── スキップ
```

## 処理フロー

### ドラフトPR作成フロー

**ステップ**:

1. Unitブランチ作成・切り替え（既存）
   ```bash
   UNIT_BRANCH="cycle/{{CYCLE}}/unit-{NNN}"
   git checkout -b "${UNIT_BRANCH}"
   ```

2. リモートにプッシュ（既存）
   ```bash
   git push -u origin "${UNIT_BRANCH}"
   ```

3. **ドラフトPR作成（追加）**
   ```bash
   gh pr create \
     --draft \
     --base "cycle/{{CYCLE}}" \
     --title "[Draft][Unit {NNN}] {Unit名}" \
     --body "$(cat <<'EOF'
   ## Unit概要
   [Unit定義から抽出した概要]

   ---
   :construction: このPRは作業中です。Unit完了時にレビュー依頼を行います。
   EOF
   )"
   ```

4. **PR URL表示（追加）**
   ```
   ドラフトPRを作成しました：
   [PR URL]

   Unit完了時にPRをレディ状態に変更し、レビューを依頼してください。
   ```

## インターフェース設計

### コマンド

#### gh pr create（ドラフトPR作成）

- **パラメータ**:
  - `--draft`: ドラフト状態でPRを作成
  - `--base`: ベースブランチ（サイクルブランチ）
  - `--title`: PRタイトル
  - `--body`: PRボディ
- **戻り値**: PR URL
- **副作用**: GitHubにドラフトPRを作成

## 確認メッセージの修正

現在のメッセージ:
```
Unitブランチを作成しますか？

ブランチ名: cycle/{{CYCLE}}/unit-{NNN}

Unitブランチを使用すると：
- Unit単位でのPRレビューが可能になります
- 並行作業時のコンフリクトを減らせます

1. はい - Unitブランチを作成する（推奨）
2. いいえ - サイクルブランチで直接作業する
```

修正後のメッセージ:
```
Unitブランチを作成しますか？

ブランチ名: cycle/{{CYCLE}}/unit-{NNN}

Unitブランチを使用すると：
- Unit単位でのPRレビューが可能になります
- 並行作業時のコンフリクトを減らせます
- ドラフトPRが自動作成され、作業の可視化ができます

1. はい - UnitブランチとドラフトPRを作成する（推奨）
2. いいえ - サイクルブランチで直接作業する
```

## 非機能要件（NFR）への対応

Unit定義で N/A のため、対応不要。

## 技術選定

- **ツール**: GitHub CLI（gh）
- **コマンド**: `gh pr create --draft`

## 実装上の注意事項

1. **PR作成失敗時の対応**: `gh pr create` が失敗した場合でも、ブランチ作成自体は成功しているため、手動でPRを作成する案内を表示する
2. **既存フローへの影響**: Unit完了時のPRマージフロー（セクション「4. Unit PR作成・マージ【推奨】」）も修正する（追加スコープ）
3. **ドラフトPRとUnit完了時PRの関係**: Unitブランチ作成時にドラフトPRを作成し、Unit完了時にそのPRをレディ状態に変更してマージする

## Unit完了時フローの修正（追加スコープ）

### 修正箇所: 4. Unit PR作成・マージ【推奨】（555-623行付近）

#### 現在のフロー

```
**「はい」の場合**:
1. PR作成（gh pr create）
2. PR URL表示
3. マージ確認後（gh pr merge）
4. サイクルブランチに復帰
```

#### 修正後のフロー

```
**「はい」の場合**:
1. 既存PRの確認（追加）
2. PRが存在する場合: レディ状態に変更（追加）
   PRが存在しない場合: 新規PR作成
3. PR URL表示
4. マージ確認後（gh pr merge）
5. サイクルブランチに復帰
```

### 処理フロー詳細

1. **既存PRの確認**:
   ```bash
   # 現在のブランチに紐づくPRを確認
   EXISTING_PR=$(gh pr view --json number,state 2>/dev/null)
   ```

2. **PRが存在する場合（ドラフトPR）**:
   ```bash
   # ドラフトをレディ状態に変更
   gh pr ready

   # PRボディを更新（作業完了メッセージに変更）
   gh pr edit --body "$(cat <<'EOF'
   ## Unit概要
   [Unit定義から抽出した概要]

   ## 変更内容
   [主な変更点]

   ## テスト結果
   [テスト結果サマリ]
   EOF
   )"
   ```

3. **PRが存在しない場合**:
   - 現在のフロー通り `gh pr create` を実行

## 確認メッセージの修正（Unit完了時）

現在のメッセージ:
```
Unit PRを作成しますか？

対象ブランチ: cycle/{{CYCLE}}/unit-{NNN} → cycle/{{CYCLE}}

1. はい - PRを作成してマージする（推奨）
2. いいえ - スキップする（後で手動で作成可能）
```

修正後のメッセージ:
```
Unit PRをマージしますか？

対象ブランチ: cycle/{{CYCLE}}/unit-{NNN} → cycle/{{CYCLE}}

※ ドラフトPRが存在する場合は、レディ状態に変更してマージします。

1. はい - PRを準備してマージする（推奨）
2. いいえ - スキップする（後で手動で作成可能）
```

## 不明点と質問（設計中に記録）

なし（要件が明確）
