# 論理設計: セットアップフロー最適化

## 概要

セットアップ/インセプションフローの変更仕様を定義する。確認省略、依存コマンド確認、ステップ番号整理の実装詳細を記載。

**注**: 本Unitはプロンプトの文言修正が主であり、アーキテクチャパターン等は適用しない。

## 編集対象と同期方針

### 編集対象

- `prompts/package/prompts/setup.md`
- `prompts/package/prompts/inception.md`

### 同期方針

`prompts/package/`を編集し、Operations Phaseでrsync（`prompts/setup-prompt.md`実行）により`docs/aidlc/`に反映される。

**重要**: `docs/aidlc/`は直接編集禁止。

## 確認省略の実装仕様（ストーリー1-1）

### 対象ファイル

`prompts/package/prompts/setup.md`

### 変更箇所

**ステップ5: サイクルディレクトリ作成**

### 現在の実装

````markdown
### 5. サイクルディレクトリ作成

ユーザーに確認：
```text
サイクル {{CYCLE}} のディレクトリを作成します。
よろしいですか？（Y/n）
```

- **拒否された場合**: 終了
  ```text
  サイクル作成を中止しました。
  ```

- **承認された場合**: 以下を実行
````

### 変更後の実装

````markdown
### 5. サイクルディレクトリ作成

サイクル {{CYCLE}} のディレクトリを自動的に作成します。

**ディレクトリ構造作成**:
````

**変更ポイント**:

1. 「ユーザーに確認」ブロックを削除
2. 「よろしいですか？（Y/n）」の文言を削除
3. 「拒否された場合」の分岐を削除
4. 「承認された場合」の条件分岐を削除し、直接実行に変更
5. 「自動的に作成します」の文言を追加

## 依存コマンド確認の実装仕様（ストーリー1-2）

### 対象ファイル

`prompts/package/prompts/setup.md`

### 追加位置

「最初に必ず実行すること」セクションの先頭（ステップ0の前）に新規ステップを追加。

**番号付け方針**: 既存番号を維持し、新ステップは「-1」とする。

### 既存確認との関係

setup.md内の既存の`gh`確認（バックログモード確認、ラベル作成等）とは異なる目的：

- **新規（-1）**: 冒頭での一括確認。全体の状態を把握するための情報提供
- **既存（各ステップ内）**: 各機能実行時の前提条件チェック

両方とも維持する。新規確認は情報提供のみで、既存の個別チェックは機能ごとの制御に使用。

### 新規ステップの内容

````markdown
### -1. 依存コマンド確認

AI-DLCで使用する依存コマンドの状態を確認します。

```bash
# ghの判定
if ! command -v gh >/dev/null 2>&1; then
  GH_STATUS="未インストール"
elif ! gh auth status >/dev/null 2>&1; then
  GH_STATUS="未認証"
else
  GH_STATUS="利用可能"
fi

# daselの判定
if command -v dasel >/dev/null 2>&1; then
  DASEL_STATUS="利用可能"
else
  DASEL_STATUS="未インストール"
fi

echo "gh: ${GH_STATUS}"
echo "dasel: ${DASEL_STATUS}"
```

**結果表示**:

```text
【依存コマンド確認】

以下のコマンドの状態を確認しました：

| コマンド | 状態 | 用途 |
|---------|------|------|
| gh | ${GH_STATUS} | GitHub操作（PR作成、Issue管理） |
| dasel | ${DASEL_STATUS} | 設定ファイル解析 |
```

**警告表示条件**: `GH_STATUS != "利用可能"` または `DASEL_STATUS != "利用可能"` の場合

```text
⚠️ 一部のコマンドが利用できません。関連機能は制限されます：
- gh未使用時: ドラフトPR作成、Issue操作、ラベル作成がスキップされます
- dasel未使用時: AIが設定ファイルを直接読み取ります（機能上の影響なし）

インストール方法:
- gh: https://cli.github.com/
- dasel: https://github.com/TomWright/dasel
```

**処理継続**: 警告後も次のステップへ進行する（エラー終了しない）
````

### 状態判定ロジック詳細

| コマンド | 状態 | 判定条件 |
|---------|------|----------|
| gh | 利用可能 | `command -v gh` 成功 かつ `gh auth status` 成功 |
| gh | 未認証 | `command -v gh` 成功 かつ `gh auth status` 失敗 |
| gh | 未インストール | `command -v gh` 失敗 |
| dasel | 利用可能 | `command -v dasel` 成功 |
| dasel | 未インストール | `command -v dasel` 失敗 |

### 機能制限の影響

| コマンド | 状態 | 影響を受ける機能 |
|---------|------|------------------|
| gh | 未インストール/未認証 | ドラフトPR作成、Issue操作、ラベル作成 |
| dasel | 未インストール | なし（AIが設定ファイルを直接読み取る） |

## ステップ番号整理の実装仕様（ストーリー1-3）

### 対象ファイル

`prompts/package/prompts/inception.md`

### 変更内容

「最初に必ず実行すること」セクション内の見出しと遷移参照を変更。

### 変更対象の見出し一覧

| 変更前 | 変更後 |
|--------|--------|
| `### 0. ブランチ確認【推奨】` | 変更なし |
| `### 0.5 サイクル名の決定【重要】` | `### 1. サイクル名の決定【重要】` |
| `### 1. サイクル存在確認` | `### 2. サイクル存在確認` |
| `### 2. 追加ルール確認` | `### 3. 追加ルール確認` |
| `### 2.5. Dependabot PR確認` | `### 4. Dependabot PR確認` |
| `### 2.7. GitHub Issue確認` | `### 5. GitHub Issue確認` |
| `### 3. バックログ確認` | `### 6. バックログ確認` |
| `### 4. 進捗管理ファイル確認【重要】` | `### 7. 進捗管理ファイル確認【重要】` |
| `### 5. 既存成果物の確認` | `### 8. 既存成果物の確認` |

### 文中の遷移参照の更新

| 箇所 | 変更前 | 変更後 |
|------|--------|--------|
| セクション見出し | `## 最初に必ず実行すること（6ステップ）` | `## 最初に必ず実行すること（9ステップ）` |
| 373行目付近（サイクル存在確認内） | `処理を継続（ステップ2へ）` | `処理を継続（ステップ3へ）` |

**注**: 「フロー」セクション内のステップ（ステップ1〜5: Intent明確化〜PRFAQ作成）は番号変更の対象外。

## 非機能要件（NFR）への対応

### パフォーマンス

該当なし

### セキュリティ

該当なし

### スケーラビリティ

該当なし

### 可用性

該当なし

## 実装上の注意事項

1. **メタ開発の注意**: `docs/aidlc/`は直接編集禁止。必ず`prompts/package/prompts/`を編集すること
2. **Markdownlint対象ファイル**:
   - `prompts/package/prompts/setup.md`
   - `prompts/package/prompts/inception.md`
3. **Markdownlint実行コマンド**: `npx markdownlint-cli2 "prompts/package/prompts/setup.md" "prompts/package/prompts/inception.md"`
4. **テスト方法**: 実際にsetup.mdとinception.mdを読み込んでフローを確認
