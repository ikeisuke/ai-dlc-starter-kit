# プランモード活用検討

## 概要

Claude Codeのプランモード（EnterPlanMode）をAI-DLC Construction Phaseで活用する方法を検討した結果をまとめる。

## EnterPlanModeの仕様

**注**: 本セクションの仕様はClaude Codeのツール説明に基づく。Claude Codeのバージョンや設定により動作が異なる可能性がある。

### 機能概要

EnterPlanModeは、非自明な実装タスクを開始する前に計画を立て、ユーザーと合意形成を行うためのモード。

**プランモードで行えること**:

- コードベースの探索（読み取り系ツールを使用）
- 既存パターンとアーキテクチャの理解
- 実装アプローチの設計
- ユーザーへの計画提示
- ユーザーの承認後、ExitPlanModeで実装へ移行

### 使用すべき場面

| 場面 | 例 |
|------|-----|
| 新機能実装 | ログアウトボタン追加 - 配置場所、クリック時の動作の決定 |
| 複数アプローチ | キャッシュ追加 - Redis/メモリ/ファイルの選択 |
| コード修正 | ログインフロー更新 - 具体的な変更内容の確認 |
| アーキテクチャ決定 | リアルタイム更新 - WebSocket/SSE/ポーリングの選択 |
| 複数ファイル変更 | 認証システムリファクタリング |
| 要件不明確 | パフォーマンス改善 - ボトルネック調査が必要 |

### 使用すべきでない場面

- 一行〜数行の修正（タイポ、明らかなバグ）
- 詳細な指示がすでにある場合
- 純粋なリサーチタスク（実装を伴わない調査のみの場合は、Task/Exploreエージェントを使用）

**注**: プランモードでもコード探索は行えるが、目的が異なる。プランモードは「実装計画策定のための探索」、Task/Exploreは「情報収集のみを目的とした探索」という使い分けになる。

## AI-DLC Construction Phaseとの比較

### 現在のConstruction Phase構造

```text
Construction Phase
├── Phase 1: 設計【対話形式、コードは書かない】
│   ├── ステップ1: ドメインモデル設計
│   ├── ステップ2: 論理設計
│   └── ステップ3: 設計レビュー → 承認必須
│
└── Phase 2: 実装【設計を参照してコード生成】
    ├── ステップ4: コード生成
    ├── ステップ5: テスト生成
    └── ステップ6: 統合とレビュー
```

### EnterPlanModeとの類似点

| AI-DLC | EnterPlanMode |
|--------|---------------|
| Phase 1（設計） | プランモードでの探索・設計 |
| 設計レビュー承認 | ユーザー承認後にExitPlanModeで移行 |
| Phase 2（実装） | 承認後の実装 |

**注**: ExitPlanMode自体は「承認を取得する」動作ではなく、ユーザーが計画を承認した後に「実装モードへ移行する」ためのツール。承認→ExitPlanModeの順序で実行される。

### 相違点

| 項目 | AI-DLC | EnterPlanMode |
|------|--------|---------------|
| 設計の粒度 | ドメインモデル + 論理設計 | アプローチの概要 |
| ドキュメント | 設計ファイルを作成 | 会話内で完結 |
| 成果物管理 | 明示的なファイル生成 | なし |
| 反復性 | 設計ドキュメントで再現可能 | セッション依存 |

## 活用案

### 案1: Phase 1開始時にプランモードを活用

**シナリオ**: Unit開始時にEnterPlanModeを使い、コードベースを探索してから設計に入る

**メリット**:

- 既存コードの理解が深まる
- 設計前にアーキテクチャを把握

**デメリット**:

- AI-DLCの既存フローと重複
- プロンプトの複雑化

**評価**: △（部分的に有効）

### 案2: 設計レビュー承認の代替

**シナリオ**: Phase 1の設計レビューをExitPlanModeで代替

**メリット**:

- 承認フローの統一

**デメリット**:

- 設計ドキュメントが残らない
- AI-DLCの設計重視思想と矛盾

**評価**: × （不採用）

### 案3: 探索フェーズとしての前置活用

**シナリオ**: Unit開始前の「探索フェーズ」としてプランモードを使用し、その結果を設計に反映

**メリット**:

- 既存コードの把握が容易
- 設計の質が向上

**デメリット**:

- フローが1ステップ増える
- 設定による制御が必要

**評価**: ○（検討価値あり）

### 案4: 複雑なUnitのみプランモードを推奨

**シナリオ**: Unit定義に「複雑度」フィールドを追加し、高複雑度のUnitのみプランモード使用を推奨

**メリット**:

- 必要な場合のみ活用
- 柔軟性が高い

**デメリット**:

- 複雑度の判定基準が必要
- 運用の一貫性が低下

**評価**: ○（検討価値あり）

## 期待される効果

### プランモード活用で期待できること

1. **既存コードの理解向上**: 設計前にコードベースを探索することで、既存パターンとの整合性を高められる

2. **設計品質の向上**: アーキテクチャを理解した上で設計することで、適切な設計判断ができる

3. **承認フローの明確化**: EnterPlanModeの承認機構を活用することで、ユーザーとの合意形成が明確になる

### 懸念事項

1. **フローの重複**: AI-DLCの既存設計フローと役割が重複する可能性

2. **プロンプトの複雑化**: 両方を組み合わせるとプロンプトが複雑になる

3. **ドキュメント管理**: プランモードは会話内で完結するため、設計ドキュメントとの整合性維持が必要

## 結論と推奨

### 現時点での推奨

**プランモードの積極的な導入は見送り、以下の運用を推奨**:

1. **現状維持**: AI-DLCの既存フロー（Phase 1設計 → Phase 2実装）を継続
2. **オプション活用**: 複雑なUnitで必要に応じてプランモードを活用
3. **明示的な使い分け**: 探索が必要な場合はTask/Exploreを使用

### 将来的な検討項目

1. **設定オプション化**: `docs/aidlc.toml`に`[rules.plan_mode]`セクションを追加し、Unit開始時のプランモード使用を制御

2. **Unit複雑度フィールド**: Unit定義テンプレートに複雑度を追加し、高複雑度の場合にプランモード使用を推奨

3. **ハイブリッドフロー**: プランモードでの探索結果を設計ドキュメントに反映するフローの検討

## 次サイクルへの申し送り

- プランモード活用を導入する場合は、`prompts/package/aidlc/prompts/construction.md`を修正
- 設定オプション追加時は`prompts/package/aidlc.toml.template`も更新
- GitHub Issue #39 のコメントにこの検討結果の要約を追記することを推奨

---

## 参考

- Claude Code EnterPlanMode ツール説明（Claude Codeセッション内で確認可能な内蔵ツール仕様）
- AI-DLC Construction Phase プロンプト (`docs/aidlc/prompts/construction.md`)

**注**: EnterPlanModeの仕様はClaude Code内蔵ツールとして提供されており、公式ドキュメントとしては公開されていない。本検討はClaude Codeセッション内で確認できるツール説明に基づいている。
