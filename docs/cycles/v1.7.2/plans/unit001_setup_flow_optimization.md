# Unit 001: セットアップフロー最適化 - 実装計画

## 概要

セットアップ/インセプションフローを改善し、不要な確認の省略と依存コマンドの事前確認を実装する。

## 対象ストーリー

- ストーリー 1-1: 不要な確認の省略 (#35)
- ストーリー 1-2: 依存コマンドの事前確認 (#36)
- ストーリー 1-3: ステップ番号の整理 (#36)

## 編集対象ファイル

**重要**: メタ開発のため `prompts/package/prompts/` を編集（`docs/aidlc/`は直接編集禁止）

1. `prompts/package/prompts/setup.md`
2. `prompts/package/prompts/inception.md`

## 変更内容

### 1. ストーリー 1-1: 不要な確認の省略

**対象**: `setup.md` ステップ5（サイクルディレクトリ作成）

**現状**:

```text
サイクル {{CYCLE}} のディレクトリを作成します。
よろしいですか？（Y/n）
```

**変更後**:

- 確認なしで自動実行
- 拒否オプションの削除
- 「自動的に作成します」の文言を追加

**検証方法**: 新規サイクル作成時に確認プロンプトが表示されないこと

**設計成果物での対応**: 論理設計 - セクション「確認省略の実装仕様」

### 2. ストーリー 1-2: 依存コマンドの事前確認

**対象**: `setup.md` 冒頭（新ステップ「-1. 依存コマンド確認」を追加）

**追加内容**:

- 依存コマンド（gh, dasel）の存在確認を冒頭で実行
- 存在しない場合は警告を表示（処理は続行）

**状態判定ロジック**:

```bash
# ghの判定
if ! command -v gh >/dev/null 2>&1; then
  GH_STATUS="未インストール"
elif ! gh auth status >/dev/null 2>&1; then
  # ネットワーク制限/未認証の両方を「未認証」として扱う
  GH_STATUS="未認証"
else
  GH_STATUS="利用可能"
fi

# daselの判定
if command -v dasel >/dev/null 2>&1; then
  DASEL_STATUS="利用可能"
else
  DASEL_STATUS="未インストール"
fi
```

**警告メッセージ仕様**:

```text
【依存コマンド確認】

以下のコマンドの状態を確認しました：

| コマンド | 状態 | 用途 |
|---------|------|------|
| gh | [利用可能 / 未インストール / 未認証] | GitHub操作（PR作成、Issue管理） |
| dasel | [利用可能 / 未インストール] | 設定ファイル解析 |

[警告がある場合のみ表示]
⚠️ 一部のコマンドが利用できません。関連機能は制限されます：
- gh未使用時: ドラフトPR作成、Issue操作、ラベル作成がスキップされます
- dasel未使用時: AIが設定ファイルを直接読み取ります（機能上の影響なし）

インストール方法:
- gh: https://cli.github.com/
- dasel: https://github.com/TomWright/dasel
```

**検証方法**:

- ghがない環境で警告が表示されること
- gh未認証時に「未認証」と表示されること
- daselがない環境で警告が表示されること
- 警告後も処理が続行されること

**設計成果物での対応**: 論理設計 - セクション「依存コマンド確認の実装仕様」

### 3. ストーリー 1-3: ステップ番号の整理

**対象**: `inception.md`

**現状のステップ番号**: 0, 0.5, 1, 2, 2.5, 2.7, 3, 4, 5

**変更後**: 0, 1, 2, 3, 4, 5, 6, 7, 8（連番化）

**マッピング**:

| 旧番号 | 新番号 | 内容 |
|--------|--------|------|
| 0 | 0 | ブランチ確認 |
| 0.5 | 1 | サイクル名の決定 |
| 1 | 2 | サイクル存在確認 |
| 2 | 3 | 追加ルール確認 |
| 2.5 | 4 | Dependabot PR確認 |
| 2.7 | 5 | GitHub Issue確認 |
| 3 | 6 | バックログ確認 |
| 4 | 7 | 進捗管理ファイル確認 |
| 5 | 8 | 既存成果物の確認 |

**影響範囲調査**:

- `inception.md` 内の相互参照: なし（各ステップは独立）
- 他プロンプトからの参照: なし
  - 検索条件: `grep -r "ステップ 0.5\|ステップ 2.5\|ステップ 2.7" prompts/`
  - 確認ファイル: `prompts/package/prompts/*.md`, `prompts/setup-prompt.md`
- ドキュメント: `docs/cycles/rules.md` - 参照なし
  - 検索条件: `grep -E "0\.5|2\.5|2\.7" docs/cycles/rules.md`

**検証方法**: inception.md内のステップ番号が連番であること

**設計成果物での対応**: ドメインモデル - セクション「ステップ番号マッピング」

## 実装順序（Phase 2）

1. **依存コマンド確認の追加**（setup.md）- 他の変更に影響なし
2. **確認省略の適用**（setup.md）- 依存関係なし
3. **ステップ番号の整理**（inception.md）- 依存関係なし

## 設計成果物の位置付け

本Unitは主に「プロンプトの文言・順番調整」であるため、設計成果物は軽量な設計メモレベルとする：

- **ドメインモデル**: 変更箇所の構造整理
  - ステップ番号マッピング（ストーリー1-3）
- **論理設計**: 変更仕様の詳細
  - 確認省略の実装仕様（ストーリー1-1）
  - 依存コマンド確認の実装仕様（ストーリー1-2）

## 成果物

- 設計ドキュメント: `docs/cycles/v1.7.2/design-artifacts/domain-models/setup_flow_optimization_domain_model.md`
- 論理設計: `docs/cycles/v1.7.2/design-artifacts/logical-designs/setup_flow_optimization_logical_design.md`
- 実装記録: `docs/cycles/v1.7.2/construction/units/setup_flow_optimization_implementation.md`

## 受け入れ基準

1. [ ] setup.md: サイクルディレクトリ作成時に確認プロンプトが表示されない
2. [ ] setup.md: 冒頭で依存コマンド（gh, dasel）の確認が実行される
3. [ ] setup.md: ghがない場合、「未インストール」と表示される
4. [ ] setup.md: gh未認証の場合、「未認証」と表示される
5. [ ] setup.md: daselがない場合、「未インストール」と表示される
6. [ ] setup.md: 警告時に機能制限の説明が表示される
7. [ ] setup.md: 警告後も処理が続行される
8. [ ] inception.md: ステップ番号が0-8の連番になっている
9. [ ] markdownlintエラーがないこと
