# 論理設計: Issue駆動バックログフロー

## 概要
バックログ管理のGitHub Issue連携フローを定義し、設定ファイルとガイドドキュメントの構成を設計する。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコード（SQL、JSON、実装コード等）はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン
ドキュメント駆動設計 - ガイドドキュメントと設定ファイルでフローを定義し、AIエージェントが実行時に参照

## コンポーネント構成

### ドキュメント構成

```text
prompts/package/
└── guides/
    └── issue-driven-backlog.md  # 新規作成

docs/
└── aidlc.toml                   # 設定追加
```

### コンポーネント詳細

#### ガイドドキュメント（issue-driven-backlog.md）
- **責務**: Issue駆動バックログフローの説明と手順提供
- **依存**: なし
- **公開インターフェース**:
  - 設定方法の説明
  - 新規バックログ作成フロー
  - バックログ完了フロー
  - 参照時の両方確認フロー

#### 設定ファイル（aidlc.toml）
- **責務**: バックログ管理モードの設定
- **依存**: なし
- **公開インターフェース**:
  - `[backlog].mode` 設定項目

## インターフェース設計

### 設定項目

#### `[backlog]` セクション
```toml
[backlog]
# バックログ管理モード設定
# mode: "git" | "issue"
# - git: ローカルファイルに保存（従来方式、デフォルト）
# - issue: GitHub Issueに保存
mode = "git"
```

### コマンド（AIエージェントが実行）

#### 新規バックログ作成（Issue駆動）
- **パラメータ**:
  - title: String - バックログタイトル
  - type: String - 種類（feature, bugfix等）
  - slug: String - スラッグ（Issue本文に記載）
  - body: String - 本文
- **副作用**: GitHub Issueを作成（`backlog`ラベル必須）

#### 新規バックログ作成（Git駆動）
- **パラメータ**:
  - slug: String - ファイル名用スラッグ
  - type: String - 種類
  - content: String - ファイル内容
- **副作用**: `docs/cycles/backlog/{type}-{slug}.md` を作成

#### バックログ参照（共通）
- **パラメータ**: なし
- **戻り値**: バックログ一覧（IssueとファイルをBoth表示）
- **副作用**: なし

## データモデル概要

### ファイル形式（aidlc.toml への追記）
- **形式**: TOML
- **主要フィールド**:
  - `[backlog].mode`: String - "git" | "issue"

## 処理フロー概要

### 1. 新規バックログ作成フロー

**ステップ**:
1. `docs/aidlc.toml` の `[backlog].mode` を確認
2. mode に応じて分岐:
   - `issue`:
     1. GitHub CLI認証状態を確認（未認証の場合は警告を表示しGit駆動にフォールバック）
     2. `gh issue create --label backlog` でGitHub Issueを作成（スラッグをbodyに含める）
   - `git`: `docs/cycles/backlog/{type}-{slug}.md` にファイルを作成
3. 作成結果をユーザーに表示

**関与するコンポーネント**: ガイドドキュメント、設定ファイル

### 2. バックログ完了フロー

**ステップ**:
1. `docs/aidlc.toml` の `[backlog].mode` を確認
2. mode に応じて分岐:
   - `issue`: `gh issue close` でIssueをクローズ
   - `git`: 該当ファイルを `docs/cycles/backlog-completed/{{CYCLE}}/` へ移動
3. 完了結果をユーザーに表示

**関与するコンポーネント**: ガイドドキュメント、設定ファイル

**備考**: Git駆動の場合、ファイルを削除せず移動することで履歴を保持する（既存運用との整合性）

### 3. バックログ無効化フロー

**ステップ**:
1. `docs/aidlc.toml` の `[backlog].mode` を確認
2. mode に応じて分岐:
   - `issue`: `gh issue close --reason "not planned"` でIssueをクローズ
   - `git`: 該当ファイルを削除（履歴はgitに残る）
3. 無効化結果をユーザーに表示

**関与するコンポーネント**: ガイドドキュメント、設定ファイル

**備考**: 「対応しない」と判断した場合に使用。完了フローと異なり、成果として記録しない

### 4. バックログ参照フロー

**ステップ**:
1. GitHub Issueを確認（`gh issue list --label backlog`）
2. ローカルファイルを確認（`ls docs/cycles/backlog/`）
3. 両方の結果をマージして表示

**関与するコンポーネント**: ガイドドキュメント

**備考**: 参照時は mode に関係なく両方を確認する（片方にしか存在しないアイテムを見落とさないため）

## 非機能要件（NFR）への対応

### パフォーマンス
- **要件**: N/A
- **対応策**: N/A

### セキュリティ
- **要件**: N/A
- **対応策**: N/A

### スケーラビリティ
- **要件**: N/A
- **対応策**: N/A

### 可用性
- **要件**: GitHub CLI未認証時はローカルファイル管理にフォールバック可能
- **対応策**:
  - Issue駆動選択時、GitHub CLIの認証状態を確認
  - 未認証の場合は警告を表示し、Git駆動へのフォールバックを提案

## 技術選定
- **言語**: Markdown（ガイドドキュメント）、TOML（設定ファイル）
- **フレームワーク**: N/A
- **ライブラリ**: N/A
- **データベース**: N/A

## 実装上の注意事項
- **既存設定との整合性**: `aidlc.toml` の他の `[rules.*]` セクションと同様の形式を踏襲
- **デフォルト値**: `mode = "git"` をデフォルトとし、従来動作を維持
- **将来拡張**: サイクル・フェーズ管理へのIssue連携は将来検討事項として記載

## ガイドドキュメントの構成

### issue-driven-backlog.md の目次構成

1. **概要**
   - Issue駆動バックログ管理とは
   - 従来方式（Git駆動）との違い

2. **設定方法**
   - `docs/aidlc.toml` への設定追加
   - モードの選択基準
   - 推奨ラベル構成（`backlog`, `priority:*`, `type:*`）

3. **前提条件**
   - GitHub CLIのインストールと認証
   - リポジトリへの書き込み権限

4. **フロー定義**
   - 新規バックログ作成
   - バックログ完了時
   - バックログ無効化時（対応しない）
   - バックログ参照時

5. **トラブルシューティング**
   - GitHub CLI未認証時の対応
   - Issueラベルの設定

6. **将来検討事項**
   - サイクル・フェーズ管理へのIssue連携

## 不明点と質問（設計中に記録）

なし（Unit定義で要件が明確に定義されている）
