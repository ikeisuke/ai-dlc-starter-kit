# 論理設計: セットアップスクリプト修正

## 概要

`prompts/setup-prompt.md` にスキルファイル同期とシンボリックリンク作成処理を追加する論理設計。

**重要**: この論理設計では**コードは書かず**、変更箇所と処理フローの定義のみを行います。

## 変更対象

### ファイル: `prompts/setup-prompt.md`

修正対象セクション:
1. セクション8.2: パッケージファイルの同期（rsync対象追加）
2. セクション8.2.3: プロジェクト固有ファイル（シンボリックリンク処理追加）
3. セクション8.3: 同期対象のファイル一覧（skills追加）
4. セクション10: 完了メッセージ（skills追加）

## 処理フロー設計

### 1. スキルファイル同期（rsync）

**配置場所**: セクション8.2.2.3（スクリプトの同期）の後に新規追加

**処理フロー**:

```text
1. 宛先ディレクトリ作成
   - mkdir -p docs/aidlc/skills

2. ドライランで削除対象を確認
   - rsync -avn --checksum --delete [ソース] [宛先] 2>&1 | grep "^deleting"
   - 「^deleting」で始まる行を抽出

3. 削除対象の判定
   - なし: 同期を実行
   - あり: ユーザーに確認
     - 1. 削除して同期（--delete付き）
     - 2. 削除せずに同期（--deleteなし）
     - 3. キャンセル

4. 同期の実行
   - rsync -av --checksum [--delete]
   - スターターキット/prompts/package/skills/ → docs/aidlc/skills/
```

**エラーハンドリング**:

| エラーケース | 対応 |
|-------------|------|
| mkdir コマンド失敗 | エラーメッセージを表示し、処理を中断 |
| rsync コマンド失敗 | エラーメッセージを表示し、処理を中断（必須ファイルのため） |

### 2. シンボリックリンク作成（Claude Code用）

**配置場所**: セクション8.2.3（プロジェクト固有ファイル）の末尾に追加

**前提条件**: リポジトリ直下で実行（setup-prompt.md セクション1で確認済み）

**処理フロー**:

```text
1. 親ディレクトリ作成
   - mkdir -p .claude
   - 注: .claude/skills は作成しない（シンボリックリンクとして作成するため）

2. 既存パスの状態確認
   - .claude/skills の状態を確認

3. 状態に応じた処理（4パターン）

   ケースA: パス未存在
   → 新規リンク作成

   ケースB: シンボリックリンク、同じターゲット
   → スキップ（メッセージ表示）

   ケースC: シンボリックリンク、異なるターゲット
   → ユーザーに確認
     - 1. 上書き（既存リンクを削除して新規作成）
     - 2. スキップ

   ケースD: ディレクトリまたはファイルが存在
   → ユーザーに確認
     - 1. 退避して新規作成
       - 退避先: .claude/skills.backup.{timestamp}
       - timestamp形式: YYYYMMDD-HHMMSS（例: 20260120-224500）
       - 衝突時: 連番付与（.backup.{timestamp}.1, .backup.{timestamp}.2）
     - 2. スキップ

4. リンク作成（実行時）
   - ln -s "../docs/aidlc/skills" ".claude/skills"
   - 注: -f オプションは使用しない（誤上書き防止）

5. 結果表示
   - 作成/スキップ/上書き/退避のステータス
```

**エラーハンドリング**:

| エラーケース | 対応 |
|-------------|------|
| mkdir .claude 失敗 | 警告を表示し、処理をスキップ（必須ではないため） |
| 既存リンク削除（rm）失敗 | エラーメッセージを表示し、処理をスキップ |
| 退避（mv）失敗 | エラーメッセージを表示し、処理をスキップ |
| ln コマンド失敗 | エラーメッセージを表示し、処理をスキップ |
| 権限不足 | 警告を表示し、手動でのリンク作成方法を案内 |

**注**: シンボリックリンク作成は必須ではないため、失敗時は処理を中断せずスキップする。
**注**: 他のAIツール（Codex、Gemini、KiroCLI等）の対応はUnit 003で実施。

## 変更箇所の詳細

### セクション8.2.2.4（新規追加）: スキルファイルの同期

```markdown
#### 8.2.2.4 スキルファイルの同期（rsync）

同様にドライラン → 確認 → 実行の手順で同期：

[ドライランコマンド]
[確認メッセージ]
[実行コマンド]
```

### セクション8.2.3 末尾（追加）: シンボリックリンク作成

```markdown
**Claude Code スキルファイルのシンボリックリンク作成**:

[ディレクトリ作成]
[既存確認と状態分岐]
[リンク作成処理]
```

### セクション8.3: 同期対象のファイル一覧

追加行:
```markdown
**skills/** → `docs/aidlc/skills/`:
- codex/SKILL.md, claude/SKILL.md, gemini/SKILL.md（AIスキルファイル）
```

### セクション10: 完了メッセージ

追加行（共通ファイル部分）:
```markdown
- skills/ - AIスキルファイル（codex, claude, gemini）
```

追加行（AIツール設定ファイル部分）:
```markdown
- .claude/skills → docs/aidlc/skills（シンボリックリンク）
```

## 非機能要件（NFR）への対応

### スケーラビリティ
- **要件**: 新しいスキル追加時に自動で対応
- **対応策**: ディレクトリ単位でrsync（個別ファイル指定なし）

### 冪等性
- **要件**: 再実行しても問題ない
- **対応策**:
  - rsyncの--checksum（同一内容はスキップ）
  - シンボリックリンクの存在確認と状態分岐

## 実装上の注意事項

1. **相対パスの使用**: シンボリックリンクは相対パスで作成し、環境依存を排除
2. **Gitで追跡可能**: 相対パスのシンボリックリンクはGitで追跡可能
3. **エラーハンドリング**: 各ステップで失敗時のメッセージを明確に

## 不明点と質問

なし（Unit定義で要件が明確）
