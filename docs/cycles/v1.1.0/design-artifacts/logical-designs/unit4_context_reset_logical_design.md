# 論理設計: コンテキストリセット提案機能

## 概要

フェーズ移行時およびUnit完了時に、コンテキストリセットを推奨するセクションを各プロンプトファイルに追加する。統一されたフォーマットで次アクション開始プロンプトを提示する。

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。具体的なコード（SQL、JSON、実装コード等）はImplementation Phase（コード生成ステップ）で作成します。

## アーキテクチャパターン

**テンプレートベースの統一フォーマット**: 各発動タイミングで同一構造のリセット提案セクションを使用し、変数部分（フェーズ名、プロンプトパス等）のみを差し替える。

## コンポーネント構成

### 対象ファイル構成

```
docs/aidlc/prompts/
├── inception.md      [変更] リセット提案セクション追加
├── construction.md   [変更] リセット提案セクション追加
└── operations.md     [変更] リセット提案セクション強化
```

### コンポーネント詳細

#### inception.md への追加
- **責務**: Inception Phase完了時にConstruction Phase開始を案内
- **追加位置**: 「## 次のステップ」セクションの前（または統合）
- **発動タイミング**: Inception Phase完了時（ステップ6完了後）

#### construction.md への追加
- **責務**:
  1. 単一Unit完了時に次Unit開始を案内
  2. 全Unit完了時にOperations Phase開始を案内
- **追加位置**: 「## Unit完了時の必須作業」セクション内および「## 次のステップ」セクション
- **発動タイミング**:
  - 各Unit完了時
  - 全Unit完了時

#### operations.md の強化
- **責務**: サイクル完了時に次サイクル開始を案内（既存セクションを強化）
- **変更位置**: 「## AI-DLCサイクル完了」セクション
- **発動タイミング**: Operations Phase完了時

## インターフェース設計

### リセット提案セクションの統一フォーマット

```markdown
---
## コンテキストリセット推奨

[完了メッセージ]が完了しました。コンテキストをリセットして次のステップを開始することを推奨します。

**理由**: 長い会話履歴はAIの応答品質を低下させる可能性があります。新しいセッションで開始することで、最適なパフォーマンスを維持できます。

**次のステップを開始するプロンプト**:
```markdown
以下のファイルを読み込んで、サイクル vX.X.X の [Phase名] を開始してください：
docs/aidlc/prompts/[phase].md
```
---
```

### 各発動タイミングの変数定義

| # | 発動タイミング | 完了メッセージ | 次のPhase | プロンプトパス |
|---|---------------|---------------|-----------|---------------|
| 1 | Inception完了 | Inception Phase | Construction Phase | construction.md |
| 2 | Unit完了 | Unit [名前] | （同フェーズ継続） | construction.md |
| 3 | 全Unit完了 | 全Unit | Operations Phase | operations.md |
| 4 | サイクル完了 | このサイクル | 次サイクル | setup-prompt.md |
| 5 | ユーザー要求 | （作業途中） | （同フェーズ継続） | 現在のフェーズのプロンプト |

## 処理フロー概要

### Inception Phase完了時の処理フロー

**ステップ**:
1. ステップ6（Construction用進捗管理ファイル作成）完了
2. 履歴記録とGitコミット完了
3. **リセット提案セクションを表示**
4. ユーザーがコンテキストをリセット
5. 提示されたプロンプトでConstruction Phase開始

### Unit完了時の処理フロー

**ステップ**:
1. Phase 2（実装）完了、実装記録作成
2. progress.md更新、履歴記録、Gitコミット完了
3. **リセット提案セクションを表示**（次Unitがある場合）
4. ユーザーがコンテキストをリセット
5. 提示されたプロンプトで次Unit開始

### 全Unit完了時の処理フロー

**ステップ**:
1. 最後のUnit完了
2. progress.md更新、履歴記録、Gitコミット完了
3. **リセット提案セクションを表示**（Operations Phase案内）
4. ユーザーがコンテキストをリセット
5. 提示されたプロンプトでOperations Phase開始

### サイクル完了時の処理フロー

**ステップ**:
1. Operations Phase全ステップ完了
2. フィードバック収集、分析完了
3. **リセット提案セクションを表示**（次サイクル案内）
4. ユーザーがコンテキストをリセット
5. 提示されたプロンプトで次サイクルセットアップ開始

### ユーザー要求時の処理フロー（作業途中でのリセット）

**トリガーキーワード**:
- 「継続プロンプト」「リセットしたい」
- 「コンテキストが溢れそう」「コンテキストオーバーフロー」
- 「長くなってきた」「一旦区切りたい」

**ステップ**:
1. ユーザーからリセット要求キーワードを検知
2. 現在の作業状態を確認（どのフェーズ、どのUnit、どのステップか）
3. **progress.mdを更新**（現在のステップを「進行中」として記録）
4. 履歴記録（history.mdに中断状態を追記）
5. **継続用プロンプトを表示**（現在のフェーズを継続するためのプロンプト）
6. ユーザーがコンテキストをリセット
7. 提示されたプロンプトで作業継続

**継続用プロンプトのフォーマット**:
```markdown
---
## コンテキストリセット - 作業継続

現在の作業状態を保存しました。コンテキストをリセットして作業を継続できます。

**現在の状態**:
- フェーズ: [Phase名]
- Unit: [Unit名]（Construction時のみ）
- ステップ: [ステップ名]

**作業を継続するプロンプト**:
```markdown
以下のファイルを読み込んで、サイクル vX.X.X の [Phase名] を継続してください：
docs/aidlc/prompts/[phase].md
```
---
```

## 各プロンプトファイルへの具体的な追加内容

### 1. inception.md への追加

**追加位置**: 「## 次のステップ」セクションを置き換え

**追加内容の概要**:
- リセット推奨の見出し
- Inception Phase完了メッセージ
- リセット推奨理由
- Construction Phase開始プロンプト（コピペ可能形式）

### 2. construction.md への追加

**追加位置1**: 「## Unit完了時の必須作業」セクションの末尾

**追加内容の概要**:
- リセット推奨の見出し
- Unit完了メッセージ
- リセット推奨理由
- 次Unit開始プロンプト（コピペ可能形式）

**追加位置2**: 「## 次のステップ」セクションを置き換え

**追加内容の概要**:
- 次Unitがある場合と全Unit完了の場合を分岐して記載
- 全Unit完了時はOperations Phase開始プロンプトを提示

### 3. operations.md の強化

**変更位置**: 「## AI-DLCサイクル完了」セクション内「### 4. 次のサイクル開始」を強化

**追加内容の概要**:
- リセット推奨の見出しを追加
- サイクル完了メッセージ
- リセット推奨理由
- 次サイクルセットアップ開始プロンプト（既存を整形）

### 4. 全プロンプトファイル共通：ユーザー要求時のリセット対応

**追加位置**: 各プロンプトファイルの「## 開発ルール」セクション内、または新規セクション

**追加内容の概要**:
- トリガーキーワードの定義
- 検知時の対応手順（progress.md更新、履歴記録、継続プロンプト提示）
- 継続用プロンプトのフォーマット

## 非機能要件（NFR）への対応

### パフォーマンス
- **要件**: 特になし
- **対応策**: 該当なし（静的テキストの追加のみ）

### セキュリティ
- **要件**: 特になし
- **対応策**: 該当なし

### スケーラビリティ
- **要件**: 特になし
- **対応策**: 該当なし

### 可用性
- **要件**: 特になし
- **対応策**: 該当なし

## 技術選定
- **言語**: Markdown
- **フレームワーク**: なし
- **ライブラリ**: なし
- **データベース**: なし

## 実装上の注意事項

1. **サイクルバージョンの動的表示**: プロンプト内のサイクルバージョン（vX.X.X）は実際の運用時にユーザーが適切な値に置き換える必要がある。プロンプト内では `vX.X.X` のようなプレースホルダー形式で記載する。

2. **既存セクションとの整合性**: 既存の「次のステップ」セクションの内容を保持しつつ、リセット推奨メッセージを追加する。冗長にならないよう統合する。

3. **コピペ可能性の確保**: 次アクションプロンプトはMarkdownコードブロック内に記載し、ユーザーがそのままコピペできるようにする。

## 不明点と質問（設計中に記録）

[Question] 概念モデルとして設計するか、簡略化するか
[Answer] 概念モデルとして設計する（選択肢1）

[Question] フェーズ途中でコンテキストが足りなくなった場合の対応は？キーワードでプロンプトを出すこともできるか？
[Answer] ユーザーが「継続プロンプト」「コンテキストオーバーフロー」「コンテキストが溢れそう」などのキーワードを発言した場合、現在の作業状態に応じた継続用プロンプトを出力する機能を追加する。その際、progress.mdを先に更新してから継続プロンプトを提示する。

---

*設計完了: 論理設計のコンポーネント構成とインターフェース定義*
