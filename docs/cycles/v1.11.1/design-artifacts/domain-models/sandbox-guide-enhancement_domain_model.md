# ドメインモデル: サンドボックス環境ガイド補完

## 概要

サンドボックス環境ガイドに追加する概念の整理。

## エンティティ・値オブジェクト

### 認証方式（AuthenticationMethod）

AIツールがバックエンドAPIと通信するための認証方式。

| 認証方式 | 説明 | 特徴 |
|---------|------|------|
| API Key | APIキーをHTTPヘッダーで送信 | シンプル、環境変数で管理可能 |
| OAuth | ブラウザでログイン→トークン取得 | サブスク契約で使用、トークン管理が必要 |

### 各ツールの認証方式

**注意**: 認証情報の保存先はツールのバージョンや環境により異なる場合があります。実装時は各ツールの公式ドキュメントと `--help` / `auth status` コマンドで確認してください。

| ツール | API Key | OAuth | 認証情報保存先（参考） |
|--------|---------|-------|---------------------|
| Claude Code | `ANTHROPIC_API_KEY` | claude.ai Pro/Team | `~/.claude/`（要確認） |
| Codex CLI | `OPENAI_API_KEY` | ChatGPT Plus等 | `~/.codex/`（要確認） |
| KiroCLI | - | Amazon Q Developer | `~/.kiro/`（要確認） |

**認証情報保存先の確認方法**:
- Claude Code: `claude auth status` または `ls ~/.claude/`
- Codex CLI: `codex auth status` または `ls ~/.codex/`
- KiroCLI: `kiro auth status` または `ls ~/.kiro/`

### サンドボックスレベル（SandboxLevel）

保護の実装レベルによる分類。

| レベル | 説明 | 実装例 |
|--------|------|--------|
| アプリケーションレベル | ツール内蔵の権限制御 | Claude Codeのパーミッション、Codexの`--sandbox` |
| OSレベル | OS/コンテナによる隔離 | Docker、chroot、VM |

### 保護範囲（ProtectionScope）

各レベルが保護する範囲。**実際の保護レベルは構成や設定に依存**します。

| 保護対象 | アプリレベル | OSレベル（Docker等） |
|---------|-------------|---------------------|
| ファイルシステム | ツール経由のみ（制約弱） | 構成次第で強い制約可能 |
| ネットワーク | 通常は制御困難 | 構成次第で制御可能 |
| プロセス | 通常は制御困難 | 構成次第で隔離可能 |
| 環境変数 | ツールにより異なる | 構成次第で隔離可能 |

**注意**:
- アプリレベルでも一部ツールはネットワーク制限や環境変数マスク機能を持つ場合がある
- OSレベル（Docker）でも適切な設定（`--network none`、`:ro`マウント等）がなければ保護されない

## OAuth認証のDocker利用時の課題

### 共通課題

| 課題 | 説明 | 解決策 |
|------|------|--------|
| ブラウザ認証 | コンテナ内からブラウザ起動が困難 | ホストで事前認証 |
| トークン永続化 | コンテナ終了時に認証情報が失われる | 認証ディレクトリをマウント |
| トークン更新 | 一部ツールはトークン更新時に書き込みが必要 | 更新時は`:rw`、通常は`:ro`運用 |

### ツール別の注意点

| ツール | 認証保存先の探索方法 | 付随ファイル | 権限の注意点 |
|--------|---------------------|-------------|-------------|
| Claude Code | `claude auth status`、`~/.claude/` | 設定ファイル含む可能性 | UID一致推奨（代替: `--group-add`） |
| Codex CLI | `codex auth status`、`~/.codex/` | config.toml等 | UID一致推奨（代替: volume権限調整） |
| KiroCLI | `kiro auth status`、`~/.kiro/` | AWS認証情報連携の可能性 | UID一致推奨（代替: `--group-add`） |

**注意**: 各ツールの仕様変更により、保存先や必要ファイルが変わる可能性があります。

## 用語集

| 用語 | 定義 |
|------|------|
| サブスクリプション契約 | claude.ai Pro/Team、ChatGPT Plus等の月額課金プラン |
| API契約 | API使用量に応じた従量課金プラン |
| 認証ディレクトリ | OAuth認証情報が保存されるディレクトリ（`~/.claude/`等） |
