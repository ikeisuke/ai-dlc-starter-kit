# Unit 002: ユーザー共通設定 - 実装計画

## 概要

`~/.aidlc/config.toml`によるユーザー共通設定機能を実装する。複数プロジェクトで共通の設定を一元管理できるようにし、3階層（ホーム < プロジェクト < .local）のマージを実現する。

## 変更対象ファイル

### 修正

| ファイル | 変更内容 |
|----------|----------|
| `prompts/package/bin/read-config.sh` | ホームディレクトリ設定（`~/.aidlc/config.toml`）の読み込み追加、3階層マージ対応 |
| `prompts/package/guides/config-merge.md` | 3階層マージの説明を追加 |
| `prompts/package/prompts/inception.md` | セットアップ時の`~/.aidlc/`作成案内を追加 |

### 新規作成（オプション）

| ファイル | 説明 |
|----------|------|
| なし | 既存ファイルの修正のみ |

## 実装計画

### Phase 1: 設計

1. **ドメインモデル設計**
   - 3階層設定マージのルール定義
   - 優先順位: `~/.aidlc/config.toml` < `docs/aidlc.toml` < `docs/aidlc.toml.local`
   - ホームディレクトリ取得方法（環境変数HOME）

2. **論理設計**
   - `read-config.sh`の処理フロー拡張
   - config-merge.mdの更新構造
   - inception.mdへの案内追加箇所

### Phase 2: 実装

1. **read-config.sh修正**
   - ホームディレクトリ設定ファイルパス（`$HOME/.aidlc/config.toml`）の追加
   - 3階層マージロジック実装（ホーム → プロジェクト → .local の順で読み込み）
   - ホームディレクトリファイル不在時のフォールバック（現状動作を維持）

2. **config-merge.md更新**
   - 設定ファイル階層表に`~/.aidlc/config.toml`を追加
   - 3階層マージの説明を追加
   - 使用例の更新

3. **inception.md更新**
   - セットアップ完了時に`~/.aidlc/`作成案内を追加
   - テンプレート作成オプションの提供

## 完了条件チェックリスト

- [ ] ~/.aidlc/config.tomlファイルの読み込みロジック追加
- [ ] 3階層設定マージ（ホーム < プロジェクト < .local）
- [ ] セットアップ時の~/.aidlc/作成案内

## 設計判断ポイント

### 環境変数の使用

- `$HOME`環境変数を使用してホームディレクトリを特定
- `$HOME`が未設定の場合はホーム設定をスキップ（エラーにしない）

### ファイル不在時の挙動

- `~/.aidlc/config.toml`が存在しない場合: 警告なしでスキップ（正常動作）
- `~/.aidlc/`ディレクトリが存在しない場合: 同様にスキップ

### セットアップ案内のタイミング

- Inception Phase完了時（セットアップ完了後）に案内
- オプションとして案内（必須ではない）

## 技術的注意事項

- **メタ開発**: `prompts/package/`を編集し、`docs/aidlc/`は直接編集しない
- **後方互換性**: 既存の2階層マージ（プロジェクト + .local）の挙動を維持
- **Windows非対応**: 現時点ではUnix系環境のみ対応（将来対応は別Unit）

## 依存関係の確認

### Unit 001: プロジェクト個人設定（完了済み）

`prompts/package/bin/read-config.sh`が実装済み。本Unitでは以下の関数・処理を拡張:
- `get_value()`: 設定値取得関数（変更なし、再利用）
- `strip_quotes()`: クォート除去関数（変更なし、再利用）
- メイン処理: 2階層（プロジェクト + .local）→ 3階層（ホーム + プロジェクト + .local）に拡張

### Unit 003: Setup/Inception統合（完了済み）

`prompts/package/prompts/inception.md`が統合後の形式で存在。本Unitで`~/.aidlc/`作成案内を追加可能。

## NFR対応

### パフォーマンス（追加遅延の回避）

- ホームディレクトリ設定ファイルの存在確認は`[[ -f "$file" ]]`で最小限に
- ファイルが存在しない場合は即座にスキップ（dasel呼び出しなし）
- 既存の2階層処理と同様のパターンで実装し、オーバーヘッドを最小化
