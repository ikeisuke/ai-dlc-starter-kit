# 実装記録: setup-prompt.md改善

## 実装日時
2025-12-24 14:32 JST 〜 2025-12-24 23:06 JST

## 作成ファイル

### ソースコード
- `prompts/package/prompts/setup.md` - デプロイ済みファイル確認ステップ追加、ケースC完了メッセージ修正

### テスト
- 自動テストなし（手動テストシナリオを下記に記載）

### 設計ドキュメント
- `docs/cycles/v1.5.2/design-artifacts/domain-models/setup_prompt_domain_model.md`
- `docs/cycles/v1.5.2/design-artifacts/logical-designs/setup_prompt_logical_design.md`

## 変更内容

### 変更箇所1: ステップ0「デプロイ済みファイル確認」追加
- **挿入位置**: 「## 最初に必ず実行すること」の直後、「### 1. スターターキットバージョン確認」の前
- **内容**:
  - `[ -f docs/aidlc/prompts/setup.md ]`で存在確認
  - 不在の場合: ガイダンスメッセージ表示後、ステップ1へ進む

### 変更箇所2: ケースC完了メッセージ修正
- **修正位置**: 「LATEST_VERSION = CURRENT_VERSION」の処理
- **変更前**: 「ステップ2（サイクルバージョンの決定）へ進む」
- **変更後**: アップグレード不要メッセージと次回案内を表示後、ステップ2へ進む

## テストシナリオ（手動テスト）

### シナリオ1: デプロイ済みファイルが存在する場合
**前提条件**: `docs/aidlc/prompts/setup.md`が存在する
**手順**:
1. AIに「prompts/package/prompts/setup.mdを読み込んでサイクルを開始して」と指示
2. AIがステップ0を実行
**期待結果**:
- `DEPLOYED_EXISTS`と判定される
- ステップ1（スターターキットバージョン確認）へ進む
- ガイダンスメッセージは表示されない

### シナリオ2: デプロイ済みファイルが存在しない場合
**前提条件**: `docs/aidlc/prompts/setup.md`が存在しない
**手順**:
1. 一時的に`docs/aidlc/prompts/setup.md`を削除またはリネーム
2. AIに「prompts/package/prompts/setup.mdを読み込んでサイクルを開始して」と指示
3. AIがステップ0を実行
**期待結果**:
- `DEPLOYED_NOT_EXISTS`と判定される
- 以下のガイダンスメッセージが表示される:
  ```
  【お知らせ】docs/aidlc/prompts/setup.md が見つかりません。

  アップグレードせずにサイクルを開始する場合は、以下のファイルを参照してください：
  prompts/package/prompts/setup.md

  このファイルには setup.md の最新版が含まれています。
  現在このファイルを使用しているため、処理を続行します。
  ```
- ステップ1（スターターキットバージョン確認）へ進む

### シナリオ3: ケースC（バージョン同じ）の場合
**前提条件**: `LATEST_VERSION = CURRENT_VERSION`
**手順**:
1. AIに「prompts/package/prompts/setup.mdを読み込んでサイクルを開始して」と指示
2. バージョン確認でLATEST_VERSION = CURRENT_VERSIONとなる
**期待結果**:
- 以下のメッセージが表示される:
  ```
  アップグレードは不要です（現在最新バージョンです）。
  次回サイクル開始時も、このsetup.mdを参照してください。
  ```
- ステップ2（サイクルバージョンの決定）へ進む

## ビルド結果
該当なし（Markdownドキュメントのため）

## テスト結果
手動テスト未実施（次回サイクルセットアップ時に検証予定）

- 実行テスト数: 0
- 成功: 0
- 失敗: 0

## コードレビュー結果
- [x] セキュリティ: OK（ローカルファイルシステムの読み取りのみ）
- [x] コーディング規約: OK（既存のsetup.mdスタイルに準拠）
- [x] エラーハンドリング: OK（ファイル不在は正常系として処理）
- [x] テストカバレッジ: N/A（手動テストシナリオを作成）
- [x] ドキュメント: OK（設計ドキュメント作成済み）

## 技術的な決定事項

1. **ファイル不在時の処理**:
   - 正常終了ではなく、処理を続行する方針を採用
   - 理由: ユーザーがすでに`prompts/package/prompts/setup.md`を読み込んでいる場合、終了は不自然

2. **メッセージトーン**:
   - 「エラー」ではなく「お知らせ」として表示
   - 理由: ファイル不在は正常系として扱う（Codex MCPレビュー指摘への対応）

3. **挿入位置**:
   - スターターキットバージョン確認の前（ステップ0）に配置
   - 理由: デプロイ状態の確認は最初に行うべき

## 課題・改善点

1. **手動テスト**:
   - 次回サイクルセットアップ時に実際の動作を検証する必要がある

2. **反映タイミング**:
   - この変更は`prompts/package/`への編集であり、`docs/aidlc/`への反映は次回Operations Phaseのrsync実行時

## 状態
**完了**

## 備考
- Codex MCPレビューを実施し、指摘事項を反映して設計を修正
- メタ開発の意識に従い、`prompts/package/prompts/setup.md`を編集（`docs/aidlc/`ではない）
