# 論理設計: AIレビュー設定改善

## 概要

AIレビュー設定をSkills優先（MCPフォールバック）方式に改善し、様々なツール環境で一貫して利用できるようにする。

**注**: このUnitは実装コードではなく、プロンプト（Markdownファイル）の修正であるため、簡略化した論理設計を記載する。

## アーキテクチャパターン

フォールバックパターン（Fallback Pattern）を採用:
- Skills利用可能 → Skillsを使用
- Skills利用不可 → MCPにフォールバック
- MCP利用不可 → 人間レビューにフォールバック

## コンポーネント構成

### 対象ファイル

```text
prompts/package/prompts/
├── inception.md      # AIレビュー優先ルールセクション修正
├── construction.md   # AIレビュー優先ルールセクション修正 + 反復レビュー改善
└── operations.md     # AIレビュー優先ルールセクション修正
```

### 修正箇所詳細

| ファイル | 現在の行範囲 | 修正内容 |
|----------|-------------|----------|
| inception.md | 117-209行目付近 | Skills優先フローに変更 |
| construction.md | 200-296行目付近 | Skills優先フロー + 反復レビュー改善 |
| operations.md | 120-212行目付近 | Skills優先フローに変更 |

## 処理フロー概要

### 新しいAIレビューフロー

**ステップ**:

1. **mode確認**: `docs/aidlc.toml` を読んで `[rules.mcp_review].mode` を確認
   - 空または取得失敗時は「recommend」として扱う
   - `disabled` の場合: 人間レビューフローへ
   - `required` または `recommend` の場合: 次のステップへ

2. **AIレビューツール利用可否チェック（Skills優先）**:
   - **Skills確認**: Skillツール一覧から `codex` スキルが利用可能か確認（スキル名は `codex` 固定）
   - **利用可能**: Skillsを使用してレビューへ
   - **利用不可**: MCPフォールバックへ
   - **判定方法（環境依存）**:
     - **Claude Code**: Skillツールが存在し、`skill="codex"`で呼び出し可能かを確認
     - **KiroCLI等の他環境**: Skill一覧取得APIがあればそれを利用、なければMCPフォールバックへ直接進む

3. **MCPフォールバック**:
   - **MCP確認**: Codex MCPツール（`mcp__codex__codex`）が利用可能か確認
   - **利用可能**: MCPを使用してレビューへ
   - **利用不可**: AIレビュー不可処理へ

4. **AIレビュー不可時の処理**（Skills/MCP両方利用不可の場合）:
   - `mode = "required"` の場合:
     - ユーザーに確認を求める:「AIレビューツールが利用できません。人間レビューに進みますか？」
     - ユーザーが承認した場合: 履歴に「AIレビュースキップ（ツール利用不可、ユーザー承認済み）」と記録し、人間レビューへ
     - ユーザーが拒否した場合: 処理を中断し、ユーザー再指示待ち状態へ（AIレビューツールの環境設定を依頼するか、別の対応を検討）
   - `mode = "recommend"` の場合: 自動的に人間レビューフローへ

5. **AIレビュー実行**（Skills または MCP）:
   - レビュー前コミット（変更がある場合）
   - **反復レビュー**:
     - レビューを実行
     - 指摘があれば修正
     - 指摘がゼロになるまで繰り返す（**1セット最大3回**）
     - **3回後も指摘が残る場合**: ユーザーに継続確認を求める（新規追加）
     - **ユーザーが継続を選択した場合**: 追加で最大3回のレビューを実施
     - **合計上限**: 最大6回（3回×2セット）で終了、それでも残る指摘は人間確認へ
   - レビュー後コミット（修正があった場合）

6. **人間レビューフロー**: 現状維持

### 反復レビュー継続確認フロー（新規）

**トリガー**: 3回のレビュー後もなお指摘が残る場合

**確認メッセージ**:
```text
【確認】AIレビューを3回実施しましたが、まだ指摘が残っています。

残りの指摘:
- [指摘1]
- [指摘2]

どのように進めますか？
1. レビューを継続する（さらに3回まで）
2. 人間が残りの指摘を確認する
```

**処理**:
- 「継続」選択時: さらに3回までレビューを繰り返す
- 「人間確認」選択時: 残りの指摘を人間に提示

## インターフェース設計

### Skills呼び出し

```text
Skill tool: skill="codex"
prompt: "以下の成果物をレビューしてください: {対象ファイル}"
```

### MCPフォールバック呼び出し

```text
mcp__codex__codex ツールを使用
prompt: "以下の成果物をレビューしてください: {対象ファイル}"
```

## 設定項目

既存の `[rules.mcp_review]` 設定をそのまま使用:
- `mode = "required"`: AIレビュー必須（**AIレビューツールが両方利用不可の場合、ユーザー承認により例外的に人間レビューへ移行可能。承認は履歴に記録する**）
- `mode = "recommend"`: AIレビュー推奨（デフォルト）
- `mode = "disabled"`: AIレビューを行わない（**AIレビューをスキップし、直接人間レビューへ進む**）

**設定名据え置きの理由と注意事項**:
- 設定項目名（`mcp_review`）は後方互換性のため変更しない
- ドキュメント・設定ファイルのマイグレーションが不要となる利点がある
- **重要**: 実際の動作はSkills優先に変更される。既存の「MCPレビュー」と解釈しているユーザーに対し、プロンプト内で「AIレビュー（Skills優先、MCPフォールバック）」と明記して周知する

## 外部入力検証ルール

「AI MCP応答の検証」セクションを「AIレビュー応答の検証」に名称変更:
- MCPだけでなくSkillsの応答も対象とする
- 検証ロジック自体は現状維持

## 実装上の注意事項

1. **後方互換性**: 設定項目名 `mcp_review` は変更しない
2. **一貫性**: 3ファイル間で記述を統一する
3. **rules.md との整合性**: `docs/cycles/rules.md` の記述と矛盾しないこと

## 不明点と質問

（特になし - 計画承認時に確認済み）
