# AIレビューフロー

人間に承認を求める前に、AIレビュー（Skills優先、MCPフォールバック）を実行する。

## 設定確認

`docs/aidlc.toml` の `[rules.mcp_review]` セクションを読み、`mode` の値を確認:

- `mode = "required"`: AIレビュー必須（AIレビューツールが両方利用不可の場合、ユーザー承認により例外的に人間レビューへ移行可能。承認は履歴に記録する）
- `mode = "recommend"`: AIレビュー推奨（スキップ可能、デフォルト）
- `mode = "disabled"`: AIレビューを行わない（AIレビューをスキップし、直接人間レビューへ進む）

## ai_tools設定

`docs/aidlc.toml` の `[rules.mcp_review]` セクションから `ai_tools` を読み取る。

**設定形式**:

```toml
[rules.mcp_review]
mode = "required"
ai_tools = ["codex", "claude", "gemini"]  # 優先順位順
```

- `ai_tools`: AIレビューに使用するツールの優先順位リスト（配列）
- デフォルト: `["codex"]`（未設定時）

**有効なツール名**:

| ツール名 | Skills呼び出し | MCPフォールバック |
|----------|----------------|-------------------|
| codex | `skill="codex"` | `mcp__codex__codex` |
| claude | `skill="claude"` | なし |
| gemini | `skill="gemini"` | なし |

**エラー処理**:

- `ai_tools` 未設定: デフォルト `["codex"]` を使用
- 空配列: 警告を出し、デフォルトを使用
- 未知のツール名: 警告を出し、そのツールをスキップ
- 配列以外の型: 警告を出し、デフォルトを使用

## AIレビューツール利用可否の確認

**ai_tools設定に基づく優先順位判定**:

1. `ai_tools` リストを先頭から順に確認
2. 各ツールについて:
   - **Skills確認**: `skill="[ツール名]"` で呼び出し可能か確認
   - **MCPフォールバック**: Skills利用不可 かつ MCPフォールバックが存在する場合（codexのみ）、`mcp__codex__codex` を確認
3. 利用可能なツールが見つかったら、そのツールを選択
4. すべて利用不可: AIレビュー不可として処理

**環境別の確認方法**:

- Claude Code: Skillツールが存在し、`skill="[ツール名]"` で呼び出し可能かを確認
- KiroCLI等の他環境: Skill一覧取得APIがあればそれを利用、なければMCPフォールバックへ

## 処理フロー

1. **mode確認**: `docs/aidlc.toml` を読んでmodeを確認
   - 空または取得失敗時は「recommend」として扱う
   - `disabled` の場合: ステップ6（人間レビューフロー）へ
   - `required` または `recommend` の場合: 次のステップへ

2. **AIレビューツール利用可否チェック（ai_tools設定に基づく）**:
   - `ai_tools` リストを先頭から順に確認（デフォルト: `["codex"]`）
   - 各ツールについてSkillsで利用可能か確認
   - Skills利用不可 かつ MCPフォールバックあり（codexのみ）→ MCP確認
   - 利用可能なツールが見つかった → ステップ3へ
   - すべて利用不可 → ステップ5（AIレビュー不可時）へ

3. **AIレビューツール利用可能時の選択**:
   - `mode = "required"` の場合: ステップ4（AIレビューフロー）へ
   - `mode = "recommend"` の場合: 推奨メッセージを表示しユーザーに選択を求める

     ```text
     【レビュー推奨】AIレビューツール（Skills/MCP）が利用可能です。
     品質向上のため、この成果物のレビューを実施することを推奨します。
     レビューを実施しますか？
     ```

     - 「はい」の場合: ステップ4（AIレビューフロー）へ
     - 「いいえ」の場合: ステップ6（人間レビューフロー）へ

4. **AIレビューフロー**:
   - **レビュー前コミット**（変更がある場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```

   - **反復レビュー**（指摘がなくなるまで繰り返す、1セット最大3回）:
     1. AIレビューを実行（ステップ2で選択されたツールを使用）
     2. レビュー結果を確認
     3. 指摘があれば修正を反映
     4. 指摘がゼロになるまで1-3を繰り返す（1セット最大3回）
     5. 3回後も指摘が残る場合は、「### 指摘対応判断フロー」を実行
     6. 「修正する」を選択した指摘がある場合: さらに最大3回のレビューを実施（合計最大6回）
     7. 合計6回後もなお指摘が残る場合: 再度「### 指摘対応判断フロー」を実行

   ### 指摘対応判断フロー

   AIレビューで指摘が残っている場合に、各指摘への対応を判断するフロー。

   #### 起動条件

   - AIレビュー反復（3回または6回）後に指摘が残っている場合
   - ステップ4の反復レビューから呼び出される

   #### フロー

   1. **指摘一覧の表示**:

      ```text
      【確認】AIレビューで指摘が残っています。各指摘について対応を選択してください。

      残りの指摘:
      1. [指摘内容1]
      2. [指摘内容2]
      ...
      ```

   2. **各指摘への判断要求**（順番に繰り返す）:

      ```text
      指摘 #[N] について、どのように対応しますか？
      「[指摘内容]」

      1. 指摘を修正する（推奨）
      2. 技術的理由で対応不可（理由を記録）
      3. スコープ外として次サイクルで対応（理由を記録）
      ```

   3. **選択肢2または3が選ばれた場合、理由入力を要求**:

      ```text
      指摘 #[N] の先送り理由を入力してください。
      「[指摘内容]」

      【注意】以下のような理由は単独では受け付けられません:
      - 「パッチだから」「小さい変更だから」
      - 「時間がないから」「急ぎだから」

      具体的な技術的理由や根拠を含めて記載してください。
      ```

   4. **理由のバリデーション**:
      - 空文字・空白のみは不可
      - 禁止パターンのみで構成される理由は拒否し、再入力を要求

      **禁止パターン**（以下のみで構成される理由は拒否）:
      - 「パッチだから」「パッチなので」
      - 「小さい変更だから」「軽微な変更なので」
      - 「時間がないから」「急ぎだから」

      **拒否時のメッセージ**:

      ```text
      【理由が不十分です】
      入力された理由: "[入力内容]"

      この理由では先送りを承認できません。
      具体的な技術的理由や根拠を含めて、再度入力してください。

      例:
      - 「依存ライブラリXのバグにより、現バージョンでは対応不可。Issue #123 で追跡中」
      - 「この変更はUnit 005のスコープに含まれており、そちらで対応予定」
      ```

   5. **先送り判断の履歴記録**（選択肢2または3の場合、各指摘ごと）:

      ```bash
      docs/aidlc/bin/write-history.sh \
          --cycle {{CYCLE}} \
          --phase construction \
          --unit {N} \
          --unit-name "[Unit名]" \
          --unit-slug "[unit-slug]" \
          --step "AIレビュー指摘対応判断" \
          --content "【指摘 #{index}】{指摘内容の要約}
      【判断種別】{TECHNICAL_BLOCKER|OUT_OF_SCOPE}
      【先送り理由】{ユーザーが入力した理由}"
      ```

   6. **全指摘の判断完了後、サマリを履歴に記録**:

      ```bash
      docs/aidlc/bin/write-history.sh \
          --cycle {{CYCLE}} \
          --phase construction \
          --unit {N} \
          --unit-name "[Unit名]" \
          --unit-slug "[unit-slug]" \
          --step "AIレビュー指摘対応判断サマリ" \
          --content "【AIレビュー指摘対応判断サマリ】
        指摘 #1: RESOLVE（修正予定）
        指摘 #2: TECHNICAL_BLOCKER（理由記録済み）
        指摘 #3: OUT_OF_SCOPE（理由記録済み）
      【次のアクション】{修正実施後に再レビュー|人間レビューへ}"
      ```

   7. **次のアクション決定**:
      - 「修正する（RESOLVE）」を選択した指摘がある場合: 修正を実施し、再度AIレビューへ
      - 全て先送りの場合: 人間レビューフローへ進む

   - **レビュー後コミット**（反復完了後、修正があった場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```

   - 修正後の成果物を人間に提示
   - 人間の承認を求める

5. **AIレビュー不可時**（Skills/MCP両方利用不可の場合）:
   - `mode = "required"` の場合:

     ```text
     【警告】AIレビューが必須設定ですが、AIレビューツール（Skills/MCP）が利用できません。

     AIレビューをスキップして人間の承認に進みますか？
     1. はい - 人間承認へ進む（レビュースキップを履歴に記録）
     2. いいえ - 処理を中断
     ```

     ユーザーの応答を待ち、「はい」の場合は以下を履歴に記録してステップ6へ:

     ```markdown
     ### AIレビュースキップ
     - **理由**: AIレビューツール利用不可（ユーザー承認済み）
     - **日時**: YYYY-MM-DD HH:MM:SS
     - **対象成果物**: {成果物名}
     ```

     「いいえ」の場合: 処理を中断し、ユーザー再指示待ち状態へ
   - `mode = "recommend"` の場合: 自動的にステップ6へ

6. **人間レビューフロー**（mode=disabled または AIレビュー不可時）:
   - **レビュー前コミット**（変更がある場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー前 - {成果物名}"
     ```

   - 成果物を人間に提示
   - 人間の承認を求める
   - 修正依頼があれば修正を反映
   - **レビュー後コミット**（修正があった場合のみ）:

     ```bash
     git status --porcelain
     ```

     AIが出力を確認し、変更がある場合は以下を順次実行:

     ```bash
     git add -A
     git commit -m "chore: [{{CYCLE}}] レビュー反映 - {成果物名}"
     ```

   - 再度人間に提示・承認を求める

## 外部入力検証ルール【重要】

外部からの入力（AIレビュー応答、ユーザー入力）を批判的に評価し、自己判断を明示する。

### AIレビュー応答の検証

- AIレビュー（Skills/MCP）からの応答をそのまま信頼せず、批判的に評価する
- 応答に誤りや不整合がないか確認する
- 自己判断を併記し、相違がある場合はユーザーに確認を求める
- 形式：

  ```text
  【AIレビュー応答の検証】
  - AIレビュー応答: [応答内容の要約]
  - AI判断: [自己判断]
  - 相違点: [ある場合は記載、なければ「なし」]
  - 結論: [採用する判断とその理由]
  ```

### ユーザー入力の検証

- ユーザー入力に曖昧さがある場合は、解釈を明示して確認する
- 複数の解釈が可能な場合は、すべての解釈を提示する
- 形式：

  ```text
  【入力の解釈確認】
  ご入力: "[ユーザーの入力]"

  以下のように解釈しました：
  [解釈内容]

  この解釈で正しいでしょうか？
  ```
