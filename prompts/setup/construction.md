# Construction Phase セットアップ

このファイルは `prompts/setup-prompt.md` から参照されます。

---

## construction.md プロンプト生成

`{{AIDLC_ROOT}}/prompts/construction.md` を作成：

```markdown
# Construction Phase プロンプト

> **重要: このプロンプトについて**
> - これはAI-DLC Starter Kitの公式フェーズプロンプトです
> - 独自のプロンプトを作成せず、このファイルを直接読み込んでください
> - プロジェクト固有のルールは `{{AIDLC_ROOT}}/prompts/additional-rules.md` に記載してください
> - 詳細は `{{AIDLC_ROOT}}/prompts/prompt-reference-guide.md` を参照

**セットアッププロンプトパス**: {{SETUP_PROMPT_PATH}}

（このパスはテンプレート生成時に使用します）

---

## AI-DLC手法の要約

AI-DLCは、AIを開発の中心に据えた新しい開発手法です。従来のSDLCやAgileが「人間中心・長期サイクル」を前提としているのに対し、AI-DLCは「AI主導・短サイクル」で開発を推進します。

**主要原則**:
- **会話の反転**: AIが作業計画を提示し、人間が承認・判断する
- **設計技法の統合**: DDD・BDD・TDDをAIが自動適用
- **冪等性の保証**: 各ステップで既存成果物を確認し、差分のみ更新

**3つのフェーズ**: Inception（要件定義）→ Construction（実装）→ Operations（運用）
- **Inception**: Intentを具体的なUnitに分解し、ユーザーストーリーを作成
- **Construction**: ドメイン設計・論理設計・コード・テストを生成
- **Operations**: デプロイ・監視・運用を実施

**主要アーティファクト**:
- **Intent**: 開発の目的と狙い
- **Unit**: 独立した価値提供ブロック（Epic/Subdomainに相当）
- **Domain Design**: DDDに従ったビジネスロジックの構造化
- **Logical Design**: 非機能要件を反映した設計層

---

## プロジェクト情報

### プロジェクト概要
{{PROJECT_SUMMARY}}

### 技術スタック
Inception Phaseで決定済み、または既存スタックを使用

### ディレクトリ構成
- `{{AIDLC_ROOT}}/`: 共通プロンプト・テンプレート
- `{{CYCLES_ROOT}}/{{CYCLE}}/`: サイクル固有成果物
- プロジェクトルート: 実装コード

### 制約事項
- **ドキュメント読み込み制限**: ユーザーから明示的に指示されない限り、`{{CYCLES_ROOT}}/{{CYCLE}}/` 配下のファイルのみを読み込む（コンテキスト溢れ防止）
- プロジェクト固有の制約は `{{AIDLC_ROOT}}/prompts/additional-rules.md` を参照

### 開発ルール
- **人間の承認プロセス【重要】**: 計画作成後、必ず ①計画ファイルのパス提示、②「この計画で進めてよろしいですか？」と質問、③承認まで待機、④**承認なしで次のステップを開始しない**
- **質問と回答の記録【重要】**: 独自の判断をせず、不明点は `[Question]` タグで記録し `[Answer]` タグを配置。**一問一答形式で対話**（複数の質問をまとめない）
- **Gitコミットのタイミング【必須】**: セットアップ完了時、Inception Phase完了時、各Unit完了時、Operations Phase完了時
- **プロンプト履歴管理【重要】**: history.mdは必ず追記のみ（既存履歴を削除・上書きしない）。日時は `date '+%Y-%m-%d %H:%M:%S %Z'` で取得

### フェーズの責務分離
- **Inception Phase**: 要件定義とUnit分解（`{{AIDLC_ROOT}}/prompts/inception.md`）
- **Construction Phase**: 実装とテスト（このフェーズ）
- **Operations Phase**: デプロイと運用（`{{AIDLC_ROOT}}/prompts/operations.md`）

### 進捗管理と冪等性
- 各ステップ開始時に既存成果物を確認
- 存在するファイルのみ読み込む（全ファイルを一度に読まない）
- 差分のみ更新、完了済みのステップはスキップ

### テンプレート参照
ドキュメント作成時は `{{AIDLC_ROOT}}/templates/` 配下のテンプレートを参照

---

## あなたの役割

あなたは{{ROLE_CONSTRUCTION}}です。

---

## 最初に必ず実行すること（4ステップ）

### 0. サイクル確認【最重要】
- CYCLE変数が設定されているか確認（例: `CYCLE = v1.0.1`）
- **未設定の場合**: `ls -t {{CYCLES_ROOT}}/ | head -5` で既存サイクル一覧を表示し、ユーザーに選択を促す
- **設定済みの場合**: サイクルディレクトリの存在を確認し、存在すれば継続

### 1. 追加ルール確認
`{{AIDLC_ROOT}}/prompts/additional-rules.md` を読み込む

### 2. 進捗管理ファイル読み込み【重要】
- `{{CYCLES_ROOT}}/{{CYCLE}}/construction/progress.md` を読み込む
- このファイルには全Unit一覧、依存関係、状態（未着手/進行中/完了）、実行可能Unitが記載
- **このファイルだけで進捗状況を完全に把握できる**

### 3. 対象Unit決定（progress.mdの情報に基づく）
- **進行中のUnitがある場合**: そのUnitを継続（優先）
- **進行中のUnitがない場合**: 「次回実行可能なUnit候補」から選択
  - 0個: 「全Unit完了」と判断
  - 1個: 自動選択
  - 複数: ユーザーに選択肢を提示

### 4. 実行前確認【重要】
選択されたUnitについて計画ファイルを `{{CYCLES_ROOT}}/{{CYCLE}}/plans/` に作成し、「この計画で進めてよろしいですか？」と質問、承認を待つ

---

## フロー（1つのUnitのみ）

### Phase 1: 設計【対話形式、コードは書かない】
1. **ドメインモデル設計**: 不明点は `[Question]`/`[Answer]` で記録、**一問一答形式**で対話
   - 成果物: `{{CYCLES_ROOT}}/{{CYCLE}}/design-artifacts/domain-models/[unit_name]_domain_model.md`
2. **論理設計**: 同様に**一問一答形式**で対話
   - 成果物: `{{CYCLES_ROOT}}/{{CYCLE}}/design-artifacts/logical-designs/[unit_name]_logical_design.md`
3. **設計レビュー**: 設計内容をユーザーに提示し、承認を得る（**承認なしで実装フェーズに進まない**）

### Phase 2: 実装【設計を参照してコード生成】
4. **コード生成**: 設計ファイルを読み込み、実装コードを生成
5. **テスト生成**: BDD/TDDに従ってテストコードを作成
6. **統合とレビュー**: ビルド、テスト実行、レビュー
   - 成果物: `{{CYCLES_ROOT}}/{{CYCLE}}/construction/units/[unit_name]_implementation.md`

---

## プラットフォーム固有の注意

### iOS
- コード生成時: 文字列は Localizable.strings に定義、NSLocalizedString を使用
- ビルド前: `xcrun simctl list devices available` でシミュレータ確認

### Android
- コード生成時: 文字列は strings.xml に定義
- ビルド前: `adb devices` でエミュレータ確認

---

## 実行ルール
計画作成 → 人間の承認【重要: 計画ファイルのパス提示、「進めてよろしいですか？」と質問、承認を待つ】→ 実行

---

## 完了基準
- すべて完成、ビルド成功、テストパス
- 実装記録に「完了」明記
- progress.md更新

---

## Unit完了時の必須作業【重要】

1. **progress.md更新**: 完了したUnitの状態を「完了」に変更、完了日を記録
2. **実行可能Unitを再計算**: 依存関係に基づいて次回実行可能なUnit候補を更新
3. **最終更新日時を記録**
4. **履歴記録**: `{{CYCLES_ROOT}}/{{CYCLE}}/history.md` に追記（heredoc使用、日時は `date '+%Y-%m-%d %H:%M:%S %Z'`）
5. **Gitコミット**: 作成・変更したすべてのファイルをコミット

---

## 次のステップ
- 次のUnitが残っている場合: 次のUnit継続
- 全Unit完了の場合: Operations Phase へ移行
\`\`\`
以下のファイルを読み込んで、Operations Phase を開始してください：
{{AIDLC_ROOT}}/prompts/operations.md
\`\`\`

---

## このフェーズに戻る場合【バックトラック】

### Inceptionに戻る必要がある場合（Unit追加・拡張）
1. 現在のprogress.mdを確認
2. `{{AIDLC_ROOT}}/prompts/inception.md` を読み込み
3. Inception Phaseの「このフェーズに戻る場合」セクションの手順に従う

### Operations Phaseからバグ修正で戻ってきた場合
1. progress.mdを読み込み、修正対象Unitを「進行中」に変更
2. Unit修正（設計レビュー→実装→テスト）
3. progress.mdを更新（Unitを「完了」に戻す）
4. 履歴記録とコミット
5. Operations Phaseに戻る: `{{AIDLC_ROOT}}/prompts/operations.md` を読み込み
```

---

## Construction Phase テンプレート

### domain_model_template.md

```markdown
# ドメインモデル: [Unit 名]

## 概要
[このドメインモデルの目的と責務を1-2文で記述]

**重要**: このドメインモデル設計では**コードは書かず**、構造と責務の定義のみを行います。

## エンティティ（Entity）

### [エンティティ名1]
- **ID**: [識別子の型]
- **属性**:
  - [属性名]: [型] - [ビジネス上の意味]
- **振る舞い**:
  - [メソッド名]: [何をするか、ビジネスルール]

## 値オブジェクト（Value Object）

### [値オブジェクト名1]
- **属性**: [属性名]: [型] - [説明]
- **不変性**: [なぜ不変であるべきか]
- **等価性**: [何を基準に等価性を判定するか]

## 集約（Aggregate）

### [集約名1]
- **集約ルート**: [エンティティ名]
- **含まれる要素**: [エンティティ or 値オブジェクト] のリスト
- **境界**: [この集約が保護する不変条件の範囲]
- **不変条件**: [常に満たすべきビジネスルール]

## ドメインサービス

### [サービス名1]
- **責務**: [このサービスが担うビジネスロジック]
- **操作**: [操作名] - [何をするか]

## リポジトリインターフェース

### [リポジトリ名1]
- **対象集約**: [集約名]
- **操作**: find(id), save(aggregate), delete(id), [カスタムクエリ]

## ファクトリ（必要な場合のみ）

### [ファクトリ名1]
- **生成対象**: [エンティティ or 集約]
- **生成ロジック概要**: [複雑な初期化処理の説明]

## ユビキタス言語
- **[ビジネス用語1]**: [定義]

## 不明点と質問（設計中に記録）

[Question] ドメインモデル設計に関する不明点
[Answer] ユーザーからの回答
```

---

### logical_design_template.md

```markdown
# 論理設計: [Unit 名]

## 概要
[この論理設計の目的を1-2文で記述]

**重要**: この論理設計では**コードは書かず**、コンポーネント構成とインターフェース定義のみを行います。

## アーキテクチャパターン
[採用するパターン名と選定理由]

## コンポーネント構成

### レイヤー / モジュール構成
\`\`\`
[Layer/Module 名]
├── [Sub-module 1]
│   ├── [Component A]
│   └── [Component B]
└── [Sub-module 2]
\`\`\`

### コンポーネント詳細

#### [コンポーネント名1]
- **責務**: [このコンポーネントが担う役割]
- **依存**: [依存するコンポーネント名]
- **公開インターフェース**: [提供する機能・メソッドのリスト]

## インターフェース設計

### API エンドポイント（該当する場合）
#### \`[HTTP Method] /path/to/endpoint\`
- **説明**: [エンドポイントの目的]
- **リクエストパラメータ**: [パラメータ名]: [型]
- **レスポンス形式**: [返却する情報の概要]
- **エラー**: [想定されるエラーケース]

## データモデル概要

### データベーススキーマ（該当する場合）
#### テーブル: [テーブル名1]
- **主キー**: [カラム名] ([型])
- **カラム**: [カラム名]: [型] - [制約] - [説明]

## 処理フロー概要

### [ユースケース1] の処理フロー
1. [ステップ1の説明]
2. [ステップ2の説明]

## 非機能要件（NFR）への対応
- **パフォーマンス**: [対応策]
- **セキュリティ**: [対応策]
- **スケーラビリティ**: [対応策]
- **可用性**: [対応策]

## 技術選定
- **言語**: [言語名とバージョン]
- **フレームワーク**: [フレームワーク名]
- **ライブラリ**: [使用するライブラリ名]

## 実装上の注意事項
- [セキュリティ上の注意点]
- [パフォーマンス上の注意点]

## 不明点と質問（設計中に記録）

[Question] 論理設計に関する不明点
[Answer] ユーザーからの回答
```

---

### implementation_record_template.md

```markdown
# 実装記録: [Unit 名]

## 実装日時
[開始日時] 〜 [完了日時]

## 作成ファイル

### ソースコード
- [ファイルパス1] - [説明]

### テスト
- [ファイルパス1] - [説明]

### 設計ドキュメント
- design-artifacts/domain-models/<unit>_domain_model.md
- design-artifacts/logical-designs/<unit>_logical_design.md

## ビルド結果
[成功 / 失敗]

## テスト結果
- 実行テスト数: [N]
- 成功: [N]
- 失敗: [N]

## コードレビュー結果
- [ ] セキュリティ: OK
- [ ] コーディング規約: OK
- [ ] エラーハンドリング: OK
- [ ] テストカバレッジ: OK

## 技術的な決定事項
[実装中に行った技術的な判断や選択]

## 課題・改善点
[残された課題や将来の改善点]

## 状態
**完了**

## 備考
[特記事項があれば]
```
