# 追加ルール

このファイルには、プロジェクト固有の追加ルールや制約を記載します。

各フェーズの開始時に必ず読み込んでください。

---

## 実行前の検証ルール

### Codex MCP レビュー（該当する場合）

MCP (Model Context Protocol) の Codex ツールが利用可能な場合、重要な変更の前にレビューを実施してください：

1. **レビュー対象**:
   - 新規ファイル作成
   - 大規模なリファクタリング
   - アーキテクチャ変更
   - セキュリティに関わる変更

2. **レビュー手順**:
   - 変更内容を Codex に提示
   - セキュリティ、品質、設計の観点でレビュー依頼
   - フィードバックを元に修正
   - 承認後に実装

### 指示の妥当性検証

実行前に以下を確認してください：

1. **目的の明確性**: この変更の目的は明確か？
2. **影響範囲**: 他のコンポーネントへの影響は考慮されているか？
3. **リスク評価**: 潜在的なリスクは特定されているか？
4. **代替案の検討**: より良い方法はないか？

---

## フェーズ固有のルール

### Inception Phase

#### Intent 明確化
- **最小限の情報で開始**: ユーザーに過度な質問をせず、最小限の情報で Intent を記録
- **後から追加**: 不明点は Construction や Operations で明らかになる前提で進める

#### Unit 定義
- **サイズの目安**: 1つの Unit は 1〜2週間で実装できるサイズ
- **依存関係の最小化**: Unit 間の依存を最小限に
- **独立性**: 各 Unit は独立してテスト可能であること

### Construction Phase

#### ドメインモデル設計
- **ユビキタス言語の使用**: ドメインエキスパートと開発者が共通の言語を使用
- **集約の境界**: 1つのトランザクションで更新されるべきものを1つの集約に

#### コード実装
- **セキュリティ第一**: 実装前にセキュリティリスクを評価
- **テスト駆動**: テストを先に書く（可能な場合）
- **小さなコミット**: 意味のある単位で頻繁にコミット

#### テスト
- **カバレッジ目標**: ユニットテストのカバレッジは 80% 以上
- **境界値テスト**: エッジケースを必ずテスト
- **失敗ケース**: 正常系だけでなく異常系もテスト

### Operations Phase

#### デプロイ
- **段階的デプロイ**: まずステージング、問題なければ本番
- **ロールバック準備**: ロールバック手順を必ず準備

#### 監視
- **アラート疲れの防止**: 重要なアラートのみ設定
- **ダッシュボードの可視性**: 誰でも現在の状態を把握できるように

---

## 禁止事項

### 絶対に禁止

1. **機密情報のコミット**:
   - `.env` ファイル
   - `credentials.json` 等の認証情報
   - API キー、パスワード

2. **本番データの使用**:
   - 開発環境で本番データを使用しない
   - テストデータは匿名化・マスキング

3. **承認なしの本番環境への変更**:
   - 本番環境への変更は必ず人間の承認を得る
   - force push は禁止

### 推奨しない

1. **大きすぎる変更**:
   - 1つの PR で複数の機能を変更しない
   - 1つのコミットで大量のファイルを変更しない

2. **テストなしのコード**:
   - 新しいコードには必ずテストを追加
   - 既存コードの変更時もテストを追加・更新

3. **ドキュメントなしの変更**:
   - API 変更時はドキュメントも更新
   - 複雑なロジックにはコメントを追加

---

## カスタムワークフロー

### 緊急バグ修正フロー

本番環境で重大なバグが発見された場合：

1. **インシデント宣言**: バグの影響範囲を確認
2. **ホットフィックスブランチ作成**: `hotfix/issue-description` ブランチを作成
3. **最小限の修正**: バグの原因を特定し、最小限の変更で修正
4. **テスト**: 修正が正しく動作することを確認
5. **緊急デプロイ**: ステージングを経由せず本番へデプロイ（承認後）
6. **事後対応**: 根本原因分析とドキュメント化

### 機能フラグの使用

段階的なリリースが必要な場合：

1. **フラグ定義**: 機能フラグを定義
2. **コード実装**: フラグで機能の有効/無効を切り替え
3. **段階的公開**: 一部ユーザーに公開 → 全ユーザーに公開
4. **フラグ削除**: 機能が安定したらフラグを削除

---

## プロジェクト固有のルール

以下は、このプロジェクト特有のルールです。必要に応じて追加・更新してください。

### コーディング規約

**言語**: 未定（Inception Phase で決定）

決定後、以下を記載：
- 命名規則
- フォーマット
- コメント規約
- ファイル構成

### ブランチ戦略

- **main**: 本番環境
- **develop**: 開発環境（該当する場合）
- **feature/***: 機能開発ブランチ
- **hotfix/***: 緊急修正ブランチ

### コードレビュー

- **レビュアー数**: 最低 1 人（可能な場合）
- **承認**: レビュアーの承認後にマージ
- **セルフレビュー**: マージ前に自分でもコードを確認

### ドキュメント更新タイミング

- **コード変更時**: 関連ドキュメントも同時に更新
- **API 変更時**: API ドキュメントを必ず更新
- **アーキテクチャ変更時**: アーキテクチャ図を更新

---

## ルールの更新

このファイルは、プロジェクトの進行に伴って継続的に更新してください：

1. **新しい制約**: 開発中に発見された制約を追加
2. **改善提案**: より良いプラクティスを発見したら更新
3. **削除**: 不要になったルールは削除

**更新履歴**:
- 2025-11-06: 初版作成

---

## 注意事項

- このファイルは各フェーズの開始時に必ず読み込んでください
- ルールに従わない場合の理由を明確にしてください
- ルールの変更は慎重に行い、チーム全体で合意を得てください
